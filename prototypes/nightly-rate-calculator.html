<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nightly Rate Calculator</title>
  <style>
    * {
      box-sizing: border-box;
    }
    body {
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h1 {
      margin: 0 0 24px;
      color: #111827;
      font-size: 24px;
    }
    #calculator {
      width: 100%;
      min-height: 400px;
    }
    .output {
      margin-top: 24px;
      padding: 16px;
      background: #f9fafb;
      border-radius: 12px;
      font-size: 14px;
    }
    .output h3 {
      margin: 0 0 12px;
      font-size: 16px;
      color: #374151;
    }
    .output pre {
      margin: 0;
      white-space: pre-wrap;
      color: #4b5563;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Nightly Rate Calculator</h1>
    <div id="calculator"></div>
    <div class="output">
      <h3>Output Data:</h3>
      <pre id="output">Adjust the sliders to see pricing data...</pre>
    </div>
  </div>

  <script>
    (function() {
      const container = document.getElementById('calculator');
      const outputEl = document.getElementById('output');

      // Initial values
      const initialP1 = 100;
      const initialDecay = 0.95;

      // Create Shadow DOM
      const shadowRoot = container.attachShadow({ mode: 'open' });

      shadowRoot.innerHTML = `
        <style>
          :host { all: initial; }
          .app{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:#111827; background:#fff; max-width:100%; width:100%; margin:0; padding:12px; box-sizing:border-box; }
          .row{ display:grid; grid-template-columns: 1fr auto auto; gap:16px; align-items:start; margin: 8px 0 16px; }
          .field{ display:flex; flex-direction:column; gap:6px; min-width:0; }
          .label{ font-size:13px; color:#6b7280; }
          .num{ font: inherit; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; width:100%; box-sizing:border-box; }
          .spin{ display:inline-flex; align-items:center; gap:8px; width:100%; min-height:54px; }
          .spin .buttons{ display:flex; flex-direction:column; }
          .spin .btn{ width:32px; height:24px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; cursor:pointer; line-height:1; font-size:12px; }
          .spin .btn + .btn{ margin-top:6px; }
          .spin .num{ height:44px; }

          .track-wrap{ position:relative; height:64px; }
          .track{ position:absolute; left:0; right:0; top:50%; transform:translateY(-50%); height:10px; background:linear-gradient(#9ea0a3,#9ea0a3) center/100% 10px no-repeat, #c9c9c9; border-radius:999px; }
          .ranges{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; }
          .ranges input[type=range]{ pointer-events:auto; -webkit-appearance:none; appearance:none; position:absolute; top:50%; transform:translateY(-50%); background:transparent; height:36px; width:auto; }
          #slw-r1{ left:0; width:49%; }
          #slw-r5{ right:0; width:49%; }
          .ranges input[type=range]::-webkit-slider-runnable-track{ height:10px; background:transparent; }
          .ranges input[type=range]::-moz-range-track{ height:10px; background:transparent; }
          .ranges input[type=range]::-webkit-slider-thumb{ -webkit-appearance:none; appearance:none; width:34px; height:34px; border-radius:10px; background:#5b3bb3; border:0; box-shadow:0 6px 16px rgba(0,0,0,.12); cursor:pointer; margin-top:-12px; }
          .ranges input[type=range]::-moz-range-thumb{ width:34px; height:34px; border-radius:10px; background:#5b3bb3; border:0; box-shadow:0 6px 16px rgba(0,0,0,.12); cursor:pointer; }
          .tag{ position:absolute; top:0; transform:translateX(-50%); color:#111827; font-size:12px; font-weight:700; white-space:nowrap; }
          .value{ position:absolute; bottom:-18px; transform:translateX(-50%); font-size:14px; font-weight:600; }

          .grid{ margin-top:20px; border:1px solid #f1f5f9; border-radius:14px; overflow-x:auto; -webkit-overflow-scrolling:touch; }
          table{ width:100%; min-width:420px; border-collapse:collapse; font-variant-numeric: tabular-nums; }
          th, td{ padding:12px 14px; text-align:right; border-top:1px solid #f1f5f9; }
          th:first-child, td:first-child{ text-align:left; }
          thead th{ background:#fafafa; color:#4b5563; font-weight:600; }

          @media (max-width: 640px){
            .row{ grid-template-columns: 1fr; gap:12px; }
            .spin{ gap:10px; }
            .spin .btn{ width:40px; height:32px; font-size:14px; }
            .track-wrap{ height:80px; }
            .ranges input[type=range]{ height:44px; }
            .ranges input[type=range]::-webkit-slider-thumb{ width:40px; height:40px; border-radius:12px; margin-top:-15px; }
            .ranges input[type=range]::-moz-range-thumb{ width:40px; height:40px; border-radius:12px; }
            .value{ bottom:-30px; font-size:15px; }
          }
          #slw-decay::-webkit-outer-spin-button,
          #slw-decay::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
          #slw-decay{ -moz-appearance:textfield; appearance:textfield; }
          #slw-p1::-webkit-outer-spin-button,
          #slw-p1::-webkit-inner-spin-button{ -webkit-appearance:none; margin:0; }
          #slw-p1{ -moz-appearance:textfield; appearance:textfield; }
        </style>

        <div class="app">
          <div class="row">
            <div class="field">
              <div class="label">1-night price</div>
              <div class="spin">
                <input id="slw-p1" class="num" type="number" min="0" step="1" inputmode="numeric" value="100" />
                <div class="buttons">
                  <button class="btn" id="slw-p1-up" aria-label="Increase 1-night">▲</button>
                  <button class="btn" id="slw-p1-down" aria-label="Decrease 1-night">▼</button>
                </div>
              </div>
            </div>
            <div class="field">
              <div class="label">Discount per additional night (0.700–1.000)</div>
              <div class="spin">
                <input id="slw-decay" class="num" type="number" min="0.7" max="1" step="0.001" inputmode="decimal" value="0.950" />
                <div class="buttons">
                  <button class="btn" id="slw-decay-up" aria-label="Increase discount">▲</button>
                  <button class="btn" id="slw-decay-down" aria-label="Decrease discount">▼</button>
                </div>
              </div>
            </div>
            <div class="field">
              <div class="label">5-night price</div>
              <div class="spin">
                <input id="slw-n5" class="num" type="text" inputmode="numeric" value="" readonly />
              </div>
            </div>
          </div>

          <div class="track-wrap">
            <div class="track"></div>
            <div class="ranges">
              <input id="slw-r1" type="range" min="0" max="600" step="1" value="100" aria-label="1-night price" />
              <input id="slw-r5" type="range" min="0" max="600" step="1" value="0" aria-label="5-night price" />

              <div id="slw-tag1" class="tag">1 night price</div>
              <div id="slw-val1" class="value">$100</div>
              <div id="slw-tag5" class="tag">5 night price</div>
              <div id="slw-val5" class="value">$0</div>
            </div>
          </div>

          <div class="grid">
            <table>
              <thead>
                <tr><th>Night</th><th>Price That Night</th><th>Cumulative Total</th></tr>
              </thead>
              <tbody id="slw-rows"></tbody>
            </table>
          </div>
        </div>
      `;

      // Calculator logic
      const N = 7;
      const DECAY_MIN = 0.7;
      const DECAY_MAX = 1.0;

      const $ = (sel) => shadowRoot.getElementById(sel);
      const fmt0 = (n) => n.toLocaleString(undefined, { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
      const roundUp = (n) => Math.ceil(n);

      const p1El = $('slw-p1');
      const decayEl = $('slw-decay');
      const n5El = $('slw-n5');
      const r1 = $('slw-r1');
      const r5 = $('slw-r5');
      const rows = $('slw-rows');
      const tag1 = $('slw-tag1');
      const tag5 = $('slw-tag5');
      const val1 = $('slw-val1');
      const val5 = $('slw-val5');
      const p1Up = $('slw-p1-up');
      const p1Down = $('slw-p1-down');
      const dUp = $('slw-decay-up');
      const dDown = $('slw-decay-down');

      let nightly = Array(N).fill(0);
      let currentDecay = initialDecay;

      const clamp = (x, lo, hi) => Math.max(lo, Math.min(hi, x));
      const sum = (arr) => arr.reduce((a, b) => a + b, 0);

      function calcN5(p1, d) {
        return p1 * Math.pow(d, 4);
      }

      function solveDecayFromN5(p1, n5) {
        if (p1 <= 0) return DECAY_MIN;
        const ratio = n5 / p1;
        if (ratio <= 0) return DECAY_MIN;
        const d = Math.pow(ratio, 1/4);
        return clamp(d, DECAY_MIN, DECAY_MAX);
      }

      function updateBounds() {
        const p1 = +r1.value || 0;
        const minN5 = calcN5(p1, DECAY_MIN);
        const maxN5 = calcN5(p1, DECAY_MAX);
        r5.min = String(Math.round(minN5));
        r5.max = String(Math.round(Math.max(maxN5, minN5)));
      }

      function rebuildFrom(p1, d) {
        nightly[0] = roundUp(+p1);
        for (let k = 1; k < N; k++) nightly[k] = roundUp(nightly[k - 1] * d);
        syncUI();
      }

      function placeTags() {
        const wrap = shadowRoot.querySelector('.ranges');
        if (!wrap) return;
        const rectWrap = wrap.getBoundingClientRect();
        if (rectWrap.width === 0) return;

        const pad = 12;
        const minGap = 84;

        const posOn = (input) => {
          const r = input.getBoundingClientRect();
          const min = +input.min, max = +input.max, val = +input.value;
          const t = (val - min) / (max - min || 1);
          return (r.left - rectWrap.left) + r.width * t;
        };

        let x1 = posOn(r1);
        let x5 = posOn(r5);

        const clampX = (x) => Math.max(pad, Math.min(rectWrap.width - pad, x));
        if (Math.abs(x1 - x5) < minGap) {
          const mid = (x1 + x5) / 2;
          x1 = mid - minGap / 2;
          x5 = mid + minGap / 2;
        }
        x1 = clampX(x1);
        x5 = clampX(x5);

        tag1.style.left = x1 + 'px'; val1.style.left = x1 + 'px';
        tag5.style.left = x5 + 'px'; val5.style.left = x5 + 'px';

        val1.textContent = fmt0(+r1.value);
        val5.textContent = fmt0(+r5.value);
      }

      function renderTable() {
        let cum = 0;
        const body = [];
        for (let i = 0; i < N; i++) {
          cum += nightly[i];
          body.push(`<tr><td>${i + 1}</td><td>${fmt0(nightly[i])}</td><td>${fmt0(cum)}</td></tr>`);
        }
        rows.innerHTML = body.join('');
      }

      function broadcast() {
        const roundedNightly = nightly.map(v => Math.round(v));
        const payload = {
          p1: roundedNightly[0],
          n1: roundedNightly[0],
          n2: roundedNightly[1],
          n3: roundedNightly[2],
          n4: roundedNightly[3],
          n5: roundedNightly[4],
          n6: roundedNightly[5],
          n7: roundedNightly[6],
          decay: +currentDecay.toFixed(3),
          total: sum(roundedNightly)
        };

        // Update the output display
        outputEl.textContent = JSON.stringify(payload, null, 2);
      }

      function syncUI() {
        const p1 = nightly[0];
        const n5 = nightly[4];
        p1El.value = String(Math.round(p1));
        decayEl.value = currentDecay.toFixed(3);
        n5El.value = String(Math.round(n5));
        r1.value = String(Math.round(p1));
        updateBounds();
        const n5Clamped = clamp(n5, +r5.min, +r5.max);
        r5.value = String(Math.round(n5Clamped));
        placeTags();
        renderTable();
        broadcast();
      }

      function commitP1() {
        const raw = (p1El.value || '').trim();
        if (!raw) return;
        const p1 = Math.max(0, parseFloat(raw));
        if (!isFinite(p1)) return;
        rebuildFrom(p1, currentDecay);
      }

      function commitDecay() {
        const raw = (decayEl.value || '').trim();
        if (!raw) return;
        let d = parseFloat(raw);
        if (!isFinite(d)) return;
        d = clamp(d, DECAY_MIN, DECAY_MAX);
        currentDecay = d;
        const p1 = Math.max(0, parseFloat(p1El.value || r1.value || '0'));
        rebuildFrom(p1, d);
      }

      function onDragP1(val) {
        const p1 = Math.max(0, val);
        updateBounds();
        const n5Fixed = clamp(+r5.value || 0, +r5.min, +r5.max);
        const d = solveDecayFromN5(p1, n5Fixed);
        currentDecay = d;
        rebuildFrom(p1, d);
        r5.value = String(Math.round(n5Fixed));
        placeTags();
      }

      function onDragN5(n5Val) {
        const p1 = +r1.value || 0;
        updateBounds();
        const n5 = clamp(n5Val, +r5.min, +r5.max);
        const d = solveDecayFromN5(p1, n5);
        currentDecay = d;
        rebuildFrom(p1, d);
        r1.value = String(Math.round(p1));
        placeTags();
      }

      // Event listeners
      p1El.addEventListener('keydown', (e) => { if (e.key === 'Enter') commitP1(); });
      p1El.addEventListener('blur', commitP1);
      decayEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') commitDecay(); });
      decayEl.addEventListener('blur', commitDecay);
      r1.addEventListener('input', () => onDragP1(parseFloat(r1.value)));
      r5.addEventListener('input', () => onDragN5(parseFloat(r5.value)));

      p1Up.addEventListener('click', () => { p1El.value = String(Math.round(+p1El.value || 0) + 1); commitP1(); });
      p1Down.addEventListener('click', () => { p1El.value = String(Math.max(0, Math.round(+p1El.value || 0) - 1)); commitP1(); });
      dUp.addEventListener('click', () => {
        currentDecay = clamp(currentDecay + 0.001, DECAY_MIN, DECAY_MAX);
        decayEl.value = currentDecay.toFixed(3);
        const p1 = Math.max(0, parseFloat(p1El.value || r1.value || '0'));
        rebuildFrom(p1, currentDecay);
      });
      dDown.addEventListener('click', () => {
        currentDecay = clamp(currentDecay - 0.001, DECAY_MIN, DECAY_MAX);
        decayEl.value = currentDecay.toFixed(3);
        const p1 = Math.max(0, parseFloat(p1El.value || r1.value || '0'));
        rebuildFrom(p1, currentDecay);
      });

      // Resize observer
      const ro = new ResizeObserver(() => placeTags());
      ro.observe(container);

      // Initialize
      currentDecay = initialDecay;
      nightly = Array(N).fill(0);
      nightly[0] = initialP1;
      for (let i = 1; i < N; i++) nightly[i] = roundUp(nightly[i - 1] * initialDecay);
      r1.value = String(Math.round(initialP1));
      r5.value = String(Math.round(calcN5(initialP1, initialDecay)));
      syncUI();
    })();
  </script>
</body>
</html>
