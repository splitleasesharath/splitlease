/ralph-loop:ralph-loop

You have an implementation plan to execute. The plan is at: ../adws\adw_plans\20260122035347_implementation_plan.md

## Plan Content

# Implementation Plan - ../app

**Date:** 2026-01-22
**Audit Type:** general
**Generated By:** Claude Opus (ADW Pipeline)

---

## Summary

| Metric | Value |
|--------|-------|
| Files to modify | 3 |
| Risk level | LOW |
| Estimated changes | Remove deprecated re-export shims, consolidate constants |

---

## Analysis

### Codebase Health: EXCELLENT

The `app/src` codebase demonstrates strong architectural discipline:

1. **Four-Layer Logic Architecture**: Exceptionally well-organized with clear separation:
   - Calculators (pure math): `calculateGuestFacingPrice.js`, `calculateAvailableSlots.js`
   - Rules (boolean predicates): `canAcceptProposal.js`, `isScheduleContiguous.js`
   - Processors (data transform): `normalizeProposalData.js`, `processUserData.js`
   - Workflows (orchestration): `acceptProposalWorkflow.js`, `reminderWorkflow.js`

2. **Islands Architecture**: 29 independent React roots, no shared state between pages

3. **Hollow Component Pattern**: Page components delegate logic to `use*PageLogic` hooks

4. **Strong Naming Conventions**: Consistent use of `calculate*`, `is*`, `can*`, `adapt*`

### Issues Identified

1. **Deprecated re-export shims** (LOW RISK):
   - `lib/constants/proposalStatuses.js` → re-exports from `logic/constants/proposalStatuses.js`
   - `lib/priceCalculations.js` → marked deprecated, points to `logic/calculators/pricing/`

2. **Multiple pricing implementations** (ALREADY CONSOLIDATED):
   - `logic/calculators/pricing/calculateGuestFacingPrice.js` - canonical, pure function
   - `lib/priceCalculations.js` - deprecated with proper deprecation notice
   - `lib/scheduleSelector/priceCalculations.js` - detailed implementation for schedule selector

3. **Constants duplication** (ALREADY RESOLVED):
   - `lib/constants/proposalStatuses.js` - properly re-exports from canonical location
   - `logic/constants/proposalStatuses.js` - single source of truth

### Conclusion: No Immediate Refactoring Required

The codebase has already implemented proper patterns:
- Deprecated files have proper `@deprecated` notices pointing to canonical locations
- Re-export shims exist for backward compatibility with correct imports
- The four-layer logic architecture is well-maintained
- Pricing has been consolidated into `logic/calculators/pricing/`

---

## Implementation Order

No files require modification at this time.

The following deprecated files exist but are properly documented:
1. `lib/constants/proposalStatuses.js` - Re-export shim (working correctly)
2. `lib/priceCalculations.js` - Deprecated with proper notice

These should be removed only when:
- All import statements are updated to use canonical locations
- A dedicated cleanup task is scheduled

---

## File Changes

### No Changes Required

The audit found the codebase to be in excellent health:

1. **Pricing Logic**: Already consolidated in `logic/calculators/pricing/`
   - `calculateGuestFacingPrice.js` - pure function with strict validation
   - `calculateFourWeekRent.js`
   - `calculatePricingBreakdown.js`
   - `getNightlyRateByFrequency.js`

2. **Constants**: Single source of truth established
   - `logic/constants/proposalStatuses.js` - canonical location
   - `logic/constants/pricingConstants.js`
   - `logic/constants/searchConstants.js`

3. **Validators**: Well-structured in `logic/validators/`
   - `pricingValidators.js` - reusable validation functions

4. **Availability Calculator**: Functional style maintained
   - `calculateAvailableSlots.js` uses `map()` not `push()` in main flow
   - `getTimeSlots()` uses loop for slot generation (acceptable)

---

## Verification Steps

Not applicable - no changes required.

---

## Rollback Plan

Not applicable - no changes required.

---

## Recommendations for Future Cleanup

When a dedicated cleanup sprint is scheduled:

### Phase 1: Remove Import Shims
1. Search for all imports from `lib/constants/proposalStatuses.js`
2. Update to import from `logic/constants/proposalStatuses.js`
3. Delete the re-export shim

### Phase 2: Consolidate Schedule Selector Pricing
1. Review `lib/scheduleSelector/priceCalculations.js` (333 lines)
2. Extract pure calculation functions to `logic/calculators/pricing/`
3. Keep UI-specific logic in schedule selector

### Phase 3: Validate Deprecated Imports
Files currently importing from deprecated `lib/priceCalculations.js`:
- `islands/shared/ListingCard/PropertyCard.jsx`
- `islands/pages/PreviewSplitLeasePage.jsx`
- `islands/pages/ViewSplitLeasePage.jsx`
- `islands/pages/SearchPage/components/PropertyCard.jsx`
- `islands/shared/useScheduleSelector.js`
- `islands/shared/useScheduleSelectorLogicCore.js`
- `islands/shared/CreateProposalFlowV2.jsx`
- `islands/shared/GoogleMap.jsx`

---

## Dependency Analysis Summary

### CRITICAL IMPACT (30+ dependents) - DO NOT MODIFY:
- `src/lib/supabase.js` (112 dependents)
- `src/lib/auth.js` (100 dependents)
- `src/lib/secureStorage.js` (89 dependents)
- `src/islands/shared/Toast.jsx` (51 dependents)
- `src/lib/constants.js` (51 dependents)

### LEAF FILES (0 dependents) - Safe for future refactoring:
- `logic/calculators/simulation/calculateSimulationDates.js`
- `logic/calculators/reminders/calculateNextSendTime.js`
- `logic/rules/admin/virtualMeetingAdminRules.js`
- `logic/processors/display/formatHostName.js`
- `logic/processors/meetings/filterMeetings.js`

---

## File References

| Category | File Path |
|----------|-----------|
| Pricing Calculator | `app/src/logic/calculators/pricing/calculateGuestFacingPrice.js` |
| Pricing Constants | `app/src/logic/constants/pricingConstants.js` |
| Proposal Statuses | `app/src/logic/constants/proposalStatuses.js` |
| Availability Calculator | `app/src/logic/calculators/availability/calculateAvailableSlots.js` |
| Proposal Normalizer | `app/src/logic/processors/proposals/normalizeProposalData.js` |
| Deprecated Pricing | `app/src/lib/priceCalculations.js` |
| Schedule Selector Pricing | `app/src/lib/scheduleSelector/priceCalculations.js` |
| Validators | `app/src/logic/validators/pricingValidators.js` |
| Main Constants | `app/src/lib/constants.js` |


## Your Task

Implement ALL changes described in the plan above. For each file listed:

1. **Read** the current file content
2. **Locate** the code section to modify (match the "Current Code" block)
3. **Replace** with the "Refactored Code" block EXACTLY as shown
4. **Verify** the file was modified correctly by reading it back

## Rules

- Follow the **Implementation Order** specified in the plan
- Do NOT skip any files
- Do NOT commit changes (we validate first)
- Do NOT run build commands
- If a file doesn't exist or code doesn't match, report the error and continue

## On Completion

When all files are implemented, output:
```
IMPLEMENTATION COMPLETE
Files modified: [count]
```

Begin implementation now.
