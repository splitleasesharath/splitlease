<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Search | Split Lease</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/ai-signup.css">

    <!-- Tailwind CSS for Informational Text Component -->
    <script src="https://cdn.tailwindcss.com"></script>


    <!-- React & ReactDOM for Informational Text Component & Schedule Selector -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>


    <!-- Styled Components for Schedule Selector styling -->
    <script src="https://unpkg.com/styled-components@6.1.1/dist/styled-components.min.js"></script>

    <!-- Framer Motion for Schedule Selector animations -->
    <script src="https://unpkg.com/framer-motion@10.16.0/dist/framer-motion.js"></script>

    <!-- Lottie for AI Signup animations -->
    <script src="https://unpkg.com/lottie-web@5.12.2/build/player/lottie.min.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <img src="assets/images/logo.png" alt="Split Lease" class="logo-img">
                <span class="logo-text">Split Lease</span>
            </div>
            <nav class="nav-menu">
                <div class="nav-links">
                    <a href="#" class="nav-link">Host with Us</a>
                    <a href="#" class="nav-link">Stay with Us</a>
                </div>
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
                <div class="nav-items">
                    <button class="explore-btn">Explore Rentals</button>
                    <button class="sign-in-btn">Sign In</button>
                </div>
            </nav>
        </div>
    </header>

    <!-- Mobile Filter Button -->
    <div class="mobile-filter-bar">
        <button class="filter-toggle-btn" id="filterToggleBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path d="M4 6h16M4 12h16M4 18h16" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <span>Filters</span>
        </button>
        <button class="map-toggle-btn" id="mapToggleBtn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <rect x="3" y="3" width="18" height="18" rx="2" stroke-width="2"/>
                <path d="M9 3v18M15 3v18M3 9h18M3 15h18" stroke-width="2"/>
            </svg>
            <span>Map</span>
        </button>
    </div>

    <!-- Filter Panel -->
    <div class="filter-panel" id="filterPanel">
        <div class="filter-container">
            <!-- Top Row: Schedule Selector (React Island) -->
            <div class="top-filter-row">
                <!-- React Schedule Selector Mount Point -->
                <div id="schedule-selector-root"></div>
            </div>

            <!-- Horizontal Filter Row -->
            <div class="horizontal-filters">
                <!-- Borough Select - Populated dynamically from database -->
                <div class="filter-group compact">
                    <label for="boroughSelect">Select Borough</label>
                    <select id="boroughSelect" class="filter-select">
                        <option value="">Loading boroughs...</option>
                    </select>
                </div>

                <!-- Week Pattern -->
                <div class="filter-group compact">
                    <label for="weekPattern">Select Week Pattern</label>
                    <select id="weekPattern" class="filter-select">
                        <option value="every-week" selected>Every week</option>
                        <option value="one-on-off">One week on, one week off</option>
                        <option value="two-on-off">Two weeks on, two weeks off</option>
                        <option value="one-three-off">One week on, three weeks off</option>
                    </select>
                </div>

                <!-- Price Tier -->
                <div class="filter-group compact">
                    <label for="priceTier">Select Price Tier</label>
                    <select id="priceTier" class="filter-select">
                        <option value="under-200">&lt; $200/night</option>
                        <option value="200-350" selected>$200-$350/night</option>
                        <option value="350-500">$350-$500/night</option>
                        <option value="500-plus">$500+/night</option>
                        <option value="all">All Prices</option>
                    </select>
                </div>

                <!-- Sort By -->
                <div class="filter-group compact">
                    <label for="sortBy">Sort By</label>
                    <select id="sortBy" class="filter-select">
                        <option value="recommended" selected>Our Recommendations</option>
                        <option value="price-low">Price-Lowest to Highest</option>
                        <option value="most-viewed">Most Viewed</option>
                        <option value="recent">Recently Added</option>
                    </select>
                </div>

                <!-- Neighborhood Multi-Select - Populated dynamically from database -->
                <div class="filter-group compact neighborhoods-group">
                    <label for="neighborhoodSelect">Refine Neighborhood(s)</label>
                    <input type="text" id="neighborhoodSearch" placeholder="Search neighborhoods..." class="neighborhood-search">
                    <!-- Selected neighborhood chips display -->
                    <div class="selected-neighborhoods-chips" id="selectedNeighborhoodsChips"></div>
                    <div class="neighborhood-list">
                        <div style="padding: 10px; color: #666;">Loading neighborhoods...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Listings Section -->
        <section class="listings-section">
            <div class="listings-header">
                <div class="header-top">
                    <h1 class="search-title">Available Split Leases</h1>
                </div>
                <div class="header-info">
                    <span class="results-count"><span id="listingCount">10 listings found</span></span>
                    <span class="location-tag">in <strong id="location-text">Manhattan</strong></span>
                </div>
            </div>
            <div class="listings-container" id="listingsContainer">
                <!-- Loading skeleton -->
                <div class="loading-skeleton" id="loadingSkeleton">
                    <div class="skeleton-card">
                        <div class="skeleton-image"></div>
                        <div class="skeleton-content">
                            <div class="skeleton-line" style="width: 60%;"></div>
                            <div class="skeleton-line" style="width: 80%;"></div>
                            <div class="skeleton-line" style="width: 40%;"></div>
                        </div>
                    </div>
                    <div class="skeleton-card">
                        <div class="skeleton-image"></div>
                        <div class="skeleton-content">
                            <div class="skeleton-line" style="width: 60%;"></div>
                            <div class="skeleton-line" style="width: 80%;"></div>
                            <div class="skeleton-line" style="width: 40%;"></div>
                        </div>
                    </div>
                </div>
                <!-- Listing cards will be dynamically inserted here -->
            </div>
        </section>

        <!-- Map Section -->
        <section class="map-section" id="mapSection">
            <div class="map-wrapper">
                <div id="map" class="map-container"></div>

                <!-- Floating Deep Research Button -->
                <button class="deep-research-floating-btn" id="deepResearchBtn" onclick="openAiSignupModal()">
                    <div class="atom-animation" id="atomAnimation"></div>
                    <span>Generate Market Report</span>
                </button>

                <div class="map-legend">
                    <div class="legend-item">
                        <span class="legend-marker" style="background: #00C851;"></span>
                        <span>All Active Listings</span>
                    </div>
                    <div class="legend-item">
                        <span class="legend-marker" style="background: #31135D;"></span>
                        <span>Search Results</span>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Chat Widget - Opens AI Signup Modal -->
    <button class="chat-widget" id="chatWidget" onclick="openAiSignupModal()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
        </svg>
        <span class="chat-label">Get Market Research</span>
    </button>

    <!-- Informational Text Component Container -->
    <div id="info-text-root"></div>

    <!-- Contact Host Messaging Component -->
    <link rel="stylesheet" href="components/ContactHost/contact-host-messaging.css">

    <!-- Scripts -->
    <!-- Configuration -->
    <script>
        // Try to load local config first, fail silently if not found
        (function() {
            var script = document.createElement('script');
            script.src = 'js/config.local.js';
            script.onerror = function() {
                console.log('Local config not found, using production config');
            };
            document.head.appendChild(script);
        })();
    </script>
    <script src="js/config.js"></script>
    <!-- Logger Integration -->
    <script src="js/logger.js"></script>
    <!-- Supabase JavaScript Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Verify Supabase loaded correctly
        if (window.supabase && window.supabase.createClient) {
            console.log('‚úÖ Supabase client library loaded successfully');
            console.log('   window.supabase.createClient:', typeof window.supabase.createClient);
        } else {
            console.error('‚ùå Supabase client library failed to load');
            console.error('   window.supabase:', window.supabase);
        }
    </script>
    <!-- Supabase API Integration (Primary Data Source) -->
    <script src="js/supabase-api.js"></script>
    <!-- Filter Configuration -->
    <script src="js/filter-config.js?v=4"></script>
    <!-- URL Parameter Manager -->
    <script src="js/url-params.js"></script>
    <!-- Main Application -->
    <script src="js/app.js?v=5"></script>

    <!-- Ensure Initialization Runs -->
    <script>
        // Backup initialization to ensure Supabase and listings load
        // This runs after all scripts are loaded
        (async function ensureInitialization() {
            console.log('üîß Backup initialization check running...');

            // Wait for DOM to be ready
            if (document.readyState === 'loading') {
                await new Promise(resolve => document.addEventListener('DOMContentLoaded', resolve));
            }

            // Give the main init() function a chance to run first
            await new Promise(resolve => setTimeout(resolve, 100));

            // Check if SupabaseAPI was already initialized by app.js
            if (window.SupabaseAPI && window.SupabaseAPI.isInitialized) {
                console.log('‚úÖ SupabaseAPI already initialized by main app');
                return;
            }

            // If not initialized, do it now as backup
            if (window.SupabaseAPI && !window.SupabaseAPI.isInitialized) {
                console.log('‚ö†Ô∏è Main init() did not initialize SupabaseAPI, running backup initialization...');

                try {
                    const connected = await window.SupabaseAPI.init();
                    if (connected) {
                        console.log('‚úÖ Backup: Supabase connected, initializing FilterConfig...');
                        
                        // Initialize FilterConfig with database data (REQUIRED before fetching listings)
                        if (window.FilterConfig) {
                            await window.FilterConfig.initializeFilterConfig();
                        } else {
                            console.error('‚ùå FilterConfig not loaded - include filter-config.js before app.js');
                        }

                        console.log('‚úÖ Backup: FilterConfig initialized, fetching listings...');
                        const listings = await window.SupabaseAPI.fetchListings();

                        if (listings && listings.length > 0) {
                            console.log(`‚úÖ Backup: Fetched ${listings.length} listings, rendering...`);
                            window.currentListings = listings;

                            // Call render function if it exists
                            if (typeof renderListings === 'function') {
                                renderListings(listings);
                            } else if (typeof initializeLazyLoading === 'function') {
                                initializeLazyLoading(listings);
                            }

                            // Update listing count
                            if (typeof updateListingCount === 'function') {
                                updateListingCount(listings.length);
                            }

                            // Populate boroughs and neighborhoods from database
                            if (typeof window.populateBoroughs === 'function') {
                                await window.populateBoroughs();
                            }
                            // Get the currently selected borough and populate its neighborhoods
                            if (typeof window.populateNeighborhoods === 'function') {
                                const boroughSelect = document.getElementById('boroughSelect');
                                const selectedBorough = boroughSelect?.value;
                                const boroughId = window.FilterConfig ? window.FilterConfig.getBoroughId(selectedBorough) : null;
                                await window.populateNeighborhoods(boroughId);
                            }

                            // Setup event listeners
                            if (typeof setupEventListeners === 'function') {
                                setupEventListeners();
                            }

                            // Hide loading skeleton
                            const skeleton = document.getElementById('loadingSkeleton');
                            if (skeleton) skeleton.classList.remove('active');

                            console.log('‚úÖ Backup initialization complete!');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Backup initialization failed:', error);
                }
            }
        })();
    </script>
    <!-- Informational Text Component -->
    <script src="js/informational-text-react.js"></script>
    <script src="js/informational-text.js"></script>
    <script>
      // Initialize Informational Text Component with dynamic trigger registration
      // Store config globally (credentials from window.ENV via config.js)
      window.INFO_TEXT_CONFIG = {
        tableName: 'informationaltexts',
        infoId: '1721990409194x255037403710619650'
      };

      // Initialize once on page load
      let infoTextInitialized = false;

      // Function to register triggers for all listing cards
      window.registerPriceInfoTriggers = function() {
        const listingCards = document.querySelectorAll('.listing-card');
        const triggers = [];

        listingCards.forEach(card => {
          const listingId = card.dataset.id;
          triggers.push({
            id: `price-info-trigger-${listingId}`,
            infoId: window.INFO_TEXT_CONFIG.infoId
          });
        });

        // Initialize component only once
        if (!infoTextInitialized && triggers.length > 0) {
          initInformationalText({
            supabaseUrl: window.ENV?.SUPABASE_URL,
            supabaseKey: window.ENV?.SUPABASE_ANON_KEY,
            tableName: window.INFO_TEXT_CONFIG.tableName,
            triggers: triggers
          });
          infoTextInitialized = true;
          console.log(`‚úÖ Informational Text component initialized with ${triggers.length} triggers`);
        } else if (triggers.length > 0) {
          // Update trigger mappings and reattach listeners
          if (window.TRIGGER_MAPPINGS) {
            window.TRIGGER_MAPPINGS = triggers;
          }
          if (window.attachInfoTriggers) {
            window.attachInfoTriggers();
            console.log(`‚úÖ Attached event listeners to ${triggers.length} price info triggers`);
          }
        }
      };
    </script>
    <!-- Google Maps with Places Library -->
    <script>
        // More reliable Google Maps loading
        function loadGoogleMaps() {
            console.log('üó∫Ô∏è Starting Google Maps loading process...');
            console.log('üîç Checking ENV configuration:');
            console.log('  window.ENV exists:', !!window.ENV);
            if (window.ENV) {
                console.log('  GOOGLE_MAPS_API_KEY:', window.ENV.GOOGLE_MAPS_API_KEY ? window.ENV.GOOGLE_MAPS_API_KEY.substring(0, 20) + '...' : 'NOT SET');
                console.log('  BUBBLE_API_KEY:', window.ENV.BUBBLE_API_KEY ? window.ENV.BUBBLE_API_KEY.substring(0, 20) + '...' : 'NOT SET');
            }

            const apiKey = window.ENV?.GOOGLE_MAPS_API_KEY || 'YOUR_API_KEY';
            console.log('üì¶ Loading Google Maps with API key:', apiKey.substring(0, 20) + '...');

            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&libraries=places&callback=initMap&loading=async`;
            script.async = true;
            script.defer = true;

            script.onload = function() {
                console.log('‚úÖ Google Maps script loaded successfully');
            };

            script.onerror = function() {
                console.error('‚ùå Failed to load Google Maps script');
                if (typeof showMapPlaceholder === 'function') {
                    const mapElement = document.getElementById('map');
                    if (mapElement) showMapPlaceholder(mapElement);
                }
            };

            document.head.appendChild(script);
        }

        // Global callback function for Google Maps
        window.initMap = function() {
            console.log('üéØ initMap callback triggered');
            if (typeof window.actualInitMap === 'function') {
                window.actualInitMap();
            } else {
                console.error('‚ùå actualInitMap function not found');
            }
        };

        // Load maps when page is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadGoogleMaps);
        } else {
            loadGoogleMaps();
        }
    </script>

    <!-- AI Signup Modal Integration -->
    <script src="js/ai-signup.js"></script>

    <!-- Deep Research Button Lottie Animation -->
    <script>
        // Initialize atom animation on Deep Research button
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üé¨ Initializing Deep Research button animation...');
            const atomContainer = document.getElementById('atomAnimation');
            console.log('üì¶ Atom container:', atomContainer);
            console.log('üé® Lottie library loaded:', typeof lottie !== 'undefined');

            if (atomContainer && typeof lottie !== 'undefined') {
                try {
                    const animation = lottie.loadAnimation({
                        container: atomContainer,
                        renderer: 'svg',
                        loop: true,
                        autoplay: true,
                        path: 'https://50bf0464e4735aabad1cc8848a0e8b8a.cdn.bubble.io/f1746105302928x174581704119754800/atom%20white.json',
                        speed: 0.25
                    });
                    console.log('‚úÖ Atom animation loaded successfully:', animation);

                    animation.addEventListener('DOMLoaded', function() {
                        console.log('‚úÖ Atom animation DOM loaded');
                    });

                    animation.addEventListener('data_ready', function() {
                        console.log('‚úÖ Atom animation data ready');
                    });

                    animation.addEventListener('data_failed', function() {
                        console.error('‚ùå Atom animation data failed to load');
                    });
                } catch(error) {
                    console.error('‚ùå Error loading atom animation:', error);
                }
            } else {
                if (!atomContainer) console.error('‚ùå Atom container not found');
                if (typeof lottie === 'undefined') console.error('‚ùå Lottie library not loaded');
            }
        });
    </script>

    <!-- Contact Host Messaging Component -->
    <script src="components/ContactHost/contact-host-messaging.js"></script>

    <!-- Schedule Selector Component (React Island) -->
    <script src="dist/schedule-selector.js"></script>
    <script src="js/schedule-selector-integration.js"></script>
</body>
</html>