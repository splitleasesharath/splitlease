# Deploy bubble-proxy Edge Function\n\n**Status**: Ready for Deployment\n**Last Updated**: 2025-12-06\n**Edge Function**: `bubble-proxy`\n\n## Overview\n\nThe `bubble-proxy` Edge Function is a comprehensive API router that handles client requests for Bubble API operations and Supabase-native operations. It serves as the primary gateway for:\n\n- Listing management (create, fetch, submit, photos)\n- Messaging (contact host)\n- User favorites management\n- Proposal creation (Supabase-native)\n- AI signup and referral tracking\n\n## Function Structure\n\n```\nsupabase/functions/bubble-proxy/\nâ”œâ”€â”€ index.ts                          # Main router (229 lines)\nâ”œâ”€â”€ deno.json                         # Empty import map\nâ””â”€â”€ handlers/\n    â”œâ”€â”€ listing.ts                    # Create listing (96 lines)\n    â”œâ”€â”€ getListing.ts                 # Fetch listing data (49 lines)\n    â”œâ”€â”€ photos.ts                     # Upload photos (147 lines)\n    â”œâ”€â”€ messaging.ts                  # Send message to host (74 lines)\n    â”œâ”€â”€ favorites.ts                  # Toggle favorites (118 lines)\n    â”œâ”€â”€ getFavorites.ts               # Get user favorites (254 lines)\n    â”œâ”€â”€ signup.ts                     # AI signup (72 lines)\n    â”œâ”€â”€ referral.ts                   # Submit referral (56 lines)\n    â”œâ”€â”€ submitListing.ts              # Full listing submission (273 lines)\n    â”œâ”€â”€ listingSync.ts                # Sync listing to Bubble (122 lines)\n    â””â”€â”€ proposal.ts                   # Create proposal - NEW (536 lines)\n\nsupabase/functions/_shared/           # Shared utilities\nâ”œâ”€â”€ bubbleSync.ts                     # BubbleSyncService class (375 lines)\nâ”œâ”€â”€ cors.ts                           # CORS headers (10 lines)\nâ”œâ”€â”€ errors.ts                         # Custom error classes (85 lines)\nâ”œâ”€â”€ types.ts                          # TypeScript interfaces (58 lines)\nâ””â”€â”€ validation.ts                     # Input validation (68 lines)\n\nsupabase/functions/proposal/lib/      # Proposal calculations (NEW DEPENDENCIES)\nâ”œâ”€â”€ calculations.ts                   # Compensation calculations (278 lines)\nâ”œâ”€â”€ status.ts                         # Status management (350 lines)\nâ””â”€â”€ types.ts                          # Proposal types (338 lines)\n```\n\n## Key Features\n\n### 1. Proposal Creation (NEW)\nThe `proposal.ts` handler creates proposals directly in Supabase with:\n- Bubble-compatible ID generation via RPC\n- Comprehensive data fetching (listing, guest, host, rental app)\n- Compensation and move-out date calculations\n- Initial status determination (based on rental app submission)\n- Guest and host user record updates\n\n**Dependencies**:\n- `proposal/lib/calculations.ts` - `calculateCompensation()`, `calculateMoveOutDate()`, `calculateComplementaryNights()`, `calculateComplementaryDays()`, `calculateOrderRanking()`, `formatPriceForDisplay()`\n- `proposal/lib/status.ts` - `determineInitialStatus()`, `ProposalStatusName`\n- `proposal/lib/types.ts` - `RentalType`, `ReservationSpan`\n\n### 2. Action Routing\nThe main router (`index.ts`) supports 10 actions:\n\n| Action | Handler | Auth Required | Bubble Sync |\n|--------|---------|---------------|-------------|\n| `create_listing` | `listing.ts` | No | Yes (best-effort) |\n| `get_listing` | `getListing.ts` | No | No (fetch only) |\n| `upload_photos` | `photos.ts` | No | No (workflow only) |\n| `send_message` | `messaging.ts` | No | No (workflow only) |\n| `submit_referral` | `referral.ts` | No | Yes (atomic) |\n| `signup_ai` | `signup.ts` | No | Yes (atomic) |\n| `submit_listing` | `submitListing.ts` | Yes | Yes (best-effort) |\n| `toggle_favorite` | `favorites.ts` | No | No (Supabase only) |\n| `get_favorites` | `getFavorites.ts` | No | No (Supabase only) |\n| `create_proposal` | `proposal.ts` | No | No (Supabase only) |\n\n### 3. Authentication Pattern\n- **Public actions**: Guest users allowed\n- **Protected actions**: Require Supabase Auth header\n- **Optional auth**: Authenticated users get full context\n\n## Deployment Steps\n\n### Prerequisites\n\n1. Supabase project set up\n2. Environment variables configured:\n   - `BUBBLE_API_BASE_URL`\n   - `BUBBLE_API_KEY`\n   - `SUPABASE_SERVICE_ROLE_KEY`\n   - `SUPABASE_URL` (auto-provided by Supabase)\n   - `SUPABASE_ANON_KEY` (auto-provided by Supabase)\n\n### Deployment Command\n\n**Using Supabase CLI**:\n```bash\ncd /path/to/project\nsupabase functions deploy bubble-proxy\n```\n\n**Using Supabase MCP**:\nThe function can be deployed via Supabase MCP with all dependencies bundled. The MCP tool will automatically include:\n- `index.ts` - Main router\n- All handlers in `handlers/`\n- All shared utilities from `_shared/`\n- All proposal utilities from `proposal/lib/`\n\nNote: The MCP tool handles path resolution for relative imports like `../../_shared/`, `../../proposal/lib/`, etc.\n\n### Configuration\n\nThe function is configured in `supabase/config.toml`:\n\n```toml\n[functions.bubble-proxy]\nenabled = true\nverify_jwt = false  # Handles own authentication\nimport_map = \"./functions/bubble-proxy/deno.json\"\nentrypoint = \"./functions/bubble-proxy/index.ts\"\n```\n\nKey settings:\n- **verify_jwt = false**: Function handles its own authentication (allows guest users)\n- **entrypoint = index.ts**: Main router file\n- **import_map**: Empty deno.json (all imports are from npm/https)\n\n## Testing Deployment\n\n### Test Create Proposal\n\n```bash\ncurl -X POST https://your-project.supabase.co/functions/v1/bubble-proxy \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"action\": \"create_proposal\",\n    \"payload\": {\n      \"guestId\": \"bubble-user-id-123\",\n      \"listingId\": \"bubble-listing-id-456\",\n      \"moveInStartRange\": \"2025-01-15\",\n      \"moveInEndRange\": \"2025-01-22\",\n      \"daysSelected\": [2, 3, 4, 5, 6],\n      \"nightsSelected\": [2, 3, 4, 5, 6],\n      \"reservationSpan\": \"2 weeks\",\n      \"reservationSpanWeeks\": 2,\n      \"checkInDay\": 3,\n      \"checkOutDay\": 1,\n      \"proposalPrice\": 150,\n      \"fourWeekRent\": 4200,\n      \"hostCompensation\": 4200,\n      \"needForSpace\": \"Relocating for work\",\n      \"aboutMe\": \"Professional, quiet tenant\",\n      \"estimatedBookingTotal\": 2100\n    }\n  }'\n```\n\n### Test Get Listing\n\n```bash\ncurl -X POST https://your-project.supabase.co/functions/v1/bubble-proxy \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"action\": \"get_listing\",\n    \"payload\": {\n      \"listing_id\": \"bubble-listing-id-456\"\n    }\n  }'\n```\n\n### Test Toggle Favorite\n\n```bash\ncurl -X POST https://your-project.supabase.co/functions/v1/bubble-proxy \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"action\": \"toggle_favorite\",\n    \"payload\": {\n      \"userId\": \"bubble-user-id-123\",\n      \"listingId\": \"bubble-listing-id-456\",\n      \"action\": \"add\"\n    }\n  }'\n```\n\n## Logs & Debugging\n\n### View Function Logs\n\n```bash\nsupabase functions logs bubble-proxy\n```\n\n### Key Log Messages\n\nThe function includes detailed logging at each step:\n- `[bubble-proxy] ========== NEW REQUEST ==========`\n- `[bubble-proxy] Action: {action}`\n- `[bubble-proxy] âœ… Authenticated user: {email}`\n- `[bubble-proxy] ðŸ‘¤ Guest user (no authentication)`\n- `[bubble-proxy] âœ… Handler completed successfully`\n- `[bubble-proxy] ========== REQUEST COMPLETE ==========`\n\nFor specific handler logs, look for:\n- `[Proposal Handler]` - Proposal creation\n- `[Listing Handler]` - Listing creation\n- `[Favorites Handler]` - Favorite management\n- `[BubbleSync]` - Bubble API interactions\n\n## Dependencies\n\n### External\n- `@supabase/supabase-js@2` (esm.sh)\n- Deno 2 runtime\n\n### Internal\n- `_shared/bubbleSync.ts` - Core sync service\n- `_shared/cors.ts` - CORS headers\n- `_shared/errors.ts` - Error handling\n- `_shared/types.ts` - TypeScript interfaces\n- `_shared/validation.ts` - Input validation\n- `proposal/lib/calculations.ts` - Proposal calculations (NEW)\n- `proposal/lib/status.ts` - Status management (NEW)\n- `proposal/lib/types.ts` - Proposal types (NEW)\n\n## Error Handling\n\nAll errors follow the standard format:\n\n```json\n{\n  \"success\": false,\n  \"error\": \"Descriptive error message\"\n}\n```\n\nHTTP Status Codes:\n- `200` - Success\n- `400` - ValidationError (missing/invalid fields)\n- `401` - AuthenticationError (auth required but not provided)\n- `500` - BubbleApiError, SupabaseSyncError, or other errors\n\n## Performance Considerations\n\n### Best Effort Sync\nFor listing creation, photo upload, and listing submission, sync failures to Supabase don't fail the entire operation. The data is created successfully in Bubble, and the client receives a successful response even if Supabase sync fails.\n\n### Atomic Operations\nFor proposal creation and referral submission, the entire operation fails if any step fails (all-or-nothing transaction pattern).\n\n## Future Enhancements\n\n1. Add caching for frequently-accessed listings\n2. Implement rate limiting per user\n3. Add batch operations for multiple listings\n4. Implement webhook callbacks for long-running operations\n\n## Related Documentation\n\n- **Architecture**: `supabase/CLAUDE.md`\n- **Proposal System**: `docs/PROPOSAL_FLOW.md` (if exists)\n- **Database Schema**: `DATABASE_SCHEMA_OVERVIEW.md`\n- **Bubble API**: `docs/BUBBLE_WORKFLOW_API_ENUMERATION.md`\n\n## Rollback Plan\n\nIf issues occur after deployment:\n\n1. **Disable function** (Supabase Dashboard > Functions > bubble-proxy > Disable)\n2. **Keep previous version** (Git enables quick rollback)\n3. **Rollback steps**:\n   ```bash\n   git revert ad3252e  # Revert latest proposal changes\n   supabase functions deploy bubble-proxy\n   ```\n\n## Conclusion\n\nThe `bubble-proxy` Edge Function is production-ready and includes:\n- Comprehensive error handling with NO fallback mechanisms\n- Clear logging for debugging\n- Flexible routing for 10 different actions\n- Atomic and best-effort transaction support\n- Full integration with Supabase and Bubble APIs\n\nDeploy with confidence knowing all dependencies are included and properly imported.\n