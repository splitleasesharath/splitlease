# Implementation Plan: Custom Magic Link Verification Page

## Overview

Create a custom `/auth/verify` page that intercepts Supabase OTP verification flows, allowing users to verify magic link tokens through a branded Split Lease URL instead of the default Supabase domain. This enables the user experience to remain on `split.lease` throughout the entire authentication flow.

## Success Criteria

- [ ] Route `/auth/verify` accepts `token_hash` and `type` URL parameters
- [ ] Page calls `supabase.auth.verifyOtp()` to validate the token
- [ ] Displays appropriate loading, success, and error states
- [ ] Redirects to intended destination (or `/`) on successful verification
- [ ] Handles expired, invalid, and malformed tokens gracefully
- [ ] Follows Split Lease routing conventions and Islands Architecture
- [ ] Works with Cloudflare Pages deployment (uses `cloudflareInternal` for query param preservation)

## Context & References

### Relevant Files

| File | Purpose | Changes Needed |
|------|---------|----------------|
| `app/src/routes.config.js` | Route Registry - single source of truth | Add `/auth/verify` route entry |
| `app/vite.config.js` | Vite build configuration | Add `auth-verify` to rollupOptions.input |
| `app/public/auth-verify.html` | HTML template | **CREATE** - Shell HTML for React mount |
| `app/src/auth-verify.jsx` | React entry point | **CREATE** - Mount AuthVerifyPage |
| `app/src/islands/pages/AuthVerifyPage/AuthVerifyPage.jsx` | Page component (hollow) | **CREATE** - UI rendering |
| `app/src/islands/pages/AuthVerifyPage/useAuthVerifyPageLogic.js` | Logic hook | **CREATE** - All business logic |
| `app/src/islands/pages/AuthVerifyPage/AuthVerifyPage.css` | Page styles | **CREATE** - Page-specific CSS |
| `app/src/lib/auth.js` | Auth utilities | Reference only - use existing `checkUrlForAuthError` |

### Related Documentation

- [ROUTING_GUIDE.md](c:\Users\Split Lease\Documents\Split Lease\.claude\Documentation\Routing\ROUTING_GUIDE.md) - Routing conventions
- [app/CLAUDE.md](c:\Users\Split Lease\Documents\Split Lease\app\CLAUDE.md) - Frontend architecture
- [app/src/CLAUDE.md](c:\Users\Split Lease\Documents\Split Lease\app\src\CLAUDE.md) - Source code patterns

### Existing Patterns to Follow

1. **ResetPasswordPage Pattern** (`app/src/islands/pages/ResetPasswordPage.jsx`)
   - Similar auth flow page handling Supabase session recovery
   - Uses status states: `loading`, `ready`, `success`, `error`
   - Handles timeout for initialization race conditions
   - Redirects after success

2. **AccountProfilePage Hollow Component Pattern** (`app/src/islands/pages/AccountProfilePage/`)
   - Subdirectory structure with page component + logic hook
   - All state/effects/handlers in the hook
   - Component only does JSX rendering

3. **Route Registry Pattern** (`app/src/routes.config.js`)
   - Uses `cloudflareInternal: true` for routes that need query param preservation
   - Uses `internalName` for the `_internal/` file copy

## Implementation Steps

### Step 1: Add Route to Registry

**Files:** `c:\Users\Split Lease\Documents\Split Lease\app\src\routes.config.js`
**Purpose:** Register the new `/auth/verify` route with all required properties

**Details:**
- Add new route entry in the `// ===== AUTH PAGES =====` section (after reset-password)
- Set `cloudflareInternal: true` to prevent Cloudflare 308 redirects that strip query params
- Set `internalName: 'auth-verify-view'` for the `_internal/` file
- Set `protected: false` (public page - user isn't authenticated yet)
- Set `hasDynamicSegment: false` (uses query params, not path segments)

**Code to add:**
```javascript
{
  path: '/auth/verify',
  file: 'auth-verify.html',
  aliases: ['/auth/verify.html'],
  protected: false,
  cloudflareInternal: true,
  internalName: 'auth-verify-view',
  hasDynamicSegment: false
},
```

**Validation:** Route should appear when running `bun run generate-routes`

---

### Step 2: Add Vite Build Input

**Files:** `c:\Users\Split Lease\Documents\Split Lease\app\vite.config.js`
**Purpose:** Add the new page to the Vite build configuration

**Details:**
- Add entry to `build.rollupOptions.input` object
- Key should be `'auth-verify'`
- Value should be `resolve(__dirname, 'public/auth-verify.html')`

**Location in file:** Add after `'reset-password'` entry (~line 273)

**Validation:** Build should succeed with `bun run build`

---

### Step 3: Create HTML Template

**Files:** `c:\Users\Split Lease\Documents\Split Lease\app\public\auth-verify.html`
**Purpose:** Shell HTML page that loads the React app

**Details:**
- Follow the pattern from `reset-password.html`
- Mount point ID: `auth-verify-page`
- Title: "Verify - Split Lease"
- Meta description: "Verify your Split Lease login"
- Include Hotjar tracking script (standard)
- Link to main.css for base styles

**Validation:** File should be created and accessible at `/auth/verify` in dev mode

---

### Step 4: Create React Entry Point

**Files:** `c:\Users\Split Lease\Documents\Split Lease\app\src\auth-verify.jsx`
**Purpose:** Mount the React page component to the DOM

**Details:**
- Follow the pattern from `reset-password.jsx`
- Use dynamic import for error isolation
- Mount to `#auth-verify-page`
- Include error boundary wrapper with user-friendly error display

**Validation:** React app should mount when visiting the page

---

### Step 5: Create Page Directory and Logic Hook

**Files:** `c:\Users\Split Lease\Documents\Split Lease\app\src\islands\pages\AuthVerifyPage\useAuthVerifyPageLogic.js`
**Purpose:** Encapsulate all business logic for the verification flow

**Details:**
- Extract `token_hash` and `type` from URL query parameters
- Define status states: `'loading'`, `'verifying'`, `'success'`, `'error'`
- Call `supabase.auth.verifyOtp()` with token and type
- Handle success: set session, redirect to destination
- Handle error: parse error message, display user-friendly message
- Support `redirect_to` query parameter for post-verification navigation
- Set reasonable timeout for verification (e.g., 15 seconds)

**Hook return interface:**
```javascript
{
  status,           // 'loading' | 'verifying' | 'success' | 'error'
  errorMessage,     // User-friendly error string or null
  errorCode,        // Original error code for debugging
  handleRetry,      // Function to retry verification
  redirectTo        // Where user will be redirected on success
}
```

**Error scenarios to handle:**
- Missing `token_hash` or `type` parameters
- Expired token (`otp_expired`)
- Invalid/malformed token
- Already used token
- Network errors
- Timeout

**Validation:** Hook should be testable in isolation

---

### Step 6: Create Page Component (Hollow)

**Files:** `c:\Users\Split Lease\Documents\Split Lease\app\src\islands\pages\AuthVerifyPage\AuthVerifyPage.jsx`
**Purpose:** Render the UI based on status from logic hook

**Details:**
- Import and use `useAuthVerifyPageLogic` hook
- Include Header and Footer components
- Render different content based on `status`:
  - `loading`: Spinner + "Preparing verification..."
  - `verifying`: Spinner + "Verifying your login..."
  - `success`: Checkmark + "Verified! Redirecting..."
  - `error`: Error icon + message + "Back to Login" button
- Style using CSS classes from AuthVerifyPage.css

**Component structure:**
```jsx
export default function AuthVerifyPage() {
  const { status, errorMessage, handleRetry, redirectTo } = useAuthVerifyPageLogic();

  return (
    <>
      <Header />
      <main className="auth-verify-page">
        <div className="auth-verify-container">
          {/* Status-based content */}
        </div>
      </main>
      <Footer />
    </>
  );
}
```

**Validation:** Page renders correctly in all states

---

### Step 7: Create Page Styles

**Files:** `c:\Users\Split Lease\Documents\Split Lease\app\src\islands\pages\AuthVerifyPage\AuthVerifyPage.css`
**Purpose:** Style the verification page

**Details:**
- Follow styling patterns from `reset-password.css`
- Center content vertically and horizontally
- Style loading spinner (can reuse existing)
- Style success state (checkmark animation)
- Style error state (error icon, message, button)
- Responsive design for mobile

**Key classes:**
- `.auth-verify-page` - Main page container
- `.auth-verify-container` - Centered content box
- `.auth-verify-loading` - Loading state styles
- `.auth-verify-success` - Success state styles
- `.auth-verify-error` - Error state styles
- `.spinner` - Loading spinner animation

**Validation:** Page looks good on desktop and mobile

---

### Step 8: Run Route Generation

**Command:** `bun run generate-routes`
**Purpose:** Regenerate `_redirects` and `_routes.json` from routes.config.js

**Details:**
- This creates the necessary Cloudflare Pages routing rules
- Validates the route configuration
- Generates `_internal/auth-verify-view` entry

**Validation:**
- `public/_redirects` contains `/auth/verify` â†’ `/_internal/auth-verify-view 200`
- `public/_routes.json` is updated

---

## Edge Cases & Error Handling

| Edge Case | Handling |
|-----------|----------|
| Missing `token_hash` parameter | Show error: "Invalid verification link. Please request a new login link." |
| Missing `type` parameter | Show error: "Invalid verification link. Please request a new login link." |
| Expired token (`otp_expired`) | Show error: "This login link has expired. Please request a new one." |
| Invalid/malformed token | Show error: "Invalid verification link. Please request a new login link." |
| Already used token | Show error: "This login link has already been used. Please request a new one." |
| Network timeout | Show error: "Verification timed out. Please try again." with retry button |
| Network error | Show error: "Network error. Please check your connection and try again." with retry button |
| User already logged in | Proceed normally (replace existing session) |

## Testing Considerations

### Manual Testing Checklist

1. **Happy Path**
   - Trigger magic link email
   - Click link with valid `token_hash` and `type=magiclink`
   - Verify page shows loading -> verifying -> success -> redirect

2. **Error Paths**
   - Visit page without any parameters
   - Visit page with only `token_hash` (missing type)
   - Visit page with expired token (wait 1 hour or use old link)
   - Visit page with invalid `token_hash`
   - Click same link twice (already used)

3. **Network Conditions**
   - Test with slow connection (throttle network)
   - Test with network disconnected

4. **Mobile Testing**
   - Verify responsive layout
   - Test email link click on mobile browser

### Integration Points

- Supabase Auth `verifyOtp` API
- Session storage after verification
- Redirect to intended destination

## Rollback Strategy

If issues arise after deployment:

1. Revert route from `routes.config.js`
2. Run `bun run generate-routes`
3. Remove entry from `vite.config.js`
4. Delete created files (can keep for debugging)
5. Update Supabase email template to use default Supabase URL

Note: This change is additive and doesn't modify existing functionality. The old flow (if any) continues to work until the Supabase email template is updated to use the new URL.

## Dependencies & Blockers

### Prerequisites
- Supabase Site URL set to `https://split.lease` (confirmed by user)
- User must update Supabase email template after implementation

### Post-Implementation Action Required
User must update Supabase email template to use:
```
{{ .SiteURL }}/auth/verify?token_hash={{ .TokenHash }}&type=magiclink
```

Instead of the default Supabase confirmation URL.

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Token verification fails silently | Low | High | Comprehensive error logging and user-friendly messages |
| Query params stripped by Cloudflare | Medium | High | Use `cloudflareInternal: true` (proven pattern from reset-password) |
| Race condition with Supabase initialization | Medium | Medium | Add brief wait period before verification (like ResetPasswordPage) |
| Mobile deep linking issues | Low | Medium | Test on mobile devices before launch |

---

## Files Summary

### Files to Create
1. `app/public/auth-verify.html` - HTML template
2. `app/src/auth-verify.jsx` - React entry point
3. `app/src/islands/pages/AuthVerifyPage/AuthVerifyPage.jsx` - Page component
4. `app/src/islands/pages/AuthVerifyPage/useAuthVerifyPageLogic.js` - Logic hook
5. `app/src/islands/pages/AuthVerifyPage/AuthVerifyPage.css` - Styles

### Files to Modify
1. `app/src/routes.config.js` - Add route entry
2. `app/vite.config.js` - Add build input

### Files to Reference (Read-Only)
1. `app/src/islands/pages/ResetPasswordPage.jsx` - Auth flow pattern
2. `app/src/lib/auth.js` - Auth utilities (checkUrlForAuthError)
3. `app/src/lib/supabase.js` - Supabase client
4. `app/public/reset-password.html` - HTML template pattern
5. `app/src/reset-password.jsx` - Entry point pattern
6. `app/src/styles/reset-password.css` - Style patterns

---

**Plan Version:** 1.0
**Created:** 2026-01-06T16:15:00
**Author:** Claude Code (Implementation Planner)
