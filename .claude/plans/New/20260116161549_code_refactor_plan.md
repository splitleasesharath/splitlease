# Code Refactoring Plan - app/src/

Date: 2026-01-16
Audit Type: general
Generated by: Ralph Loop Code Audit

---

## Executive Summary

This audit identified **25 actionable refactoring chunks** across the `app/src/` codebase, organized by affected page groups. Key findings include:

1. **Duplicate Services (Critical)**: 3 pairs of nearly identical services for amenities, neighborhoods, and proposal data processing
2. **Excessive Console Logging**: 1,399 console statements across 158 files - production code should use structured logger
3. **Large Monolithic Files**: SearchPage (2,981 LOC), ViewSplitLeasePage (2,953 LOC), Header (993 LOC)
4. **Deep Import Paths**: 43 files with 4+ level relative imports (../../../../)
5. **Excessive State in Components**: SearchPage has 55 useState hooks, ViewSplitLeasePage has 30
6. **Duplicate suggestedProposalService**: Two separate service files with overlapping functionality
7. **Incomplete TODOs**: 13 TODO comments indicating unfinished implementations

---

## Critical Cascading Dependency Analysis

### SYMBOL: processProposalData
**Files that import:**
- `app/src/logic/processors/index.js` (re-exports both versions)
- `app/src/logic/workflows/booking/loadProposalDetailsWorkflow.js`

**Risk:** Two different functions with the same name exported from different paths with different signatures.

### SYMBOL: amenitiesService functions
**Duplicate locations:**
- `app/src/islands/pages/SelfListingPage/utils/amenitiesService.ts`
- `app/src/islands/shared/EditListingDetails/services/amenitiesService.js`

**Files that import:**
- `app/src/islands/pages/ListingDashboardPage/hooks/useAIImportAssistant.js` → EditListingDetails version
- `app/src/islands/pages/SelfListingPage/sections/Section2Features.tsx` → SelfListingPage version

### SYMBOL: neighborhoodService functions
**Duplicate locations:**
- `app/src/islands/pages/SelfListingPage/utils/neighborhoodService.ts`
- `app/src/islands/shared/EditListingDetails/services/neighborhoodService.js`

**Files that import:**
- `app/src/islands/pages/ListingDashboardPage/hooks/useAIImportAssistant.js` → EditListingDetails version
- `app/src/islands/pages/SelfListingPage/sections/Section2Features.tsx` → SelfListingPage version

### SYMBOL: suggestedProposalService functions
**Duplicate locations:**
- `app/src/islands/shared/SuggestedProposals/suggestedProposalService.js`
- `app/src/islands/pages/CreateSuggestedProposalPage/suggestedProposalService.js`

**Files that import:**
- Multiple files import from `SuggestedProposals` version
- `CreateSuggestedProposalPage` components import from local version

---

## PAGE GROUP: /search (Chunks: 1, 2, 3)

### CHUNK 1: Excessive useState hooks in SearchPage
**File:** `app/src/islands/pages/SearchPage.jsx`
**Line:** 1-2981
**Issue:** SearchPage.jsx contains 55 useState hooks making state management complex and error-prone. Should extract to custom hook following hollow component pattern.
**Affected Pages:** /search

**Current Code:**
```javascript
// Lines 1-40 show the pattern of imports and component definition
import { useState, useEffect, useRef, useCallback, useMemo } from 'react';
import { createRoot } from 'react-dom/client';
import GoogleMap from '../shared/GoogleMap.jsx';
// ... many more imports

// The component itself contains 55 useState calls and 19 useEffect calls
// This violates the hollow component pattern used elsewhere in the codebase
```

**Refactored Code:**
```javascript
// SearchPage.jsx - Hollow component
import { useSearchPageLogic } from './useSearchPageLogic.js';
import SearchPageUI from './SearchPageUI.jsx';

export default function SearchPage() {
  const logic = useSearchPageLogic();
  return <SearchPageUI {...logic} />;
}

// useSearchPageLogic.js should contain all 55 state variables
// organized into logical groups with useReducer for related state
```

**Testing:**
- [ ] Verify all filters work after refactor
- [ ] Test map/list toggle functionality
- [ ] Verify URL parameter parsing still works
- [ ] Test proposal flow integration

**Cascading Changes Required:**
- Create new file: `app/src/islands/pages/SearchPage/useSearchPageLogic.js`
- Create new file: `app/src/islands/pages/SearchPage/SearchPageUI.jsx`
- Move SearchPage.jsx to `app/src/islands/pages/SearchPage/SearchPage.jsx`

~~~~~

### CHUNK 2: AiSignupMarketReport excessive logging
**File:** `app/src/islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx`
**Line:** Multiple (57 console statements)
**Issue:** Component has 57 console.log/warn/error statements. Production code should use structured logger or remove debug logs.
**Affected Pages:** /search, / (home)

**Current Code:**
```javascript
// Example from multiple locations in the file
console.log('[AiSignupMarketReport] Starting AI parsing...');
console.log('[AiSignupMarketReport] Extracted email:', email);
console.error('[AiSignupMarketReport] API error:', error);
console.log('[AiSignupMarketReport] User created successfully');
```

**Refactored Code:**
```javascript
import { logger } from '../../../lib/logger.js';

// Replace console.log with logger.debug for dev-only logs
logger.debug('[AiSignupMarketReport] Starting AI parsing...');

// Replace console.error with logger.error for actual errors
logger.error('[AiSignupMarketReport] API error:', error);

// Remove informational logs entirely or gate behind DEBUG flag
if (import.meta.env.DEV) {
  logger.debug('[AiSignupMarketReport] User created successfully');
}
```

**Testing:**
- [ ] Verify component still functions with logger
- [ ] Check logger output in development mode
- [ ] Verify no console output in production build

~~~~~

### CHUNK 3: Remove TODO in useScheduleSelectorLogicCore
**File:** `app/src/islands/shared/useScheduleSelectorLogicCore.js`
**Line:** 18
**Issue:** Unresolved TODO comment indicating incomplete migration.
**Affected Pages:** /search, /view-split-lease

**Current Code:**
```javascript
import { calculatePrice } from '../../lib/scheduleSelector/priceCalculations.js' // TODO: Migrate to Logic Core
```

**Refactored Code:**
```javascript
// Move calculatePrice to logic/calculators/pricing/ and update import
import { calculatePrice } from '../../logic/calculators/pricing/calculateSchedulePrice.js';
```

**Testing:**
- [ ] Verify price calculations work after import path change
- [ ] Test on SearchPage and ViewSplitLeasePage

**Cascading Changes Required:**
- Move/create: `app/src/logic/calculators/pricing/calculateSchedulePrice.js`
- Update imports in `app/src/islands/shared/useScheduleSelectorLogicCore.js`

---

## PAGE GROUP: /view-split-lease (Chunks: 4, 5, 6)

~~~~~

### CHUNK 4: Excessive useState hooks in ViewSplitLeasePage
**File:** `app/src/islands/pages/ViewSplitLeasePage/ViewSplitLeasePage.jsx`
**Line:** 1-2953
**Issue:** ViewSplitLeasePage.jsx contains 30 useState hooks. Should extract to custom hook following the useXxxPageLogic pattern established in other pages.
**Affected Pages:** /view-split-lease

**Current Code:**
```javascript
// The file has state scattered throughout
const [listing, setListing] = useState(null);
const [host, setHost] = useState(null);
const [photos, setPhotos] = useState([]);
const [loading, setLoading] = useState(true);
// ... 26 more useState calls
```

**Refactored Code:**
```javascript
// ViewSplitLeasePage.jsx - Hollow component following pattern
import { useViewSplitLeasePageLogic } from './useViewSplitLeasePageLogic.js';

export default function ViewSplitLeasePage() {
  const {
    listing,
    host,
    photos,
    loading,
    // ... destructure all needed values
    handleActions
  } = useViewSplitLeasePageLogic();

  return (
    // JSX only - no logic in component
  );
}
```

**Testing:**
- [ ] Verify listing data loads correctly
- [ ] Test proposal creation flow
- [ ] Verify photo gallery functionality
- [ ] Test host profile modal

**Cascading Changes Required:**
- Create new file: `app/src/islands/pages/ViewSplitLeasePage/useViewSplitLeasePageLogic.js`

~~~~~

### CHUNK 5: ViewSplitLeasePage console logging cleanup
**File:** `app/src/islands/pages/ViewSplitLeasePage/ViewSplitLeasePage.jsx`
**Line:** Multiple (17 console statements)
**Issue:** 17 console statements in production component.
**Affected Pages:** /view-split-lease

**Current Code:**
```javascript
console.log('[ViewSplitLeasePage] Fetching listing data...');
console.log('[ViewSplitLeasePage] Listing loaded:', listing);
console.error('[ViewSplitLeasePage] Failed to load listing:', error);
```

**Refactored Code:**
```javascript
import { logger } from '../../../lib/logger.js';

// Only keep essential error logging
logger.error('[ViewSplitLeasePage] Failed to load listing:', { error, listingId });

// Remove or gate debug logs
if (import.meta.env.DEV) {
  logger.debug('[ViewSplitLeasePage] Listing loaded:', { id: listing?._id });
}
```

**Testing:**
- [ ] Verify page loads without console spam
- [ ] Check error logging still works for failures

~~~~~

### CHUNK 6: Inline styles cleanup in ViewSplitLeasePage
**File:** `app/src/islands/pages/ViewSplitLeasePage/ViewSplitLeasePage.jsx`
**Line:** Multiple (205 inline style usages)
**Issue:** 205 inline style={{}} usages making styles hard to maintain and causing unnecessary re-renders.
**Affected Pages:** /view-split-lease

**Current Code:**
```javascript
<div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
  <span style={{ fontSize: '14px', color: '#666' }}>
    {listing.address}
  </span>
</div>
```

**Refactored Code:**
```javascript
// Add to ViewSplitLeasePage.css
.listing-address-container {
  display: flex;
  align-items: center;
  gap: 8px;
}

.listing-address-text {
  font-size: 14px;
  color: #666;
}

// In JSX
<div className="listing-address-container">
  <span className="listing-address-text">
    {listing.address}
  </span>
</div>
```

**Testing:**
- [ ] Verify visual appearance unchanged
- [ ] Check responsive behavior

---

## PAGE GROUP: /listing-dashboard (Chunks: 7, 8)

~~~~~

### CHUNK 7: Deep import path in useListingAuth
**File:** `app/src/islands/pages/ListingDashboardPage/hooks/useListingAuth.js`
**Line:** 1-4
**Issue:** 4 imports with ../../../../ paths. Should use alias or move shared dependencies.
**Affected Pages:** /listing-dashboard

**Current Code:**
```javascript
import { checkAuthStatus, validateTokenAndFetchUser, getUserId } from '../../../../lib/auth.js';
import { supabase } from '../../../../lib/supabase.js';
import { logger } from '../../../../lib/logger.js';
import { isHost } from '../../../../logic/rules/users/isHost.js';
```

**Refactored Code:**
```javascript
// Option 1: Use path aliases (requires vite.config.js update)
import { checkAuthStatus, validateTokenAndFetchUser, getUserId } from '@lib/auth.js';
import { supabase } from '@lib/supabase.js';
import { logger } from '@lib/logger.js';
import { isHost } from '@logic/rules/users/isHost.js';

// Option 2: Create barrel export at lib/index.js
import { checkAuthStatus, validateTokenAndFetchUser, getUserId, supabase, logger } from '@lib';
```

**Testing:**
- [ ] Verify imports resolve correctly after alias setup
- [ ] Test listing dashboard authentication flow

**Cascading Changes Required:**
- Update `app/vite.config.js` to add path aliases
- Update 43 files with deep imports

~~~~~

### CHUNK 8: useAIImportAssistant imports from duplicate service
**File:** `app/src/islands/pages/ListingDashboardPage/hooks/useAIImportAssistant.js`
**Line:** 6-7
**Issue:** Imports from EditListingDetails services instead of canonical lib/ location.
**Affected Pages:** /listing-dashboard

**Current Code:**
```javascript
import { getCommonInUnitAmenities, getCommonBuildingAmenities } from '../../../shared/EditListingDetails/services/amenitiesService';
import { getNeighborhoodByZipCode, getNeighborhoodByName } from '../../../shared/EditListingDetails/services/neighborhoodService';
```

**Refactored Code:**
```javascript
// After consolidating services to lib/
import { getCommonInUnitAmenities, getCommonBuildingAmenities } from '../../../../lib/services/amenitiesService.js';
import { getNeighborhoodByZipCode, getNeighborhoodByName } from '../../../../lib/services/neighborhoodService.js';
```

**Testing:**
- [ ] Verify AI import assistant still fetches amenities
- [ ] Test neighborhood lookup functionality

**Cascading Changes Required:**
- See CHUNK 11 for service consolidation

---

## PAGE GROUP: /self-listing (Chunks: 9, 10, 11, 12, 13)

~~~~~

### CHUNK 9: Duplicate amenitiesService.ts (SelfListingPage version)
**File:** `app/src/islands/pages/SelfListingPage/utils/amenitiesService.ts`
**Line:** 1-126
**Issue:** Near-identical copy of amenitiesService. The TypeScript version has slightly more functions (getAllAmenitiesByType) but core logic is duplicated.
**Affected Pages:** /self-listing

**Current Code:**
```typescript
// SelfListingPage/utils/amenitiesService.ts
import { supabase } from '../../../../lib/supabase.js';

export async function getCommonAmenitiesByType(type: string): Promise<string[]> {
  // Same logic as EditListingDetails version
  const { data, error } = await supabase
    .from('zat_features_amenity')
    .select('Name, "pre-set?", "Type - Amenity Categories"')
    .eq('"pre-set?"', true)
    .eq('"Type - Amenity Categories"', type)
    .order('Name', { ascending: true });
  // ...
}
```

**Refactored Code:**
```typescript
// DELETE this file entirely
// Update imports in Section2Features.tsx to use consolidated service
// See CHUNK 11 for canonical location
```

**Testing:**
- [ ] Verify Section2Features loads amenities after import change
- [ ] Test "In Unit" and "In Building" amenity lists

**Cascading Changes Required:**
- `app/src/islands/pages/SelfListingPage/sections/Section2Features.tsx` - update imports

~~~~~

### CHUNK 10: Duplicate neighborhoodService.ts (SelfListingPage version)
**File:** `app/src/islands/pages/SelfListingPage/utils/neighborhoodService.ts`
**Line:** 1-122
**Issue:** Near-identical copy of neighborhoodService. Both have getNeighborhoodByZipCode and getNeighborhoodDescriptionWithFallback.
**Affected Pages:** /self-listing

**Current Code:**
```typescript
// SelfListingPage/utils/neighborhoodService.ts - nearly identical to EditListingDetails version
export async function getNeighborhoodByZipCode(zipCode: string): Promise<Neighborhood | null> {
  const { data, error } = await supabase.rpc('get_neighborhood_by_zip', {
    zip_code: zipCode
  });
  // Same logic...
}
```

**Refactored Code:**
```typescript
// DELETE this file
// See CHUNK 12 for canonical location
```

**Testing:**
- [ ] Verify neighborhood description loads in Section2Features
- [ ] Test AI fallback for unknown ZIP codes

**Cascading Changes Required:**
- `app/src/islands/pages/SelfListingPage/sections/Section2Features.tsx` - update imports

~~~~~

### CHUNK 11: Consolidate amenitiesService to lib/services/
**File:** Create: `app/src/lib/services/amenitiesService.js`
**Line:** N/A (new file)
**Issue:** Create canonical amenitiesService combining features from both versions.
**Affected Pages:** /self-listing, /listing-dashboard

**Current Code:**
```javascript
// Two versions exist:
// 1. app/src/islands/pages/SelfListingPage/utils/amenitiesService.ts
// 2. app/src/islands/shared/EditListingDetails/services/amenitiesService.js
```

**Refactored Code:**
```javascript
/**
 * Amenities Service - Canonical location
 *
 * Fetches amenity data from Supabase zat_features_amenity table.
 * Consolidates functionality from SelfListingPage and EditListingDetails versions.
 */

import { supabase } from '../supabase.js';

/**
 * Fetches ALL amenities by type (for full checkbox lists)
 * @param {string} type - "In Unit" | "In Building"
 * @returns {Promise<string[]>}
 */
export async function getAllAmenitiesByType(type) {
  if (!type?.trim()) return [];

  const { data, error } = await supabase
    .from('zat_features_amenity')
    .select('Name, "Type - Amenity Categories"')
    .eq('"Type - Amenity Categories"', type)
    .eq('pending', false)
    .order('Name', { ascending: true });

  if (error) {
    console.error('[amenitiesService] Error fetching amenities:', error);
    return [];
  }

  return (data || []).map(a => a.Name);
}

/**
 * Fetches common (pre-set) amenities by type
 * @param {string} type - "In Unit" | "In Building" | "In Room"
 * @returns {Promise<string[]>}
 */
export async function getCommonAmenitiesByType(type) {
  if (!type?.trim()) return [];

  const { data, error } = await supabase
    .from('zat_features_amenity')
    .select('Name')
    .eq('"pre-set?"', true)
    .eq('"Type - Amenity Categories"', type)
    .order('Name', { ascending: true });

  if (error) {
    console.error('[amenitiesService] Error fetching common amenities:', error);
    return [];
  }

  return (data || []).map(a => a.Name);
}

// Convenience exports
export const getAllInUnitAmenities = () => getAllAmenitiesByType('In Unit');
export const getAllBuildingAmenities = () => getAllAmenitiesByType('In Building');
export const getCommonInUnitAmenities = () => getCommonAmenitiesByType('In Unit');
export const getCommonBuildingAmenities = () => getCommonAmenitiesByType('In Building');
```

**Testing:**
- [ ] Create unit tests for all exported functions
- [ ] Integration test with /self-listing page
- [ ] Integration test with /listing-dashboard AI import

**Cascading Changes Required:**
- Delete: `app/src/islands/pages/SelfListingPage/utils/amenitiesService.ts`
- Delete: `app/src/islands/shared/EditListingDetails/services/amenitiesService.js`
- Update: `app/src/islands/pages/SelfListingPage/sections/Section2Features.tsx`
- Update: `app/src/islands/pages/ListingDashboardPage/hooks/useAIImportAssistant.js`
- Update: `app/src/islands/shared/EditListingDetails/useEditListingDetailsLogic.js`

~~~~~

### CHUNK 12: Consolidate neighborhoodService to lib/services/
**File:** Create: `app/src/lib/services/neighborhoodService.js`
**Line:** N/A (new file)
**Issue:** Create canonical neighborhoodService combining features from both versions.
**Affected Pages:** /self-listing, /listing-dashboard

**Current Code:**
```javascript
// Two versions exist with slight differences in return shape
```

**Refactored Code:**
```javascript
/**
 * Neighborhood Service - Canonical location
 *
 * Fetches neighborhood data from Supabase zat_geo_hood_mediumlevel table.
 * Includes AI fallback for unknown neighborhoods.
 */

import { supabase } from '../supabase.js';
import { generateNeighborhoodDescription } from '../aiService.js';

/**
 * Fetches neighborhood by ZIP code using RPC function
 * @param {string} zipCode
 * @returns {Promise<{neighborhoodName: string, description: string, zips?: string[]} | null>}
 */
export async function getNeighborhoodByZipCode(zipCode) {
  if (!zipCode?.trim()) return null;

  const { data, error } = await supabase.rpc('get_neighborhood_by_zip', {
    zip_code: zipCode
  });

  if (error || !data?.length) {
    return null;
  }

  const hood = data[0];
  return {
    neighborhoodName: hood.Display || '',
    description: hood['Neighborhood Description'] || '',
    zips: hood.Zips || []
  };
}

/**
 * Fetches neighborhood by name using case-insensitive match
 * @param {string} neighborhoodName
 * @returns {Promise<{neighborhoodName: string, description: string} | null>}
 */
export async function getNeighborhoodByName(neighborhoodName) {
  if (!neighborhoodName?.trim()) return null;

  const { data, error } = await supabase
    .from('zat_geo_hood_mediumlevel')
    .select('Display, "Neighborhood Description"')
    .ilike('Display', neighborhoodName.trim())
    .limit(1)
    .maybeSingle();

  if (error || !data) return null;

  return {
    neighborhoodName: data.Display || '',
    description: data['Neighborhood Description'] || ''
  };
}

/**
 * Get neighborhood description with AI fallback
 * @param {string} zipCode
 * @param {{fullAddress: string, city: string, state: string, zip: string}} addressData
 * @returns {Promise<{description: string, neighborhoodName?: string, source: 'database'|'ai'} | null>}
 */
export async function getNeighborhoodDescriptionWithFallback(zipCode, addressData) {
  const dbResult = await getNeighborhoodByZipCode(zipCode);

  if (dbResult?.description) {
    return {
      description: dbResult.description,
      neighborhoodName: dbResult.neighborhoodName,
      source: 'database'
    };
  }

  if (!addressData?.fullAddress && !addressData?.city) {
    return null;
  }

  try {
    const aiDescription = await generateNeighborhoodDescription(addressData);
    return aiDescription ? { description: aiDescription, source: 'ai' } : null;
  } catch {
    return null;
  }
}

/**
 * Extract ZIP code from address string
 * @param {string} address
 * @returns {string}
 */
export function extractZipCode(address) {
  if (!address) return '';
  const match = address.match(/\b(\d{5})(-\d{4})?\b/);
  return match ? match[1] : '';
}
```

**Testing:**
- [ ] Test ZIP code lookup for known NYC neighborhoods
- [ ] Test AI fallback for unknown ZIP codes
- [ ] Test getNeighborhoodByName lookup

**Cascading Changes Required:**
- Delete: `app/src/islands/pages/SelfListingPage/utils/neighborhoodService.ts`
- Delete: `app/src/islands/shared/EditListingDetails/services/neighborhoodService.js`
- Update: `app/src/islands/pages/SelfListingPage/sections/Section2Features.tsx`
- Update: `app/src/islands/pages/ListingDashboardPage/hooks/useAIImportAssistant.js`
- Update: `app/src/islands/shared/EditListingDetails/useEditListingDetailsLogic.js`

~~~~~

### CHUNK 13: SelfListingPage excessive console logging
**File:** `app/src/islands/pages/SelfListingPage/SelfListingPage.tsx`
**Line:** Multiple (36 console statements)
**Issue:** 36 console statements in production component.
**Affected Pages:** /self-listing

**Current Code:**
```typescript
console.log('[SelfListingPage] Section changed to:', currentSection);
console.log('[SelfListingPage] Form data updated:', formData);
console.error('[SelfListingPage] Save failed:', error);
```

**Refactored Code:**
```typescript
import { logger } from '../../../lib/logger.js';

// Keep only error logging
logger.error('[SelfListingPage] Save failed:', { error, section: currentSection });

// Remove or gate debug logs
if (import.meta.env.DEV) {
  logger.debug('[SelfListingPage] Section changed:', { section: currentSection });
}
```

**Testing:**
- [ ] Verify form wizard still works without console spam
- [ ] Check error logging for save failures

---

## PAGE GROUP: GLOBAL (Chunks: 14, 15, 16, 17, 18)

~~~~~

### CHUNK 14: Duplicate processProposalData functions
**File:** `app/src/logic/processors/index.js`
**Line:** 25, 33-39
**Issue:** Two different processProposalData functions exported - one from proposal/, one from proposals/. Different signatures and purposes.
**Affected Pages:** /guest-proposals, /host-proposals, /view-split-lease, /messaging

**Current Code:**
```javascript
// app/src/logic/processors/index.js
export { processProposalData } from './proposal/processProposalData.js'

// Also exports from proposals/ with alias
export {
  processProposalData as processFullProposalData,
  // ...
} from './proposals/processProposalData.js'
```

**Refactored Code:**
```javascript
// Rename to clarify purpose
// proposal/processProposalData.js -> processProposalTerms.js (handles counteroffer merging)
// proposals/processProposalData.js -> processFullProposal.js (handles full proposal with nested data)

// app/src/logic/processors/index.js
export { processProposalTerms } from './proposal/processProposalTerms.js';
export {
  processFullProposal, // renamed from processProposalData
  processUserData,
  processListingData,
  processHostData,
  processVirtualMeetingData
} from './proposals/processFullProposal.js';
```

**Testing:**
- [ ] Find all usages of processProposalData and update imports
- [ ] Verify proposal cards display correctly
- [ ] Test counteroffer comparison modal

**Cascading Changes Required:**
- Rename: `app/src/logic/processors/proposal/processProposalData.js` → `processProposalTerms.js`
- Rename: `app/src/logic/processors/proposals/processProposalData.js` → `processFullProposal.js`
- Update: `app/src/logic/processors/index.js`
- Update: `app/src/logic/workflows/booking/loadProposalDetailsWorkflow.js`

~~~~~

### CHUNK 15: Duplicate suggestedProposalService
**File:** `app/src/islands/pages/CreateSuggestedProposalPage/suggestedProposalService.js`
**Line:** 1-463
**Issue:** Separate service file that overlaps with shared/SuggestedProposals/suggestedProposalService.js. The CreateSuggestedProposal version has additional functions for admin use.
**Affected Pages:** /create-suggested-proposal (admin page)

**Current Code:**
```javascript
// CreateSuggestedProposalPage/suggestedProposalService.js
// Contains: getDefaultListings, searchListings, getListingPhotos,
// getDefaultGuests, searchGuests, getUserProposalsForListing,
// createSuggestedProposal, parseCallTranscription, utility functions

// shared/SuggestedProposals/suggestedProposalService.js
// Contains: fetchSuggestedProposals, markProposalInterested,
// dismissProposal, fetchPendingConfirmationCount, fetchPendingConfirmationProposals
```

**Refactored Code:**
```javascript
// Consolidate to app/src/lib/services/suggestedProposalService.js
// Split into logical groups:

// app/src/lib/services/suggestedProposals/fetchService.js
export { fetchSuggestedProposals, fetchPendingConfirmationCount, fetchPendingConfirmationProposals, getSuggestedProposal };

// app/src/lib/services/suggestedProposals/actionService.js
export { markProposalInterested, dismissProposal, createSuggestedProposal };

// app/src/lib/services/suggestedProposals/searchService.js (admin-only)
export { getDefaultListings, searchListings, getDefaultGuests, searchGuests };

// app/src/lib/services/suggestedProposals/index.js - barrel export
export * from './fetchService.js';
export * from './actionService.js';
export * from './searchService.js';
```

**Testing:**
- [ ] Test suggested proposal popup in Header
- [ ] Test create suggested proposal admin flow
- [ ] Verify pending count badge updates

**Cascading Changes Required:**
- Create: `app/src/lib/services/suggestedProposals/` directory structure
- Delete: `app/src/islands/pages/CreateSuggestedProposalPage/suggestedProposalService.js`
- Delete: `app/src/islands/shared/SuggestedProposals/suggestedProposalService.js`
- Update imports in 15+ files

~~~~~

### CHUNK 16: Header.jsx excessive state and logging
**File:** `app/src/islands/shared/Header.jsx`
**Line:** 1-993
**Issue:** Header has 17 useState hooks and 30 console statements. Should extract auth logic to hook.
**Affected Pages:** All pages (global component)

**Current Code:**
```javascript
const [mobileMenuActive, setMobileMenuActive] = useState(false);
const [activeDropdown, setActiveDropdown] = useState(null);
const [headerVisible, setHeaderVisible] = useState(true);
// ... 14 more useState calls

console.log('[Header] Auth state changed:', event);
// ... 29 more console statements
```

**Refactored Code:**
```javascript
// Extract to useHeaderLogic.js
export function useHeaderLogic({ autoShowLogin = false }) {
  // All 17 state variables and their setters
  // All auth logic and effects
  // Return organized object
}

// Header.jsx becomes hollow component
import { useHeaderLogic } from './useHeaderLogic.js';

export default function Header({ autoShowLogin = false }) {
  const logic = useHeaderLogic({ autoShowLogin });
  return <HeaderUI {...logic} />;
}
```

**Testing:**
- [ ] Test login/logout flow
- [ ] Test suggested proposal popup
- [ ] Verify mobile menu functionality
- [ ] Test dropdown menus on all pages

**Cascading Changes Required:**
- Create: `app/src/islands/shared/Header/useHeaderLogic.js`
- Move: `app/src/islands/shared/Header.jsx` → `app/src/islands/shared/Header/Header.jsx`
- Update: `app/src/islands/shared/Header/index.js` for barrel export

~~~~~

### CHUNK 17: TODO comments indicating incomplete implementations
**File:** Multiple files
**Line:** Various
**Issue:** 13 TODO comments indicate unfinished work that may affect functionality.
**Affected Pages:** Multiple

**Current Code:**
```javascript
// app/src/islands/pages/HostProposalsPage/useHostProposalsPageLogic.js:686
// TODO: Navigate to messaging or open message modal

// app/src/islands/pages/HostProposalsPage/useHostProposalsPageLogic.js:777
// TODO: Call API to send rental app request notification to guest

// app/src/islands/pages/AccountProfilePage/useAccountProfilePageLogic.js:914
// TODO: Implement cover photo upload

// app/src/islands/modals/CompareTermsModal.jsx:60
// TODO: Implement proper backend API workflow scheduling in production
```

**Refactored Code:**
```javascript
// Each TODO should be addressed or converted to GitHub issue:

// 1. Create issues for each TODO with proper labels
// 2. Remove TODO comments after creating issues
// 3. Or implement the missing functionality

// Example for messaging TODO:
handleMessageHost: () => {
  // Navigate to messaging page with pre-selected thread
  const threadId = getOrCreateThread(proposalId);
  window.location.href = `/messaging?thread=${threadId}`;
}
```

**Testing:**
- [ ] Review each TODO for blocking issues
- [ ] Create GitHub issues for deferred work
- [ ] Implement critical missing functionality

~~~~~

### CHUNK 18: Map/filter chain efficiency
**File:** Multiple files (6 occurrences)
**Line:** Various
**Issue:** Using .map().filter() or .filter().map() when a single reduce would be more efficient.
**Affected Pages:** Multiple

**Current Code:**
```javascript
// Example from app/src/lib/proposals/userProposalQueries.js
const activeProposals = proposals
  .filter(p => p.Status !== 'Cancelled')
  .map(p => processProposalData(p));
```

**Refactored Code:**
```javascript
// Use reduce for single pass
const activeProposals = proposals.reduce((acc, p) => {
  if (p.Status !== 'Cancelled') {
    acc.push(processProposalData(p));
  }
  return acc;
}, []);

// Or use flatMap for simple cases
const activeProposals = proposals.flatMap(p =>
  p.Status !== 'Cancelled' ? [processProposalData(p)] : []
);
```

**Testing:**
- [ ] Verify proposal lists display correctly
- [ ] Performance test with large proposal lists

---

## PAGE GROUP: /host-proposals (Chunks: 19, 20)

~~~~~

### CHUNK 19: useHostProposalsPageLogic excessive logging
**File:** `app/src/islands/pages/HostProposalsPage/useHostProposalsPageLogic.js`
**Line:** Multiple (31 console statements)
**Issue:** 31 console statements in production hook.
**Affected Pages:** /host-proposals

**Current Code:**
```javascript
console.log('[useHostProposalsPageLogic] Fetching proposals...');
console.log('[useHostProposalsPageLogic] Proposals loaded:', proposals.length);
console.error('[useHostProposalsPageLogic] Error:', error);
```

**Refactored Code:**
```javascript
import { logger } from '../../../lib/logger.js';

// Use structured logger
logger.info('[HostProposals] Loaded proposals', { count: proposals.length });
logger.error('[HostProposals] Fetch failed', { error });

// Remove debug logs or gate
if (import.meta.env.DEV) {
  logger.debug('[HostProposals] Proposal details', { proposals });
}
```

**Testing:**
- [ ] Verify proposal list loads without console spam
- [ ] Check error handling still logs properly

~~~~~

### CHUNK 20: Incomplete TODO for messaging navigation
**File:** `app/src/islands/pages/HostProposalsPage/useHostProposalsPageLogic.js`
**Line:** 686
**Issue:** TODO comment for messaging navigation is incomplete.
**Affected Pages:** /host-proposals

**Current Code:**
```javascript
// TODO: Navigate to messaging or open message modal
const handleMessageGuest = () => {
  // No implementation
};
```

**Refactored Code:**
```javascript
const handleMessageGuest = useCallback((proposalId, guestId) => {
  // Navigate to messaging page with context
  const searchParams = new URLSearchParams({
    proposal: proposalId,
    with: guestId
  });
  window.location.href = `/messaging?${searchParams.toString()}`;
}, []);
```

**Testing:**
- [ ] Test message button navigates to correct thread
- [ ] Verify messaging page opens with correct context

---

## PAGE GROUP: /messaging (Chunks: 21)

~~~~~

### CHUNK 21: useMessagingPageLogic excessive logging
**File:** `app/src/islands/pages/MessagingPage/useMessagingPageLogic.js`
**Line:** Multiple (35 console statements)
**Issue:** 35 console statements in production hook.
**Affected Pages:** /messaging

**Current Code:**
```javascript
console.log('[MessagingPage] Loading threads...');
console.log('[MessagingPage] Message sent:', messageId);
console.error('[MessagingPage] Send failed:', error);
```

**Refactored Code:**
```javascript
import { logger } from '../../../lib/logger.js';

// Keep error logging
logger.error('[Messaging] Send failed', { error, threadId });

// Gate debug logs
if (import.meta.env.DEV) {
  logger.debug('[Messaging] Message sent', { messageId, threadId });
}
```

**Testing:**
- [ ] Verify messaging works without console spam
- [ ] Check real-time updates still function

---

## PAGE GROUP: /favorite-listings (Chunks: 22)

~~~~~

### CHUNK 22: FavoriteListingsPage excessive logging
**File:** `app/src/islands/pages/FavoriteListingsPage/FavoriteListingsPage.jsx`
**Line:** Multiple (30 console statements)
**Issue:** 30 console statements in production component with 11 inline styles.
**Affected Pages:** /favorite-listings

**Current Code:**
```javascript
console.log('[FavoriteListingsPage] Fetching favorites...');
console.log('[FavoriteListingsPage] Map view toggled');

<div style={{ display: 'flex', gap: '16px' }}>
```

**Refactored Code:**
```javascript
import { logger } from '../../../lib/logger.js';

// Remove debug logs, keep error logging only
logger.error('[FavoritesPage] Fetch failed', { error, userId });

// Move inline styles to CSS module
import styles from './FavoriteListingsPage.module.css';

<div className={styles.listContainer}>
```

**Testing:**
- [ ] Verify favorites list loads correctly
- [ ] Test map/list view toggle
- [ ] Check remove favorite functionality

---

## PAGE GROUP: /account-profile (Chunks: 23)

~~~~~

### CHUNK 23: useAccountProfilePageLogic excessive logging and TODO
**File:** `app/src/islands/pages/AccountProfilePage/useAccountProfilePageLogic.js`
**Line:** Multiple (23 console statements), Line 914 (TODO)
**Issue:** 23 console statements and incomplete cover photo upload TODO.
**Affected Pages:** /account-profile

**Current Code:**
```javascript
console.log('[AccountProfile] Loading user data...');
// ... 22 more

// TODO: Implement cover photo upload
const handleCoverPhotoUpload = () => {
  // Not implemented
};
```

**Refactored Code:**
```javascript
import { logger } from '../../../lib/logger.js';

// Gate debug logs
if (import.meta.env.DEV) {
  logger.debug('[AccountProfile] User data loaded', { userId });
}

// Implement cover photo upload
const handleCoverPhotoUpload = useCallback(async (file) => {
  const { data, error } = await uploadPhoto(file, 'cover-photos');
  if (error) {
    logger.error('[AccountProfile] Cover photo upload failed', { error });
    return { success: false, error };
  }
  await updateUserProfile({ coverPhotoUrl: data.url });
  return { success: true };
}, [updateUserProfile]);
```

**Testing:**
- [ ] Verify profile page loads without console spam
- [ ] Test cover photo upload (after implementation)

---

## PAGE GROUP: /preview-split-lease (Chunks: 24)

~~~~~

### CHUNK 24: PreviewSplitLeasePage excessive inline styles
**File:** `app/src/islands/pages/PreviewSplitLeasePage.jsx`
**Line:** Multiple (141 inline styles)
**Issue:** 141 inline style={{}} usages making maintenance difficult.
**Affected Pages:** /preview-split-lease

**Current Code:**
```javascript
<div style={{
  padding: '20px',
  backgroundColor: '#fff',
  borderRadius: '8px',
  boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
}}>
```

**Refactored Code:**
```javascript
// Extract to PreviewSplitLeasePage.css
.preview-card {
  padding: 20px;
  background-color: #fff;
  border-radius: 8px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

// In JSX
<div className="preview-card">
```

**Testing:**
- [ ] Verify visual appearance unchanged
- [ ] Check print/PDF generation still works

---

## PAGE GROUP: /rental-application (Chunks: 25)

~~~~~

### CHUNK 25: useRentalApplicationPageLogic excessive logging
**File:** `app/src/islands/pages/useRentalApplicationPageLogic.js`
**Line:** Multiple (35 console statements)
**Issue:** 35 console statements in production hook.
**Affected Pages:** /rental-application

**Current Code:**
```javascript
console.log('[RentalApplication] Step changed:', step);
console.log('[RentalApplication] Form data:', formData);
console.error('[RentalApplication] Submit failed:', error);
```

**Refactored Code:**
```javascript
import { logger } from '../../lib/logger.js';

// Only keep error logging for production issues
logger.error('[RentalApp] Submit failed', { error, step });

// Gate all debug logging
if (import.meta.env.DEV) {
  logger.debug('[RentalApp] Step changed', { step, formData });
}
```

**Testing:**
- [ ] Verify rental application wizard works
- [ ] Test form submission
- [ ] Check document upload functionality

---

## Summary by Priority

### P0 - Critical (Do First)
1. **CHUNK 14**: Rename duplicate processProposalData functions (naming collision risk)
2. **CHUNK 11**: Consolidate amenitiesService (clear duplication)
3. **CHUNK 12**: Consolidate neighborhoodService (clear duplication)

### P1 - High Priority
4. **CHUNK 15**: Consolidate suggestedProposalService
5. **CHUNK 1**: Extract SearchPage to hollow component pattern
6. **CHUNK 4**: Extract ViewSplitLeasePage to hollow component pattern
7. **CHUNK 16**: Extract Header logic to hook

### P2 - Medium Priority
8. **CHUNKS 2, 5, 13, 19, 21, 22, 23, 25**: Console logging cleanup (8 files with 30+ logs each)
9. **CHUNK 7**: Setup path aliases for deep imports
10. **CHUNK 17**: Address/track TODO comments

### P3 - Low Priority (Quality of Life)
11. **CHUNKS 6, 24**: Inline styles cleanup
12. **CHUNK 18**: Map/filter optimization
13. **CHUNK 3**: Migrate calculatePrice to logic/calculators

---

## File References

### Files to DELETE after consolidation:
- `app/src/islands/pages/SelfListingPage/utils/amenitiesService.ts`
- `app/src/islands/pages/SelfListingPage/utils/neighborhoodService.ts`
- `app/src/islands/shared/EditListingDetails/services/amenitiesService.js`
- `app/src/islands/shared/EditListingDetails/services/neighborhoodService.js`
- `app/src/islands/pages/CreateSuggestedProposalPage/suggestedProposalService.js`
- `app/src/islands/shared/SuggestedProposals/suggestedProposalService.js`

### Files to CREATE:
- `app/src/lib/services/amenitiesService.js`
- `app/src/lib/services/neighborhoodService.js`
- `app/src/lib/services/suggestedProposals/index.js`
- `app/src/lib/services/suggestedProposals/fetchService.js`
- `app/src/lib/services/suggestedProposals/actionService.js`
- `app/src/lib/services/suggestedProposals/searchService.js`
- `app/src/islands/pages/SearchPage/useSearchPageLogic.js`
- `app/src/islands/pages/ViewSplitLeasePage/useViewSplitLeasePageLogic.js`
- `app/src/islands/shared/Header/useHeaderLogic.js`

### Files requiring import updates after consolidation:
- `app/src/islands/pages/SelfListingPage/sections/Section2Features.tsx`
- `app/src/islands/pages/ListingDashboardPage/hooks/useAIImportAssistant.js`
- `app/src/islands/shared/EditListingDetails/useEditListingDetailsLogic.js`
- `app/src/islands/pages/CreateSuggestedProposalPage/useCreateSuggestedProposalLogic.js`
- `app/src/islands/pages/CreateSuggestedProposalPage/components/*.jsx` (5+ files)
- `app/src/islands/shared/Header.jsx`
- `app/src/islands/pages/proposals/ProposalCard.jsx`
- `app/src/islands/pages/proposals/ExpandableProposalCard.jsx`
- `app/src/islands/shared/SuggestedProposals/*.jsx` (5+ files)

---

## Execution Notes

1. **Test after each chunk** - Don't batch multiple chunks before testing
2. **Commit after each successful chunk** - Allows easy rollback
3. **Update imports incrementally** - Use IDE "Find Usages" before renaming
4. **Run `bun run build`** after each chunk to catch import errors
5. **Check `/search`, `/view-split-lease`, `/listing-dashboard`** after service consolidations - these are the most affected pages
