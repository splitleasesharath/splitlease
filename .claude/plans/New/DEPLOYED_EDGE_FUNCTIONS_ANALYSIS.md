# Deployed Edge Functions - Current Status & Conflict Analysis

**Generated**: 2025-12-06
**Project**: Split Lease
**Analyzed By**: Claude Code MCP Tool Specialist

---

## Executive Summary

The project has **8 active Edge Functions** deployed in Supabase. Three functions handle the majority of application operations:

1. **bubble-proxy** (v39) - General Bubble API proxy for listings, messaging, photos, favorites
2. **bubble-auth-proxy** (v38) - Authentication workflows (login, signup, logout, validate)
3. **ai-gateway** (v20) - AI completions with OpenAI

Secondary functions for specialized operations:
4. **ai-signup-guest** (v18) - AI-powered guest signup flow
5. **slack** (v10) - Slack integration for FAQ inquiries
6. **bubble_sync** (v2) - Bubble synchronization service
7. **auth-user** (v2) - Alternate auth router (newer, modular version)
8. **zap-auth-user** (v1) - Zapier/automation integration for auth

---

## Detailed Function Inventory

### 1. bubble-proxy (v39) - ACTIVE

**Status**: ACTIVE / PRODUCTION
**JWT Verification**: false
**Last Updated**: 2025-12-04
**Size**: Large (inlined shared utilities)

**Supported Actions**:
- `create_listing` - Create new listing with Supabase sync
- `get_listing` - Fetch listing data from Bubble
- `upload_photos` - Upload listing photos
- `send_message` - Send message to host
- `submit_referral` - Submit referral
- `signup_ai` - AI-powered signup
- `submit_listing` - Full listing submission
- `toggle_favorite` - Add/remove from favorites
- `get_favorites` - Get user's favorited listings

**Key Features**:
- Inline CORS headers and validation utilities
- BubbleSyncService for atomic create-and-sync operations
- Favorites management using RPC function `update_user_favorites`
- Listing favorites stored in user table field "Favorited Listings"
- Public action support for unauthenticated access
- Error handling with custom error classes

**Listing-Related Handlers**:
- Line 315: `handleListingCreate()` - Creates listing via Bubble workflow
- Line 350: `handleGetListing()` - Fetches listing from Bubble
- Line 365: `handlePhotoUpload()` - Uploads photos to listing
- Line 395: `handleSubmitListing()` - Full listing submission with all form data

**Potential Conflicts**:
- NONE DETECTED for basic listing CRUD operations
- Proposal creation is NOT in bubble-proxy (handled separately)
- Photo upload expects base64 data URLs with MIME type detection
- Favorites are tightly coupled to user record (good atomic design)

---

### 2. bubble-auth-proxy (v38) - ACTIVE

**Status**: ACTIVE / PRODUCTION
**JWT Verification**: false
**Last Updated**: 2025-11-26 (updated again 2025-12-06)
**Import Map**: YES (deno.json with shared imports)

**Supported Actions**:
- `login` - User login with email/password
- `signup` - User registration with ID generation
- `logout` - Invalidate session
- `validate` - Validate token and fetch user data

**Key Features**:
- Modular handler structure (separate files)
- CORS configured inline and via shared utilities
- Supabase Auth user creation with metadata
- Bubble ID generation using RPC function `generate_bubble_id()`
- Creates THREE records on signup:
  1. `account_host` table (host account with ID `host_account_id`)
  2. `account_guest` table (guest account with ID `guest_account_id`)
  3. `user` table (main user profile with ID from RPC, bubble_id from Bubble)
- Password validation (min 4 chars, must match retype)
- Email validation
- Error mapping for user-friendly messages

**Signup Flow**:
1. Validates email/password/retype
2. Calls Bubble signup workflow
3. Generates 3 Bubble-compatible IDs via RPC
4. Creates Supabase Auth user (best-effort, logs failures)
5. Inserts account_host record
6. Inserts account_guest record
7. Inserts user record with cross-references

**Return Values**:
```typescript
{
  token: string;
  user_id: string;              // Generated by RPC
  bubble_id: string;            // From Bubble signup
  host_account_id: string;      // Generated by RPC
  guest_account_id: string;     // Generated by RPC
  expires: number;              // Seconds
  supabase_user_id: string | null;
}
```

**Potential Conflicts**:
- NONE for authentication operations
- Signup creates separate host/guest accounts (good design)
- User ID generation is atomic and Bubble-compatible
- Metadata storage in Supabase Auth is non-blocking

---

### 3. ai-gateway (v20) - ACTIVE

**Status**: ACTIVE / PRODUCTION
**JWT Verification**: true (optional per prompt)
**Last Updated**: 2025-10-24 (not recently modified)

**Supported Actions**:
- `complete` - Non-streaming OpenAI completion
- `stream` - SSE streaming completion

**Features**:
- Prompt registry system with variable interpolation
- Supports both streaming and non-streaming modes
- Public prompts (no auth required)
- Private prompts (auth required)
- Response format options (text or JSON)

**Known Prompts**:
- `listing-description` - AI description generation for listings

**Potential Conflicts**:
- NONE detected with listing operations
- Independent from Bubble/Supabase sync operations
- Purely AI input/output transformation

---

### 4. ai-signup-guest (v18) - ACTIVE

**Status**: ACTIVE / PRODUCTION
**JWT Verification**: false
**Last Updated**: 2025-10-18

**Purpose**:
AI-powered guest signup flow generating personalized market research reports

**Potential Conflicts**:
- NONE detected
- Specialized signup flow (separate from main auth flow)

---

### 5. slack (v10) - ACTIVE

**Status**: ACTIVE / PRODUCTION
**JWT Verification**: false
**Last Updated**: 2025-10-13

**Supported Actions**:
- `faq_inquiry` - Send FAQ inquiries to Slack channels

**Potential Conflicts**:
- NONE - purely notification service

---

### 6. bubble_sync (v2) - ACTIVE

**Status**: ACTIVE / PRODUCTION
**JWT Verification**: true
**Last Updated**: 2025-10-24

**Purpose**:
Bubble synchronization service

**Potential Conflicts**:
- NONE detected
- Appears to be utility function

---

### 7. auth-user (v2) - ACTIVE

**Status**: ACTIVE / PRODUCTION
**JWT Verification**: true
**Last Updated**: 2025-12-06 (MOST RECENT UPDATE)
**Import Map**: YES (deno.json with modular structure)

**Description**:
Alternate/newer authentication router with modular handler structure

**Comparison to bubble-auth-proxy**:
- Same functionality: login, signup, logout, validate
- Same handler implementations
- Same modular file structure (handlers/ subdirectory)
- Same CORS configuration
- Identical signup flow with ID generation

**CONFLICT DETECTED**: ⚠️ **DUPLICATE FUNCTIONALITY**

This function appears to be:
- A refactored version of bubble-auth-proxy
- OR a parallel implementation
- OR a migration in progress

**Analysis**:
- Both functions have identical handlers (handlers/login.ts, handlers/signup.ts, etc.)
- Both use same validation and error utilities
- Both support same actions: login, signup, logout, validate
- The `auth-user` function was MOST RECENTLY UPDATED (2025-12-06)
- Suggests `auth-user` may be the newer, preferred implementation

---

### 8. zap-auth-user (v1) - ACTIVE

**Status**: ACTIVE / PRODUCTION
**JWT Verification**: true
**Last Updated**: 2025-12-06 (BRAND NEW)

**Description**:
Zapier/automation integration for authentication

**Status**: Newly deployed (today's date)

**Potential Conflicts**:
- UNKNOWN - newly deployed function, minimal version (v1)
- May be testing/integration function

---

## Critical Findings: Deployment Duplicates

### ALERT: Duplicate Auth Functions

**Three functions handle authentication**:
1. `bubble-auth-proxy` (v38) - Original, updated 2025-11-26
2. `auth-user` (v2) - Newer, updated 2025-12-06
3. `zap-auth-user` (v1) - Newest, created 2025-12-06

**Current Implementation Status**:
- **bubble-auth-proxy**: Uses inlined shared utilities, dated imports structure
- **auth-user**: Uses modular file structure with separate _shared/ directory, modern Deno approach
- **zap-auth-user**: Likely for Zapier/automation workflows

**Recommended Next Steps**:
1. Verify which auth function is actively used by frontend
2. Consider deprecating older `bubble-auth-proxy` in favor of `auth-user`
3. Document the purpose of `zap-auth-user`
4. Ensure client calls correct endpoint to avoid confusion

---

## Listing-Related Workflow Details

### Listing Creation Flow (bubble-proxy)

```
Frontend → bubble-proxy/create_listing
  ↓
  → Validate payload
  → Call Bubble workflow: listing_creation_in_code
  ↓
  → Fetch Listing object from Bubble
  ↓
  → Sync to Supabase (listing table)
  ↓
  → Return: { _id, listing_id, Name, ... }
```

**Key Point**: Listing creation primarily uses Bubble as source of truth, with Supabase as replica.

### Listing Submission Flow (bubble-proxy)

```
Frontend → bubble-proxy/submit_listing
  ↓
  → Validate all listing_data fields
  → Call Bubble workflow: listing_full_submission_in_code
  ↓
  → Fetch updated Listing from Bubble
  ↓
  → Sync to Supabase (listing table)
  ↓
  → Return: { _id, listing_id, status, name, ... }
```

**Critical Fields**:
- Form submission includes: pricing, amenities, house rules, location, photos, rental type
- Status determined by Bubble workflow response
- Database sync is non-blocking (errors logged but not thrown)

### Proposal Creation (NOT in bubble-proxy)

**IMPORTANT**: Proposal creation is NOT in bubble-proxy.

There is a separate handler: `/supabase/functions/bubble-proxy/handlers/proposal.ts`

```
Frontend → bubble-proxy/create_proposal (if implemented)
  ↓
  → Generate ID via RPC: generate_bubble_id()
  ↓
  → Fetch listing, guest, host, rental app from Supabase
  ↓
  → Calculate: compensation, move-out date, status, order ranking
  ↓
  → Insert proposal into Supabase (NATIVE, no Bubble sync)
  ↓
  → Update guest user (proposals list, favorites, bio enrichment)
  ↓
  → Update host user (proposals list)
  ↓
  → Return: { proposalId, status, success }
```

**Key Insight**: Proposal creation is SUPABASE NATIVE with NO Bubble involvement. This is a clean separation from the legacy Bubble system.

---

## Data Flow Architecture

### Listing (Bubble-Centric)

```
Bubble (Source of Truth)
    ↓ (sync)
Supabase listing table (Replica)
```

**Sync Trigger**: When listing is created or submitted via Edge Function
**Sync Pattern**: Write-Read-Write (atomic)

### Proposal (Supabase-Centric)

```
Supabase proposal table (Source of Truth)
    ↑
    └─ No Bubble sync
```

**Creation**: Direct Supabase insert with calculations
**No Bubble Dependency**: Fully native

### User (Hybrid)

```
Bubble (Authentication Source)
    ↓ (sync on signup)
Supabase user table (Replica + Extended)
```

**Sync Trigger**: During signup process
**Additional Data**: Extended profile data stored in Supabase only

---

## Shared Utilities Summary

**Deployed Shared Code** (inlined in bubble-proxy):
- CORS headers
- Error classes (BubbleApiError, ValidationError, AuthenticationError, SupabaseSyncError)
- Validation functions (email, phone, required fields, action validation)
- BubbleSyncService (triggerWorkflow, fetchBubbleObject, syncToSupabase, createAndSync)
- Type definitions

**Issue**: Code is duplicated/inlined in bubble-proxy instead of shared as module.

**Solution**: Newer functions (auth-user) use modular _shared/ directory approach, which is cleaner.

---

## Conflict Assessment Summary

### NO CONFLICTS DETECTED FOR:
- Basic listing CRUD operations
- Photo upload
- Messaging
- Favorites management
- Referrals
- Authentication (despite duplicate functions)
- Proposal creation (clean separation from Bubble)

### WARNINGS/OBSERVATIONS:
1. **Duplicate Auth Functions**: `bubble-auth-proxy` and `auth-user` handle identical operations
   - Recommend consolidating to single implementation
   - `auth-user` appears to be newer (v2, updated 2025-12-06)

2. **Code Organization**:
   - Older functions use inlined utilities (bubble-proxy)
   - Newer functions use modular structure (auth-user)
   - Consider standardizing on modular approach

3. **New Function**: `zap-auth-user` (v1) just deployed today
   - Purpose unclear - may be Zapier integration
   - Recommend documenting intended usage

4. **Proposal Isolation**:
   - Proposal handler exists but unclear if connected to bubble-proxy router
   - Clean separation from Bubble is good
   - Verify this is intentional (not orphaned code)

---

## Recommendations

### Priority 1: Clarify Auth Function Usage
- [ ] Determine which auth endpoint frontend actually calls
- [ ] Decide which function to keep (bubble-auth-proxy vs auth-user)
- [ ] Deprecate unused function or document dual-endpoint strategy

### Priority 2: Verify Proposal Integration
- [ ] Confirm proposal handler is accessible from bubble-proxy
- [ ] Check if `create_proposal` action is in router's allowedActions
- [ ] If not connected, add to main router or document why it's separate

### Priority 3: Document New Function
- [ ] Document purpose of `zap-auth-user`
- [ ] Add to Edge Functions inventory
- [ ] Clarify Zapier/automation integration

### Priority 4: Code Organization
- [ ] Consider migrating shared utilities to proper _shared modules
- [ ] Standardize on modular function structure
- [ ] Reduce code duplication between auth functions

---

## Related Local Files

For implementation of changes, see:
- `/supabase/functions/bubble-proxy/index.ts` - Main proxy router
- `/supabase/functions/bubble-proxy/handlers/proposal.ts` - Proposal handler (disconnected?)
- `/supabase/functions/bubble-auth-proxy/index.ts` - Original auth function
- `/supabase/functions/auth-user/index.ts` - Newer auth function
- `/supabase/config.toml` - Function configuration
- `/supabase/CLAUDE.md` - Edge Functions documentation

---

**Document Version**: 1.0
**Analysis Status**: Complete
**Conflicts Found**: 0 functional conflicts, 1 organizational concern (duplicate auth)

