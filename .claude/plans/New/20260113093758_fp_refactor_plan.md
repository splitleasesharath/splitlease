# Functional Programming Refactoring Plan

Date: 2026-01-13
Target: agents/20260113093758_fp_audit_violations.json
Severity Filter: all

## Summary

| Violation Type | Count | Severity |
|----------------|-------|----------|
| EXCEPTION_FOR_FLOW | 31 (unique) | Medium |
| IMPERATIVE_LOOP | 7 | Medium/High |
| MUTATING_METHOD | 3 | High |
| IO_IN_CORE | 4 | High |

**Total Unique Violations**: 45 (deduplicated from 78 raw entries)

## Files by Violation Count

| File | Violations |
|------|------------|
| workflows/proposals/virtualMeetingWorkflow.js | 5 |
| workflows/proposals/counterofferWorkflow.js | 3 |
| rules/scheduling/isScheduleContiguous.js | 4 |
| processors/listing/extractListingCoordinates.js | 3 |
| calculators/scheduling/calculateCheckInOutDays.js | 3 |

---

## Phase 1: High-Severity (Mutations and I/O)

### CHUNK 1: Replace push() mutation in isScheduleContiguous.js:95-96

**File:** app/src/logic/rules/scheduling/isScheduleContiguous.js
**Line:** 95-96
**Violation:** MUTATING_METHOD + IMPERATIVE_LOOP
**Severity:** High
**Expected Affected Pages:** /search, /view-split-lease, /proposal-form

**Current Code:**
const expectedNotSelected = []
for (let i = minNotSelected; i <= maxNotSelected; i++) {
  expectedNotSelected.push(i)
}

**Refactored Code:**
const expectedNotSelected = Array.from(
  { length: maxNotSelected - minNotSelected + 1 },
  (_, i) => minNotSelected + i
)

**Testing:**
- Run unit tests for isScheduleContiguous
- Test wrap-around cases

---

### CHUNK 2: Replace [...].sort() with toSorted() in calculateCheckInOutDays.js:50

**File:** app/src/logic/calculators/scheduling/calculateCheckInOutDays.js
**Line:** 50
**Violation:** MUTATING_METHOD
**Severity:** High
**Expected Affected Pages:** /search, /view-split-lease, /proposal-form

**Current Code:**
const sorted = [...selectedDays].sort((a, b) => a - b)

**Refactored Code:**
const sorted = selectedDays.toSorted((a, b) => a - b)

**Testing:**
- Verify sorted array is correct
- Confirm original array unchanged

---

### CHUNK 3: Replace [...].sort() with toSorted() in calculateNextAvailableCheckIn.js:54

**File:** app/src/logic/calculators/scheduling/calculateNextAvailableCheckIn.js
**Line:** 54
**Violation:** MUTATING_METHOD
**Severity:** High
**Expected Affected Pages:** /search, /view-split-lease, /proposal-form

**Current Code:**
const sortedDays = [...selectedDayIndices].sort((a, b) => a - b)

**Refactored Code:**
const sortedDays = selectedDayIndices.toSorted((a, b) => a - b)

**Testing:**
- Verify sorted days are correct
- Test next check-in calculation

---

### CHUNK 4: Remove console.error I/O from extractListingCoordinates.js:46

**File:** app/src/logic/processors/listing/extractListingCoordinates.js
**Line:** 46
**Violation:** IO_IN_CORE
**Severity:** High
**Expected Affected Pages:** /search, /view-split-lease

**Current Code:**
catch (error) {
  console.error(...)
  parsedSlightlyDifferent = null
}

**Refactored Code:**
catch {
  parsedSlightlyDifferent = null
}

**Testing:**
- Test with invalid JSON strings
- Confirm no console output

---

### CHUNK 5: Remove console.warn I/O from processUserData.js:58

**File:** app/src/logic/processors/user/processUserData.js
**Line:** 58
**Violation:** IO_IN_CORE
**Severity:** High
**Expected Affected Pages:** /guest-proposals, /host-proposals, /profile

**Current Code:**
fullName = 'Guest User'
console.warn(...)

**Refactored Code:**
fullName = 'Guest User'

**Testing:**
- Test with user missing all name fields
- Confirm no console output

---

## Phase 2: Medium-Severity (Imperative Loops)

### CHUNK 6: Replace imperative validation loop in isScheduleContiguous.js:46

**File:** app/src/logic/rules/scheduling/isScheduleContiguous.js
**Line:** 46
**Violation:** IMPERATIVE_LOOP
**Severity:** Medium

**Current Code:**
for (const day of selectedDayIndices) {
  if (typeof day !== 'number' || isNaN(day) || day < 0 || day > 6) {
    throw new Error(...)
  }
}

**Refactored Code:**
const isValidDay = (day) => typeof day === 'number' && !isNaN(day) && day >= 0 && day <= 6
const invalidDay = selectedDayIndices.find(day => !isValidDay(day))
if (invalidDay !== undefined) {
  throw new Error(...)
}

---

### CHUNK 7: Replace imperative gap-check loop in isScheduleContiguous.js:64

**File:** app/src/logic/rules/scheduling/isScheduleContiguous.js
**Line:** 64
**Violation:** IMPERATIVE_LOOP
**Severity:** High

**Current Code:**
let isStandardContiguous = true
for (let i = 1; i < sorted.length; i++) {
  if (sorted[i] !== sorted[i - 1] + 1) {
    isStandardContiguous = false
    break
  }
}

**Refactored Code:**
const isStandardContiguous = sorted.slice(1).every((day, i) => day === sorted[i] + 1)

---

## Files Reference

| Path | Purpose |
|------|---------|
| app/src/logic/calculators/scheduling/calculateCheckInOutDays.js | Check-in/out day calculation |
| app/src/logic/calculators/scheduling/calculateNextAvailableCheckIn.js | Next check-in date |
| app/src/logic/rules/scheduling/isScheduleContiguous.js | Contiguous schedule validation |
| app/src/logic/processors/listing/extractListingCoordinates.js | Coordinate extraction |
| app/src/logic/processors/user/processUserData.js | User data processing |

---

## Phase 3: Exception Flow (Deferred to Separate Implementation)

The following violations involve replacing throw statements with Result types. These require coordinated changes to callers and are documented here for future implementation:

### Workflow Files (15+ violations)
- workflows/booking/acceptProposalWorkflow.js:34-42
- workflows/booking/cancelProposalWorkflow.js:46-54
- workflows/booking/loadProposalDetailsWorkflow.js:49-53
- workflows/proposals/counterofferWorkflow.js:31, 88, 125
- workflows/proposals/virtualMeetingWorkflow.js:26, 81, 109, 142, 175
- workflows/proposals/cancelProposalWorkflow.js:97, 154

### Processor Files (10+ violations)
- processors/display/formatHostName.js:33
- processors/proposal/processProposalData.js:39
- processors/proposals/processProposalData.js:20, 24, 135, 139, 297
- processors/user/processUserData.js:33
- processors/user/processUserDisplayName.js:27
- processors/user/processUserInitials.js:25

### Rule Files (5 violations)
- rules/proposals/determineProposalStage.js:29
- rules/search/hasListingPhotos.js:23
- rules/users/shouldShowFullName.js:24, 29

---

## Implementation Notes

### Pattern for Declarative Day Validation
Extract to shared helper after implementing chunks 1, 4, 7, 9:

export function validateDayIndices(days, callerName) {
  const isValidDay = (day) => typeof day === 'number' && !isNaN(day) && day >= 0 && day <= 6
  const invalidDay = days.find(day => !isValidDay(day))
  if (invalidDay !== undefined) {
    throw new Error()
  }
}

### Pattern for Declarative Contiguity Check
Replace imperative for loop with every():

const isContiguous = sorted.slice(1).every((day, i) => day === sorted[i] + 1)

### Pattern for Declarative Range Generation
Replace push() with Array.from():

const range = Array.from({ length: end - start + 1 }, (_, i) => start + i)

---

## Execution Sequence

1. Phase 1 (High Severity): CHUNKs 1-5 - Mutations and I/O
2. Phase 2 (Medium Severity): CHUNKs 6-7 - Imperative loops
3. Extract shared dayValidation.js helper
4. Phase 3 (Deferred): Exception flow refactoring
