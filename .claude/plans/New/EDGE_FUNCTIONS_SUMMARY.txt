EDGE FUNCTIONS DEPLOYMENT ANALYSIS - SUMMARY REPORT
Generated: 2025-12-06

================================================================================
OVERVIEW
================================================================================

Project has 8 active Edge Functions deployed in Supabase.
Three functions handle the majority of operations:
  1. bubble-proxy (v39) - Listings, messaging, favorites
  2. bubble-auth-proxy (v38) - Authentication
  3. ai-gateway (v20) - AI completions

Status: PRODUCTION READY with minor organizational concerns.

================================================================================
LISTING-RELATED OPERATIONS
================================================================================

All listing operations are in bubble-proxy function (v39):

SUPPORTED ACTIONS:
  create_listing       - Create new listing with Bubble + Supabase sync
  get_listing         - Fetch listing from Bubble
  upload_photos       - Upload listing photos to Bubble
  submit_listing      - Full listing submission with all form data
  toggle_favorite     - Add/remove listing from favorites
  get_favorites       - Get user's favorited listings
  send_message        - Send message to host (listing-related)

CONFLICT STATUS: NO CONFLICTS DETECTED

All operations use atomic Write-Read-Write pattern:
  1. Create/Update in Bubble (source of truth)
  2. Fetch full object from Bubble API
  3. Sync to Supabase (replica)
  4. Return response to client

Database Tables Involved:
  - listing (main table, synced from Bubble)
  - user (favorites stored in "Favorited Listings" field)

================================================================================
PROPOSAL OPERATIONS
================================================================================

Proposal creation has a separate handler: bubble-proxy/handlers/proposal.ts

KEY INSIGHT: Proposals use SUPABASE-NATIVE approach (no Bubble involved)

HANDLER LOGIC:
  1. Generate Bubble-compatible ID via RPC function
  2. Fetch listing, guest, host from Supabase
  3. Perform calculations (compensation, dates, status)
  4. Insert proposal directly into Supabase
  5. Update guest user record (proposals list, favorites, bio)
  6. Update host user record (proposals list)
  7. Return proposalId and status

CONCERN: Handler exists but unclear if it's connected to main router
  - Not visible in quick scan of router's allowedActions array
  - Recommend verifying connection or documenting reason for separation

================================================================================
AUTHENTICATION STATUS
================================================================================

DUPLICATE FUNCTIONS DETECTED:

Three functions provide identical auth functionality:

1. bubble-auth-proxy (v38, updated 2025-11-26)
   - Original implementation
   - Uses inlined shared utilities
   - Supports: login, signup, logout, validate

2. auth-user (v2, updated 2025-12-06)
   - Newer implementation
   - Modular file structure with _shared/ directory
   - Identical handlers (handlers/login.ts, handlers/signup.ts, etc.)
   - Same functionality as bubble-auth-proxy
   - MOST RECENTLY UPDATED (today)

3. zap-auth-user (v1, created 2025-12-06)
   - Brand new (just deployed today)
   - Likely for Zapier/automation integration
   - Purpose unclear

RECOMMENDATION: Consolidate to single implementation
  - auth-user appears to be newer/preferred version
  - bubble-auth-proxy may be legacy and should be deprecated
  - Clarify purpose of zap-auth-user
  - Update frontend to use consistent endpoint

SIGNUP FLOW (both bubble-auth-proxy and auth-user):
  1. Validate email/password/retype
  2. Call Bubble signup workflow
  3. Generate 3 Bubble-compatible IDs via RPC:
     - user_id (for user table)
     - host_account_id (for account_host table)
     - guest_account_id (for account_guest table)
  4. Create Supabase Auth user (best-effort, logs failures)
  5. Insert account_host record
  6. Insert account_guest record
  7. Insert user profile
  8. Return token + all generated IDs

================================================================================
CODE ORGANIZATION ISSUES
================================================================================

INCONSISTENT PATTERNS:

Pattern 1 (bubble-proxy): INLINED UTILITIES
  - All shared code embedded in index.ts
  - Utilities (cors, errors, validation) copied into main file
  - Makes file large and hard to maintain
  - Code duplication with other functions

Pattern 2 (auth-user): MODULAR STRUCTURE
  - Separate _shared/ directory for utilities
  - Handlers in handlers/ subdirectory
  - Clean imports from modular files
  - Better organization and less duplication
  - Modern Deno approach

RECOMMENDATION: Standardize on Pattern 2 (modular)
  - Create proper _shared/ utilities library
  - Refactor bubble-proxy to use modular imports
  - Update other functions to follow same pattern

================================================================================
NO CONFLICTS FOUND FOR:
================================================================================

✓ Basic listing CRUD operations (create, get, update)
✓ Photo upload
✓ Messaging (contact host)
✓ Favorites management
✓ Referrals submission
✓ AI signup flow
✓ Proposal creation (clean Supabase-native approach)
✓ Authentication (despite duplicate functions, each works independently)

================================================================================
FILES CREATED IN IMPLEMENTATION/PENDING:
================================================================================

1. DEPLOYED_EDGE_FUNCTIONS_ANALYSIS.md
   - Detailed analysis of each function
   - Full code review findings
   - Conflict assessment
   - Related file references

2. EDGE_FUNCTIONS_QUICK_REFERENCE.txt
   - Quick lookup tables
   - Status of all operations
   - Data flow diagrams
   - Testing checklist
   - Environment secrets

3. EDGE_FUNCTIONS_SUMMARY.txt (this file)
   - Executive summary
   - Key findings
   - Recommendations

================================================================================
ACTION ITEMS
================================================================================

CRITICAL (address before deploying):
  [ ] Verify proposal handler is connected to bubble-proxy router
      Location: /supabase/functions/bubble-proxy/index.ts
      Check: allowedActions array includes 'create_proposal'
      If missing: Add to allowedActions and switch statement

  [ ] Clarify duplicate auth functions
      Check: Which endpoint does frontend call?
      Option 1: Keep bubble-auth-proxy, deprecate auth-user
      Option 2: Keep auth-user, deprecate bubble-auth-proxy
      Option 3: Document purpose of both endpoints

MEDIUM (address in next sprint):
  [ ] Document zap-auth-user purpose (new function deployed today)
      Location: /supabase/functions/zap-auth-user/
      Action: Add to CLAUDE.md Edge Functions documentation

  [ ] Standardize code organization
      Pattern to use: Modular with _shared/ directory (from auth-user)
      Start with: Refactor bubble-proxy to use modular utilities

  [ ] Reduce code duplication
      Action: Extract shared utilities to proper _shared/ library
      Refactor: bubble-proxy to import from _shared/

================================================================================
DEPLOYMENT CHECKLIST
================================================================================

Before deploying any listing-related changes:

VERIFICATION:
  [ ] All listing handlers are present in bubble-proxy
      - handleListingCreate
      - handleGetListing
      - handlePhotoUpload
      - handleSubmitListing
      - handleFavorites
      - handleGetFavorites
      - handleSendMessage

  [ ] Proposal handler is connected
      - Check allowedActions array
      - Check switch statement in router
      - Test create_proposal action

  [ ] All required secrets are configured
      - BUBBLE_API_BASE_URL
      - BUBBLE_API_KEY
      - SUPABASE_SERVICE_ROLE_KEY

TESTING:
  [ ] Test create_listing with valid payload
  [ ] Test get_listing with valid ID
  [ ] Test upload_photos with base64 images
  [ ] Test submit_listing with complete form data
  [ ] Test toggle_favorite (add and remove)
  [ ] Test get_favorites with pagination
  [ ] Test proposal creation (if action is connected)
  [ ] Verify Supabase sync occurs after Bubble operations
  [ ] Verify error messages are user-friendly

MONITORING:
  [ ] Set up logging alerts for Bubble API failures
  [ ] Monitor proposal creation errors (calculation failures)
  [ ] Track Supabase sync latency
  [ ] Monitor favorites updates for race conditions

================================================================================
RELATED DOCUMENTATION
================================================================================

Generated Analysis Files:
  - DEPLOYED_EDGE_FUNCTIONS_ANALYSIS.md (detailed)
  - EDGE_FUNCTIONS_QUICK_REFERENCE.txt (lookup)
  - EDGE_FUNCTIONS_SUMMARY.txt (this file)

Project Documentation:
  - /supabase/CLAUDE.md (Edge Functions guide)
  - /CLAUDE.md (Project overview)
  - /app/CLAUDE.md (Frontend guide)

Configuration:
  - /supabase/config.toml (function definitions)

Source Code:
  - /supabase/functions/bubble-proxy/ (main proxy)
  - /supabase/functions/bubble-auth-proxy/ (original auth)
  - /supabase/functions/auth-user/ (newer auth)

================================================================================

ANALYSIS COMPLETE
Last Updated: 2025-12-06
Status: READY FOR REVIEW
Critical Issues Found: 2
  1. Proposal handler connection status unclear
  2. Duplicate auth functions need consolidation

Recommendation: Address critical issues before major deployment

