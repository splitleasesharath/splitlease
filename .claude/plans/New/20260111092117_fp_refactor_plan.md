# Functional Programming Refactoring Plan

Date: 2026-01-11
Target: agents/fp_audit_violations.json
Severity Filter: high

## Summary

**Total Violations:** 350
**Files Affected:** 84

### By Type
- MUTATING_METHOD: 265 (75.7%)
- IMPERATIVE_LOOP: 80 (22.9%)
- IO_IN_CORE: 5 (1.4%)

### Top Files by Violation Count
1. `src/islands/pages/SelfListingPage/store/listingLocalStore.ts` - 21 violations
2. `src/lib/availabilityValidation.js` - 16 violations
3. `src/islands/pages/SelfListingPage/store/prepareListingSubmission.ts` - 15 violations
4. `src/islands/shared/LoggedInAvatar/LoggedInAvatar.jsx` - 12 violations
5. `src/islands/pages/ListingDashboardPage/components/AvailabilitySection.jsx` - 11 violations

---

~~~~~

## ðŸ”´ CHUNK 1: Replace for-of loop with reduce in vite.config.js:32

**File:** app/vite.config.js
**Line:** 32
**Violation:** IMPERATIVE_LOOP - Using for-of loop to build object
**Severity:** ðŸ”´ High

**Affected Pages:** N/A (build config)

**Current Code:**
```javascript
for (const route of routes) {
  inputs[route.name] = resolve(__dirname, route.file);
}
```

**Refactored Code:**
```javascript
const inputs = routes.reduce((acc, route) => ({
  ...acc,
  [route.name]: resolve(__dirname, route.file)
}), {});
```

**Why This Matters:**
Imperative loops with mutation obscure the transformation intent. `reduce` clearly shows we're building an object from an array.

**Testing:**
- [ ] Run `bun run build` to verify Vite config works
- [ ] Verify all routes are included in the build output

~~~~~

## ðŸ”´ CHUNK 2: Replace nested for-of with flatMap in vite.config.js:56

**File:** app/vite.config.js
**Line:** 56
**Violation:** IMPERATIVE_LOOP - Nested loop building array
**Severity:** ðŸ”´ High

**Affected Pages:** N/A (build config)

**Current Code:**
```javascript
for (const alias of route.aliases) {
  // alias processing
}
```

**Refactored Code:**
```javascript
const aliasInputs = routes
  .filter(route => route.aliases?.length > 0)
  .flatMap(route => route.aliases.map(alias => ({
    name: alias,
    file: resolve(__dirname, route.file)
  })));
```

**Why This Matters:**
`flatMap` elegantly handles the one-to-many relationship between routes and aliases.

**Testing:**
- [ ] Run `bun run build`
- [ ] Verify alias routes resolve correctly

~~~~~

## ðŸ”´ CHUNK 3: Replace for-of with reduce in vite.config.js:82

**File:** app/vite.config.js
**Line:** 82
**Violation:** IMPERATIVE_LOOP - Building object with for-of
**Severity:** ðŸ”´ High

**Affected Pages:** N/A (build config)

**Current Code:**
```javascript
for (const entry of entries) {
  // entry processing
}
```

**Refactored Code:**
```javascript
const processedEntries = entries.reduce((acc, entry) => ({
  ...acc,
  [entry.key]: entry.value
}), {});
```

**Why This Matters:**
Declarative transformations make the data flow explicit and easier to test.

**Testing:**
- [ ] Run `bun run build`
- [ ] Verify entry points are correct

~~~~~

## ðŸ”´ CHUNK 4: Replace for-of with reduce in vite.config.js:181

**File:** app/vite.config.js
**Line:** 181
**Violation:** IMPERATIVE_LOOP - Building redirects array
**Severity:** ðŸ”´ High

**Affected Pages:** N/A (build config)

**Current Code:**
```javascript
for (const route of internalRoutes) {
  // redirect processing
}
```

**Refactored Code:**
```javascript
const redirects = internalRoutes.map(route => ({
  from: route.path,
  to: route.target
}));
```

**Why This Matters:**
`map` clearly expresses a 1:1 transformation of routes to redirects.

**Testing:**
- [ ] Run `bun run generate-routes`
- [ ] Verify _redirects file is generated correctly

~~~~~

## ðŸ”´ CHUNK 5: Replace validation loop with flatMap in generate-redirects.js:144

**File:** app/scripts/generate-redirects.js
**Line:** 144
**Violation:** IMPERATIVE_LOOP - Validation loop with push
**Severity:** ðŸ”´ High

**Affected Pages:** N/A (build script)

**Current Code:**
```javascript
for (const route of routes) {
  if (seenPaths.has(route.path)) {
    errors.push(`Duplicate path: ${route.path}`);
  }
  // more validation...
}
```

**Refactored Code:**
```javascript
const errors = routes.flatMap(route => {
  const routeErrors = [];
  if (seenPaths.has(route.path)) {
    return [`Duplicate path: ${route.path}`];
  }
  if (!route.path) {
    return ['Route missing path'];
  }
  if (!route.file) {
    return [`Route ${route.path} missing file`];
  }
  if (route.cloudflareInternal && !route.internalName) {
    return [`Route ${route.path} has cloudflareInternal but no internalName`];
  }
  return [];
});
```

**Why This Matters:**
Using `flatMap` for validation collects all errors declaratively without mutation.

**Testing:**
- [ ] Run `bun run generate-routes`
- [ ] Test with invalid route config to verify errors are collected

~~~~~

## ðŸ”´ CHUNK 6-9: Remove push mutations in generate-redirects.js:147,153,156,161

**File:** app/scripts/generate-redirects.js
**Lines:** 147, 153, 156, 161
**Violation:** MUTATING_METHOD - Multiple errors.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** N/A (build script)

**Current Code:**
```javascript
errors.push(`Duplicate path: ${route.path}`);
errors.push(`Route missing path`);
errors.push(`Route ${route.path} missing file`);
errors.push(`Route ${route.path} has cloudflareInternal but no internalName`);
```

**Refactored Code:**
(Covered by CHUNK 5 refactoring - consolidated into flatMap)

**Why This Matters:**
Multiple push calls are eliminated by the declarative flatMap approach.

**Testing:**
- [ ] Covered by CHUNK 5 testing

~~~~~

## ðŸ”´ CHUNK 10: Replace push with spread in routes.config.js:380

**File:** app/src/routes.config.js
**Line:** 380
**Violation:** MUTATING_METHOD - Using push to add items
**Severity:** ðŸ”´ High

**Affected Pages:** N/A (route config)

**Current Code:**
```javascript
excludedFromFunctions.push('/guest-proposals', '/guest-proposals/*');
```

**Refactored Code:**
```javascript
const excludedFromFunctions = [
  ...baseExcludedFromFunctions,
  '/guest-proposals',
  '/guest-proposals/*'
];
```

**Why This Matters:**
Declaring all values upfront makes the configuration explicit and immutable.

**Testing:**
- [ ] Run `bun run generate-routes`
- [ ] Verify _routes.json excludes the correct paths

~~~~~

## ðŸ”´ CHUNK 11: Replace push with flatMap in helpCenterData.js:280

**File:** app/src/data/helpCenterData.js
**Line:** 280
**Violation:** MUTATING_METHOD - Building results array with push
**Severity:** ðŸ”´ High

**Affected Pages:** /help-center, /faq

**Current Code:**
```javascript
results.push({
  // result object
});
```

**Refactored Code:**
```javascript
const results = searchableItems
  .filter(item => matchesSearchQuery(item, query))
  .map(item => ({
    id: item.id,
    title: item.title,
    // ...other fields
  }));
```

**Why This Matters:**
Filter + map is the idiomatic FP pattern for searching and transforming data.

**Testing:**
- [ ] Test help center search functionality
- [ ] Verify search results display correctly

~~~~~

## ðŸ”´ CHUNK 12: Sorting already uses spread - verify pattern in aiService.js:106

**File:** app/src/lib/aiService.js
**Line:** 106
**Violation:** MUTATING_METHOD - sort() flagged but already using spread
**Severity:** ðŸ”´ High (False positive - verify)

**Affected Pages:** /search, /view-split-lease

**Current Code:**
```javascript
return [...amenities].sort((a, b) => {
  // sorting logic
});
```

**Refactored Code:**
```javascript
// Already correct! Using spread before sort.
// Optionally use toSorted() for modern JS:
return amenities.toSorted((a, b) => {
  // sorting logic
});
```

**Why This Matters:**
`[...arr].sort()` is acceptable but `toSorted()` is more explicit about immutability.

**Testing:**
- [ ] Verify amenities display in correct order on listing pages

~~~~~

## ðŸ”´ CHUNK 13-14: Replace while loops in auth.js:563,786

**File:** app/src/lib/auth.js
**Lines:** 563, 786
**Violation:** IMPERATIVE_LOOP - While loop for retry logic
**Severity:** ðŸ”´ High

**Affected Pages:** All authenticated pages

**Current Code:**
```javascript
while (verifyAttempts < maxVerifyAttempts) {
  // verification logic
  verifyAttempts++;
}
```

**Refactored Code:**
```javascript
// Retry logic is acceptable as imperative - it's inherently stateful I/O
// However, extract to a reusable utility:
const retryWithBackoff = async (fn, maxAttempts, delayMs) => {
  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    try {
      return await fn();
    } catch (error) {
      if (attempt === maxAttempts - 1) throw error;
      await new Promise(r => setTimeout(r, delayMs * Math.pow(2, attempt)));
    }
  }
};

// Usage:
const result = await retryWithBackoff(verifySession, maxVerifyAttempts, 100);
```

**Why This Matters:**
While loops for I/O retry are acceptable at the imperative shell, but should be extracted to utilities.

**Testing:**
- [ ] Test login flow with network interruptions
- [ ] Verify retry behavior works correctly

~~~~~

## ðŸ”´ CHUNK 15: Replace spread+sort with toSorted in availabilityValidation.js:31

**File:** app/src/lib/availabilityValidation.js
**Line:** 31
**Violation:** MUTATING_METHOD - sort() on spread array
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /search, /guest-proposals

**Current Code:**
```javascript
const sorted = [...selectedDays].sort((a, b) => a - b);
```

**Refactored Code:**
```javascript
const sorted = selectedDays.toSorted((a, b) => a - b);
```

**Why This Matters:**
`toSorted()` is the modern immutable alternative - more explicit and cleaner.

**Testing:**
- [ ] Test schedule selection on view-split-lease page
- [ ] Verify contiguous validation works correctly

~~~~~

## ðŸ”´ CHUNK 16: Replace for loop with every/some in availabilityValidation.js:38

**File:** app/src/lib/availabilityValidation.js
**Line:** 38
**Violation:** IMPERATIVE_LOOP - Checking consecutive sequence
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /search, /guest-proposals

**Current Code:**
```javascript
let isStandardContiguous = true;
for (let i = 1; i < sorted.length; i++) {
  if (sorted[i] !== sorted[i - 1] + 1) {
    isStandardContiguous = false;
    break;
  }
}
```

**Refactored Code:**
```javascript
const isStandardContiguous = sorted.every((day, i) =>
  i === 0 || day === sorted[i - 1] + 1
);
```

**Why This Matters:**
`every()` expresses "all elements satisfy condition" more clearly than a loop with early break.

**Testing:**
- [ ] Test contiguous selection: [1,2,3,4,5] should be true
- [ ] Test non-contiguous: [1,3,5] should be false

~~~~~

## ðŸ”´ CHUNK 17-18: Replace range loop with Array.from in availabilityValidation.js:65-66

**File:** app/src/lib/availabilityValidation.js
**Lines:** 65-66
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Building range array
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /search, /guest-proposals

**Current Code:**
```javascript
const expectedNotSelected = [];
for (let i = minNotSelected; i <= maxNotSelected; i++) {
  expectedNotSelected.push(i);
}
```

**Refactored Code:**
```javascript
const expectedNotSelected = Array.from(
  { length: maxNotSelected - minNotSelected + 1 },
  (_, i) => minNotSelected + i
);
```

**Why This Matters:**
`Array.from` with a mapper is the FP pattern for generating ranges.

**Testing:**
- [ ] Test wrap-around selection: [5,6,0] should be contiguous
- [ ] Verify inverse logic works correctly

~~~~~

## ðŸ”´ CHUNK 19: Replace spread+sort with toSorted in availabilityValidation.js:97

**File:** app/src/lib/availabilityValidation.js
**Line:** 97
**Violation:** MUTATING_METHOD - sort() on spread array
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /search, /guest-proposals

**Current Code:**
```javascript
const sorted = [...selectedDays].sort((a, b) => a - b);
```

**Refactored Code:**
```javascript
const sorted = selectedDays.toSorted((a, b) => a - b);
```

**Why This Matters:**
Consistent use of `toSorted()` across the codebase.

**Testing:**
- [ ] Test calculateCheckInOutDays function
- [ ] Verify check-in/check-out calculation is correct

~~~~~

## ðŸ”´ CHUNK 20: Replace for loop with every in availabilityValidation.js:106

**File:** app/src/lib/availabilityValidation.js
**Line:** 106
**Violation:** IMPERATIVE_LOOP - Gap detection loop
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /search, /guest-proposals

**Current Code:**
```javascript
for (let i = 1; i < sorted.length; i++) {
  if (sorted[i] !== sorted[i - 1] + 1) {
    gapIndex = i;
    break;
  }
}
```

**Refactored Code:**
```javascript
const gapIndex = sorted.findIndex((day, i) =>
  i > 0 && day !== sorted[i - 1] + 1
);
```

**Why This Matters:**
`findIndex` is the declarative way to find the first element matching a condition.

**Testing:**
- [ ] Test wrap-around scenarios
- [ ] Verify gap detection works for [5,6,0,1]

~~~~~

## ðŸ”´ CHUNK 21-30: Replace error push calls with declarative error collection in availabilityValidation.js

**File:** app/src/lib/availabilityValidation.js
**Lines:** 166, 175, 181, 186, 199, 271, 280, 287, 294, 305
**Violation:** MUTATING_METHOD - Multiple result.errors.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /search, /guest-proposals

**Current Code:**
```javascript
result.errors.push('Please select at least one day');
result.errors.push('Please check for contiguous nights...');
result.warnings.push(`Host prefers at least ${listing['Minimum Nights']} nights...`);
// etc.
```

**Refactored Code:**
```javascript
// Refactor validateScheduleSelection to use declarative error collection:
export function validateScheduleSelection(selectedDays, listing) {
  const errors = [
    !selectedDays?.length && 'Please select at least one day',
    !isContiguousSelection(selectedDays) && 'Please check for contiguous nights to continue with your proposal',
    hasUnavailableDaysSelected(selectedDays, listing) && 'Some selected days are not available for this listing',
  ].filter(Boolean);

  const warnings = [
    listing['Minimum Nights'] && selectedDays.length < listing['Minimum Nights'] &&
      `Host prefers at least ${listing['Minimum Nights']} nights per week`,
    listing['Maximum Nights'] && selectedDays.length > listing['Maximum Nights'] &&
      `Host prefers at most ${listing['Maximum Nights']} nights per week`,
  ].filter(Boolean);

  return {
    valid: errors.length === 0,
    errors,
    warnings,
    showTutorial: !isContiguousSelection(selectedDays),
    nightsCount: selectedDays?.length || 0,
    isContiguous: isContiguousSelection(selectedDays)
  };
}
```

**Why This Matters:**
Declarative error collection shows all possible errors upfront and eliminates mutation.

**Testing:**
- [ ] Test all validation scenarios
- [ ] Verify error messages display correctly
- [ ] Test minimum/maximum nights warnings

~~~~~

## ðŸ”´ CHUNK 31-35: Replace push with filter+map in dataLookups.js

**File:** app/src/lib/dataLookups.js
**Lines:** 562, 592, 598, 609, 615
**Violation:** MUTATING_METHOD - Building arrays with push and sorting
**Severity:** ðŸ”´ High

**Affected Pages:** /host-proposals, /guest-proposals, /view-split-lease

**Current Code:**
```javascript
const policies = [];
for (const [id, policy] of Object.entries(policiesMap)) {
  policies.push({ id, display: policy.display });
}
return policies;
```

**Refactored Code:**
```javascript
const policies = Object.entries(policiesMap)
  .map(([id, policy]) => ({ id, display: policy.display }));

// For sorted versions:
const reasons = Object.entries(reasonsMap)
  .filter(([_, reason]) => reason.active)
  .map(([id, reason]) => ({ id, ...reason }))
  .toSorted((a, b) => a.displayOrder - b.displayOrder);
```

**Why This Matters:**
`Object.entries` + `map` is the standard FP pattern for transforming objects to arrays.

**Testing:**
- [ ] Verify cancellation policies display correctly
- [ ] Verify decline reasons are sorted properly

~~~~~

## ðŸ”´ CHUNK 36: Skip hotjar.js - third-party script pattern

**File:** app/src/lib/hotjar.js
**Line:** 18
**Violation:** MUTATING_METHOD - Hotjar SDK pattern
**Severity:** ðŸ”´ High (Skip - third-party)

**Affected Pages:** All pages with analytics

**Current Code:**
```javascript
h.hj=h.hj||function(){(h.hj.q=h.hj.q||[]).push(arguments)};
```

**Refactored Code:**
```javascript
// SKIP: This is the official Hotjar SDK initialization pattern.
// Third-party analytics scripts should not be modified.
```

**Why This Matters:**
Third-party SDK patterns should be left as-is to maintain compatibility.

**Testing:**
- [ ] N/A - Skip this violation

~~~~~

## ðŸ”´ CHUNK 37: Replace sort with toSorted in listingDataFetcher.js:201

**File:** app/src/lib/listingDataFetcher.js
**Line:** 201
**Violation:** MUTATING_METHOD - Reassigning sorted result
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /listing-dashboard, /search

**Current Code:**
```javascript
sortedPhotos = sortedPhotos.sort((a, b) => {
  // sorting logic
});
```

**Refactored Code:**
```javascript
const sortedPhotos = photos.toSorted((a, b) => {
  // sorting logic
});
```

**Why This Matters:**
Avoid reassignment; use `toSorted()` to create a new sorted array.

**Testing:**
- [ ] Verify photos display in correct order
- [ ] Check cover photo is first

~~~~~

## ðŸ”´ CHUNK 38: Replace push with spread in listingService.js:335

**File:** app/src/lib/listingService.js
**Line:** 335
**Violation:** MUTATING_METHOD - Adding to listings array
**Severity:** ðŸ”´ High

**Affected Pages:** /host-overview, /listing-dashboard

**Current Code:**
```javascript
currentListings.push(listingId);
```

**Refactored Code:**
```javascript
const updatedListings = [...currentListings, listingId];
```

**Why This Matters:**
Spread operator creates a new array instead of mutating the original.

**Testing:**
- [ ] Test adding new listing to host's listings
- [ ] Verify listing count updates correctly

~~~~~

## ðŸ”´ CHUNK 39-44: Replace loops with map/filter in listingService.js

**File:** app/src/lib/listingService.js
**Lines:** 766, 768, 982, 1076, 1078, 1082, 1240
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Multiple loop/push patterns
**Severity:** ðŸ”´ High

**Affected Pages:** /host-overview, /listing-dashboard, /self-listing

**Current Code:**
```javascript
for (const day of dayOrder) {
  if (availableNights[day]) {
    result.push(dayNameMapping[day]);
  }
}
```

**Refactored Code:**
```javascript
const result = dayOrder
  .filter(day => availableNights[day])
  .map(day => dayNameMapping[day]);
```

**Why This Matters:**
Filter + map chain clearly separates selection from transformation.

**Testing:**
- [ ] Verify available nights display correctly
- [ ] Test day name mapping

~~~~~

## ðŸ”´ CHUNK 45-52: Replace binary data loops in photoUpload.js

**File:** app/src/lib/photoUpload.js
**Lines:** 28, 32, 36, 86, 164, 170, 184
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Binary data processing
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing, /listing-dashboard

**Current Code:**
```javascript
for (let offset = 0; offset < byteCharacters.length; offset += 512) {
  const slice = byteCharacters.slice(offset, offset + 512);
  const byteNumbers = new Array(slice.length);
  for (let i = 0; i < slice.length; i++) {
    byteNumbers[i] = slice.charCodeAt(i);
  }
  byteArrays.push(new Uint8Array(byteNumbers));
}
```

**Refactored Code:**
```javascript
// Binary processing loops are acceptable - performance critical
// However, can use Array.from for inner conversion:
const chunkSize = 512;
const byteArrays = Array.from(
  { length: Math.ceil(byteCharacters.length / chunkSize) },
  (_, i) => {
    const slice = byteCharacters.slice(i * chunkSize, (i + 1) * chunkSize);
    return new Uint8Array(Array.from(slice, char => char.charCodeAt(0)));
  }
);
```

**Why This Matters:**
`Array.from` can replace some binary loops while maintaining readability.

**Testing:**
- [ ] Test photo upload functionality
- [ ] Verify base64 to blob conversion works
- [ ] Test with various image sizes

~~~~~

## ðŸ”´ CHUNK 53-54: Replace localStorage loop in secureStorage.js:233-236

**File:** app/src/lib/secureStorage.js
**Lines:** 233, 236
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Iterating localStorage
**Severity:** ðŸ”´ High

**Affected Pages:** All pages (storage utility)

**Current Code:**
```javascript
for (let i = 0; i < localStorage.length; i++) {
  const key = localStorage.key(i);
  if (key?.startsWith(prefix)) {
    keysToRemove.push(key);
  }
}
```

**Refactored Code:**
```javascript
const keysToRemove = Array.from(
  { length: localStorage.length },
  (_, i) => localStorage.key(i)
).filter(key => key?.startsWith(prefix));
```

**Why This Matters:**
`Array.from` with filter is cleaner than loop with push.

**Testing:**
- [ ] Test clearing prefixed storage keys
- [ ] Verify only matching keys are removed

~~~~~

## ðŸ”´ CHUNK 55-62: Replace photo URL building loops in supabaseUtils.js

**File:** app/src/lib/supabaseUtils.js
**Lines:** 178, 189, 203, 210, 258, 260, 269, 274
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Building photo URLs array
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /search, /listing-dashboard

**Current Code:**
```javascript
for (const photo of photos) {
  const photoUrl = getPhotoUrl(photo);
  if (photoUrl) {
    photoUrls.push(photoUrl);
  }
}
```

**Refactored Code:**
```javascript
const photoUrls = photos
  .map(photo => getPhotoUrl(photo))
  .filter(Boolean);
```

**Why This Matters:**
Map + filter is the standard pattern for transform-and-select operations.

**Testing:**
- [ ] Verify photo URLs are generated correctly
- [ ] Test with null/undefined photos in array

~~~~~

## ðŸ”´ CHUNK 63: Skip while loop in workflowClient.js:139 - I/O polling

**File:** app/src/lib/workflowClient.js
**Line:** 139
**Violation:** IMPERATIVE_LOOP - Polling loop
**Severity:** ðŸ”´ High (Skip - I/O boundary)

**Affected Pages:** /host-proposals, /guest-proposals

**Current Code:**
```javascript
while (Date.now() - startTime < timeout) {
  // polling logic
}
```

**Refactored Code:**
```javascript
// SKIP: Polling loops are acceptable at I/O boundaries.
// This is the "imperative shell" - I/O coordination is inherently imperative.
```

**Why This Matters:**
Polling/retry loops at I/O boundaries are acceptable in FP architecture.

**Testing:**
- [ ] N/A - Skip this violation

~~~~~

## ðŸ”´ CHUNK 64: Remove console.warn from proposalRules.js:306

**File:** app/src/logic/rules/proposals/proposalRules.js
**Line:** 306
**Violation:** IO_IN_CORE - Console output in rules layer
**Severity:** ðŸ”´ High

**Affected Pages:** /host-proposals, /guest-proposals

**Current Code:**
```javascript
console.warn('[getCancellationReasonOptions] Cache empty, using fallback values');
```

**Refactored Code:**
```javascript
// Remove console.warn - rules should be pure
// If logging is needed, return a result object with warnings:
return {
  options: fallbackOptions,
  warnings: ['Cache empty, using fallback values']
};
```

**Why This Matters:**
Rules layer must be pure - no I/O including console output.

**Testing:**
- [ ] Verify cancellation options work without console output
- [ ] Check caller handles warnings if needed

~~~~~

## ðŸ”´ CHUNK 65-68: Replace loops in isScheduleContiguous.js

**File:** app/src/logic/rules/scheduling/isScheduleContiguous.js
**Lines:** 55, 64, 95, 96
**Violation:** MUTATING_METHOD + IMPERATIVE_LOOP - Sorting and range building
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /search, /guest-proposals

**Current Code:**
```javascript
const sorted = [...selectedDayIndices].sort((a, b) => a - b);

for (let i = 1; i < sorted.length; i++) {
  if (sorted[i] !== sorted[i - 1] + 1) {
    isStandardContiguous = false;
    break;
  }
}

for (let i = minNotSelected; i <= maxNotSelected; i++) {
  expectedNotSelected.push(i);
}
```

**Refactored Code:**
```javascript
const sorted = selectedDayIndices.toSorted((a, b) => a - b);

const isStandardContiguous = sorted.every((day, i) =>
  i === 0 || day === sorted[i - 1] + 1
);

const expectedNotSelected = Array.from(
  { length: maxNotSelected - minNotSelected + 1 },
  (_, i) => minNotSelected + i
);
```

**Why This Matters:**
`toSorted`, `every`, and `Array.from` are the FP equivalents of these patterns.

**Testing:**
- [ ] Test all contiguous scenarios
- [ ] Verify wrap-around logic works

~~~~~

## ðŸ”´ CHUNK 69-72: Remove console calls from extractListingCoordinates.js

**File:** app/src/logic/processors/listing/extractListingCoordinates.js
**Lines:** 46, 62, 98
**Violation:** IO_IN_CORE - Console in processor layer
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease

**Current Code:**
```javascript
console.error('extractListingCoordinates: Failed to parse Location');
console.warn('extractListingCoordinates: No valid coordinates found');
```

**Refactored Code:**
```javascript
// Return result with error information instead of logging:
return {
  coordinates: null,
  error: 'Failed to parse Location - Address',
  warning: null
};

// Or use Result type:
return err('Failed to parse Location - Address');
```

**Why This Matters:**
Processors must be pure - return errors as values, not side effects.

**Testing:**
- [ ] Verify coordinate extraction handles errors gracefully
- [ ] Check map displays correctly with invalid data

~~~~~

## ðŸ”´ CHUNK 73: Remove console.warn from processUserData.js:58

**File:** app/src/logic/processors/user/processUserData.js
**Line:** 58
**Violation:** IO_IN_CORE - Console in processor layer
**Severity:** ðŸ”´ High

**Affected Pages:** All authenticated pages

**Current Code:**
```javascript
console.warn(`processUserData: User ${rawUser._id} has no name fields, using default`);
```

**Refactored Code:**
```javascript
// Return result with metadata instead of logging:
return {
  user: { ...processedUser, name: 'User' },
  usedDefault: true,
  defaultReason: 'No name fields provided'
};
```

**Why This Matters:**
Processors must be pure - communicate issues through return values.

**Testing:**
- [ ] Verify user display with missing name
- [ ] Check default name handling

~~~~~

## ðŸ”´ CHUNK 74-75: Replace sort in calculateCheckInOutDays.js

**File:** app/src/logic/calculators/scheduling/calculateCheckInOutDays.js
**Lines:** 50, 59
**Violation:** MUTATING_METHOD + IMPERATIVE_LOOP - Sort and gap detection
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /guest-proposals

**Current Code:**
```javascript
const sorted = [...selectedDays].sort((a, b) => a - b);
for (let i = 1; i < sorted.length; i++) {
  // gap detection
}
```

**Refactored Code:**
```javascript
const sorted = selectedDays.toSorted((a, b) => a - b);
const gapIndex = sorted.findIndex((day, i) =>
  i > 0 && day !== sorted[i - 1] + 1
);
```

**Why This Matters:**
Calculators should use declarative patterns for maximum testability.

**Testing:**
- [ ] Test check-in/check-out calculation
- [ ] Verify wrap-around scenarios

~~~~~

## ðŸ”´ CHUNK 76: Replace sort in calculateNextAvailableCheckIn.js:54

**File:** app/src/logic/calculators/scheduling/calculateNextAvailableCheckIn.js
**Line:** 54
**Violation:** MUTATING_METHOD - sort() on spread array
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /guest-proposals

**Current Code:**
```javascript
const sortedDays = [...selectedDayIndices].sort((a, b) => a - b);
```

**Refactored Code:**
```javascript
const sortedDays = selectedDayIndices.toSorted((a, b) => a - b);
```

**Why This Matters:**
Consistent use of `toSorted()` in calculators.

**Testing:**
- [ ] Verify next check-in date calculation
- [ ] Test with various day selections

~~~~~

## ðŸ”´ CHUNK 77: Replace push in userProposalQueries.js:225

**File:** app/src/lib/proposals/userProposalQueries.js
**Line:** 225
**Violation:** MUTATING_METHOD - Building array with push
**Severity:** ðŸ”´ High

**Affected Pages:** /guest-proposals

**Current Code:**
```javascript
listingsNeedingPhotoFetch.push(listing._id);
```

**Refactored Code:**
```javascript
const listingsNeedingPhotoFetch = listings
  .filter(listing => needsPhotoFetch(listing))
  .map(listing => listing._id);
```

**Why This Matters:**
Filter + map is cleaner than conditional push in loop.

**Testing:**
- [ ] Verify listings with missing photos are fetched
- [ ] Check proposal cards display photos

~~~~~

## ðŸ”´ CHUNK 78-80: Replace sort/loop in scheduleSelector/dayHelpers.js

**File:** app/src/lib/scheduleSelector/dayHelpers.js
**Lines:** 44, 112, 113
**Violation:** MUTATING_METHOD + IMPERATIVE_LOOP - Sort and night building
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /search

**Current Code:**
```javascript
return [...days].sort((a, b) => a.dayOfWeek - b.dayOfWeek);

for (let i = 0; i < sortedDays.length - 1; i++) {
  nights.push(createNight(sortedDays[i].dayOfWeek));
}
```

**Refactored Code:**
```javascript
return days.toSorted((a, b) => a.dayOfWeek - b.dayOfWeek);

const nights = sortedDays
  .slice(0, -1)
  .map(day => createNight(day.dayOfWeek));
```

**Why This Matters:**
`slice(0, -1)` elegantly handles "all but last" without index manipulation.

**Testing:**
- [ ] Verify night calculation from days
- [ ] Test edge cases with single day

~~~~~

## ðŸ”´ CHUNK 81-85: Replace loops in scheduleSelector files

**File:** app/src/lib/scheduleSelector/nightCalculations.js + validators.js
**Lines:** 14, 15, 50, 101, 102, 114
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Multiple loop patterns
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /search

**Current Code:**
```javascript
for (let i = 0; i < sorted.length - 1; i++) {
  nights.push(createNight(sorted[i].dayOfWeek));
}

for (let i = minNotSelected; i <= maxNotSelected; i++) {
  expectedNotSelected.push(i);
}
```

**Refactored Code:**
```javascript
const nights = sorted
  .slice(0, -1)
  .map(item => createNight(item.dayOfWeek));

const expectedNotSelected = Array.from(
  { length: maxNotSelected - minNotSelected + 1 },
  (_, i) => minNotSelected + i
);
```

**Why This Matters:**
Consistent patterns across related utility files.

**Testing:**
- [ ] Verify night calculations
- [ ] Test contiguous validation in validators

~~~~~

## ðŸ”´ CHUNK 86: Replace push in useEmailSmsUnitPageLogic.js:229

**File:** app/src/islands/pages/useEmailSmsUnitPageLogic.js
**Line:** 229
**Violation:** MUTATING_METHOD - Adding to emails array
**Severity:** ðŸ”´ High

**Affected Pages:** /email-sms-unit

**Current Code:**
```javascript
emails.push('');
```

**Refactored Code:**
```javascript
setEmails(prev => [...prev, '']);
```

**Why This Matters:**
React state updates should always create new arrays.

**Testing:**
- [ ] Test adding email input field
- [ ] Verify state updates correctly

~~~~~

## ðŸ”´ CHUNK 87-88: Replace push in useSearchPageLogic.js:148-149

**File:** app/src/islands/pages/useSearchPageLogic.js
**Lines:** 148, 149
**Violation:** MUTATING_METHOD - Building location parts
**Severity:** ðŸ”´ High

**Affected Pages:** /search

**Current Code:**
```javascript
if (neighborhoodName) locationParts.push(neighborhoodName);
if (boroughName) locationParts.push(boroughName);
```

**Refactored Code:**
```javascript
const locationParts = [neighborhoodName, boroughName].filter(Boolean);
```

**Why This Matters:**
Declarative array with filter is cleaner than conditional pushes.

**Testing:**
- [ ] Verify location display on search page
- [ ] Test with/without neighborhood and borough

~~~~~

## ðŸ”´ CHUNK 89-95: Replace push patterns in useEditListingDetailsLogic.js

**File:** app/src/islands/shared/EditListingDetails/useEditListingDetailsLogic.js
**Lines:** 267, 268, 269, 528, 833, 837, 946
**Violation:** MUTATING_METHOD + IMPERATIVE_LOOP - Multiple patterns
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard

**Current Code:**
```javascript
if (city) parts.push(city);
if (state) parts.push(state);
if (zip) parts.push(zip);

for (const [key, value] of Object.entries(formData)) {
  // processing
}

for (let i = 0; i < files.length; i++) {
  uploadedUrls.push(result.url);
}

updated.unshift(selectedPhoto);
```

**Refactored Code:**
```javascript
const parts = [city, state, zip].filter(Boolean);

const processedData = Object.fromEntries(
  Object.entries(formData).map(([key, value]) => [key, processValue(value)])
);

const uploadedUrls = await Promise.all(
  Array.from(files).map(async file => {
    const result = await uploadFile(file);
    return result.url;
  })
);

const updated = [selectedPhoto, ...prev.filter(p => p.id !== selectedPhoto.id)];
```

**Why This Matters:**
Multiple FP patterns applied: filter(Boolean), Object.fromEntries, Promise.all with map.

**Testing:**
- [ ] Test address part building
- [ ] Verify photo upload and reordering
- [ ] Test form data processing

~~~~~

## ðŸ”´ CHUNK 96-105: Replace sort/push in HostScheduleSelector files

**File:** app/src/islands/shared/HostScheduleSelector/*.js
**Lines:** Various (25, 29, 31, 59, 60, 64, 65, 133, etc.)
**Violation:** MUTATING_METHOD + IMPERATIVE_LOOP - Schedule selector patterns
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard, /self-listing

**Current Code:**
```javascript
.sort((a, b) => a - b)

for (let i = startIdx; i <= endIdx; i++) {
  sequence.push(getNightByDayIndex(i).id);
}

return [...nights].sort((a, b) => { ... });
```

**Refactored Code:**
```javascript
.toSorted((a, b) => a - b)

const sequence = Array.from(
  { length: endIdx - startIdx + 1 },
  (_, i) => getNightByDayIndex(startIdx + i).id
);

return nights.toSorted((a, b) => { ... });
```

**Why This Matters:**
Schedule selector is a core component - FP patterns improve maintainability.

**Testing:**
- [ ] Test night selection in host schedule selector
- [ ] Verify sequence generation
- [ ] Test sorting in all directions

~~~~~

## ðŸ”´ CHUNK 106: Replace push in notificationCategories.js:122

**File:** app/src/islands/shared/NotificationSettingsIsland/notificationCategories.js
**Line:** 122
**Violation:** MUTATING_METHOD - Building channels array
**Severity:** ðŸ”´ High

**Affected Pages:** /account-profile (notifications section)

**Current Code:**
```javascript
arr.push(channel);
```

**Refactored Code:**
```javascript
const channels = availableChannels
  .filter(channel => isChannelEnabled(channel, settings))
  .map(channel => ({ ...channel, enabled: true }));
```

**Why This Matters:**
Filter + map clearly separates selection from transformation.

**Testing:**
- [ ] Verify notification channels display
- [ ] Test enabling/disabling channels

~~~~~

## ðŸ”´ CHUNK 107-108: Replace loop/push in RentalApplicationWizardModal

**File:** app/src/islands/shared/RentalApplicationWizardModal/useRentalApplicationWizardLogic.js
**Lines:** 267, 269
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Step completion tracking
**Severity:** ðŸ”´ High

**Affected Pages:** /rental-application, /account-profile

**Current Code:**
```javascript
for (let step = 1; step <= TOTAL_STEPS; step++) {
  if (isStepComplete(step)) {
    newCompleted.push(step);
  }
}
```

**Refactored Code:**
```javascript
const completedSteps = Array.from(
  { length: TOTAL_STEPS },
  (_, i) => i + 1
).filter(step => isStepComplete(step));
```

**Why This Matters:**
Generate range then filter is cleaner than conditional push in loop.

**Testing:**
- [ ] Verify step completion tracking
- [ ] Test wizard navigation

~~~~~

## ðŸ”´ CHUNK 109-113: Replace loops in ScheduleCohost/cohostService.js

**File:** app/src/islands/shared/ScheduleCohost/cohostService.js
**Lines:** 40, 43, 61, 62, 66
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Date/time slot generation
**Severity:** ðŸ”´ High

**Affected Pages:** /schedule-cohost

**Current Code:**
```javascript
for (let i = 0; i < totalDays; i++) {
  const date = addDays(startDate, i);
  days.push(date);
}

for (let hour = startHour; hour < endHour; hour++) {
  for (let minutes = 0; minutes < 60; minutes += intervalMinutes) {
    slots.push({ hour, minutes, ... });
  }
}
```

**Refactored Code:**
```javascript
const days = Array.from(
  { length: totalDays },
  (_, i) => addDays(startDate, i)
);

const slots = Array.from(
  { length: (endHour - startHour) * (60 / intervalMinutes) },
  (_, i) => {
    const totalMinutes = i * intervalMinutes;
    const hour = startHour + Math.floor(totalMinutes / 60);
    const minutes = totalMinutes % 60;
    return { hour, minutes, ... };
  }
);
```

**Why This Matters:**
Time slot generation is a pure transformation - ideal for `Array.from`.

**Testing:**
- [ ] Verify date range generation
- [ ] Test time slot generation with various intervals

~~~~~

## ðŸ”´ CHUNK 114: Replace push in suggestedProposalService.js:89

**File:** app/src/islands/shared/SuggestedProposals/suggestedProposalService.js
**Line:** 89
**Violation:** MUTATING_METHOD - Building summary map
**Severity:** ðŸ”´ High

**Affected Pages:** /proposals-suggested

**Current Code:**
```javascript
summaryMap[proposalId].push(summary);
```

**Refactored Code:**
```javascript
// Use reduce to build the map immutably:
const summaryMap = proposals.reduce((acc, proposal) => ({
  ...acc,
  [proposal.id]: [...(acc[proposal.id] || []), proposal.summary]
}), {});
```

**Why This Matters:**
Reduce with spread creates immutable accumulation pattern.

**Testing:**
- [ ] Verify proposal summaries are grouped correctly
- [ ] Test with multiple proposals per ID

~~~~~

## ðŸ”´ CHUNK 115-121: Replace loops in VirtualMeetingManager/dateUtils.js

**File:** app/src/islands/shared/VirtualMeetingManager/dateUtils.js
**Lines:** 71, 72, 75, 95, 96, 100, 101
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Calendar/slot generation
**Severity:** ðŸ”´ High

**Affected Pages:** /virtual-meetings, /guest-proposals, /host-proposals

**Current Code:**
```javascript
for (let hour = startHour; hour < endHour; hour++) {
  for (let minute = 0; minute < 60; minute += interval) {
    slots.push(slotTime);
  }
}

for (let i = 0; i < startingDayOfWeek; i++) {
  days.push(null);
}

for (let day = 1; day <= daysInMonth; day++) {
  days.push(new Date(year, month, day));
}
```

**Refactored Code:**
```javascript
const slots = Array.from(
  { length: (endHour - startHour) * (60 / interval) },
  (_, i) => {
    const minutes = i * interval;
    return new Date(date.setHours(
      startHour + Math.floor(minutes / 60),
      minutes % 60
    ));
  }
);

const calendarDays = [
  ...Array(startingDayOfWeek).fill(null),
  ...Array.from(
    { length: daysInMonth },
    (_, i) => new Date(year, month, i + 1)
  )
];
```

**Why This Matters:**
Calendar generation is a classic FP use case - pure data transformation.

**Testing:**
- [ ] Verify time slot generation
- [ ] Test calendar grid generation
- [ ] Check padding days are correct

~~~~~

## ðŸ”´ CHUNK 122: Skip retry loop in virtualMeetingService.js:312 - I/O boundary

**File:** app/src/islands/shared/VirtualMeetingManager/virtualMeetingService.js
**Line:** 312
**Violation:** IMPERATIVE_LOOP - Retry loop
**Severity:** ðŸ”´ High (Skip - I/O)

**Current Code:**
```javascript
for (let attempt = 0; attempt < maxRetries; attempt++) {
  // retry logic
}
```

**Refactored Code:**
```javascript
// SKIP: Retry loops at I/O boundaries are acceptable.
// Consider extracting to shared retry utility if pattern repeats.
```

**Testing:**
- [ ] N/A - Skip this violation

~~~~~

## ðŸ”´ CHUNK 123-131: Replace push in LoggedInAvatar/getMenuItems

**File:** app/src/islands/shared/LoggedInAvatar/LoggedInAvatar.jsx
**Lines:** 174, 186, 201, 217, 234, 248, 262, 276, 288, 301, 313, 323
**Violation:** MUTATING_METHOD - Building menu items array
**Severity:** ðŸ”´ High

**Affected Pages:** All authenticated pages (header component)

**Current Code:**
```javascript
const getMenuItems = () => {
  const items = [];

  if (menuVisibility.myProfile) {
    items.push({
      id: 'profile',
      label: 'My Profile',
      // ...
    });
  }

  if (menuVisibility.myProposals) {
    items.push({ /* ... */ });
  }
  // ... more conditional pushes

  return items;
};
```

**Refactored Code:**
```javascript
const getMenuItems = () => {
  const menuItemConfigs = [
    {
      id: 'profile',
      label: 'My Profile',
      icon: '/assets/icons/user-purple.svg',
      path: `/account-profile/${user.id}`,
      visible: menuVisibility.myProfile,
    },
    {
      id: 'proposals',
      label: 'My Proposals',
      icon: '/assets/icons/file-text-purple.svg',
      path: effectiveUserType === NORMALIZED_USER_TYPES.GUEST
        ? '/guest-proposals'
        : '/host-proposals',
      badgeCount: effectiveProposalsCount,
      badgeColor: 'purple',
      visible: menuVisibility.myProposals,
    },
    {
      id: 'proposals-suggested',
      label: 'Proposals Suggested',
      icon: '/assets/icons/file-text-purple.svg',
      path: '/proposals-suggested',
      visible: menuVisibility.myProposalsSuggested,
    },
    // ... all other menu items with visible flag
  ];

  return menuItemConfigs.filter(item => item.visible);
};
```

**Why This Matters:**
Declarative config with filter is much cleaner than conditional pushes. All menu items are visible in one place.

**Testing:**
- [ ] Test menu rendering for all user types
- [ ] Verify conditional visibility works
- [ ] Check badge counts display

~~~~~

## ðŸ”´ CHUNK 132-236: Replace className push patterns (BATCH)

**Files:** Multiple component files
**Pattern:** `classes.push('classname')` repeated across many UI components
**Violation:** MUTATING_METHOD - Building className arrays
**Severity:** ðŸ”´ High

**Affected Files:**
- HostEditingProposal/ScheduleSelector.jsx (119-121)
- HostScheduleSelector/HostScheduleSelector.jsx (248-316)
- HostScheduleSelector/SimpleHostScheduleSelector.jsx (145, 149)
- ScheduleCohost/ScheduleCohost.jsx (709-713)
- VirtualMeetingManager/BookTimeSlot.jsx (155, 159)

**Current Code:**
```javascript
const classes = ['base-class'];
if (isSelected) classes.push('selected');
if (!isAvailable) classes.push('unavailable');
if (disabled) classes.push('disabled');
return classes.join(' ');
```

**Refactored Code:**
```javascript
const className = [
  'base-class',
  isSelected && 'selected',
  !isAvailable && 'unavailable',
  disabled && 'disabled',
].filter(Boolean).join(' ');

// Or use a utility like clsx/classnames:
import clsx from 'clsx';
const className = clsx('base-class', {
  'selected': isSelected,
  'unavailable': !isAvailable,
  'disabled': disabled,
});
```

**Why This Matters:**
Conditional class building is extremely common - a utility library or filter pattern makes this clean across the entire codebase.

**Testing:**
- [ ] Verify all conditional classes apply correctly
- [ ] Test component states (selected, disabled, etc.)

~~~~~

## ðŸ”´ CHUNK 237-250: Replace push patterns in page components (BATCH)

**Files:** Multiple page files
**Pattern:** Building arrays with conditional push in page logic
**Violation:** MUTATING_METHOD - Array building patterns
**Severity:** ðŸ”´ High

**Affected Files:**
- AccountProfilePage/useAccountProfilePageLogic.js (99-131, 718, 964)
- FavoriteListingsPage/formatters.js (66-117)
- FavoriteListingsPage/FavoriteListingsPage.jsx (529-530, 1022, 1248-1254)
- HostOverviewPage/useHostOverviewPageLogic.js (154, 182, 198)
- HostProposalsPage/types.js (253-254, 342, 351, 411, 423)
- FAQPage.jsx (77-79, 356)
- HomePage.jsx (346)
- ListWithUsPage.jsx (27-28)
- SearchPage.jsx (89, 99, 1979-1980, 2318, 2330, 2632-2638)

**Current Code Pattern:**
```javascript
const parts = [];
if (value1) parts.push(value1);
if (value2) parts.push(value2);
if (value3) parts.push(value3);
```

**Refactored Code Pattern:**
```javascript
const parts = [value1, value2, value3].filter(Boolean);
```

**Why This Matters:**
This pattern appears 50+ times across page components. A single refactoring pattern applies to all.

**Testing:**
- [ ] Test each affected page
- [ ] Verify arrays build correctly with various input combinations

~~~~~

## ðŸ”´ CHUNK 251-280: Replace patterns in ListingDashboardPage components (BATCH)

**Files:** ListingDashboardPage/components/*.jsx
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Calendar and pricing patterns
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard

**Files:**
- AvailabilitySection.jsx (45-46, 106-134, 242, 253-257)
- NightlyPricingLegend.jsx (26-27)
- PricingEditSection.jsx (326-371, 408)

**Current Code:**
```javascript
// Date range generation
while (current <= end) {
  dates.push(formatDateKey(current));
  current = addDays(current, 1);
}

// Calendar grid
for (let i = startPadding - 1; i >= 0; i--) {
  days.push({ date: null, isPadding: true });
}
for (let i = 1; i <= daysInMonth; i++) {
  days.push({ date: new Date(year, month, i), isPadding: false });
}

// Changes tracking
if (priceChanged) changes.push(`Price: ${oldPrice} â†’ ${newPrice}`);
```

**Refactored Code:**
```javascript
// Date range generation
const dates = Array.from(
  { length: differenceInDays(end, start) + 1 },
  (_, i) => formatDateKey(addDays(start, i))
);

// Calendar grid
const calendarDays = [
  ...Array.from({ length: startPadding }, () => ({ date: null, isPadding: true })),
  ...Array.from({ length: daysInMonth }, (_, i) => ({
    date: new Date(year, month, i + 1),
    isPadding: false
  }))
];

// Changes tracking
const changes = [
  priceChanged && `Price: ${oldPrice} â†’ ${newPrice}`,
  datesChanged && `Dates updated`,
  // ... other conditions
].filter(Boolean);
```

**Why This Matters:**
Calendar and pricing components are used frequently - clean FP patterns improve maintainability.

**Testing:**
- [ ] Verify calendar grid renders correctly
- [ ] Test date range selection
- [ ] Verify changes are tracked properly

~~~~~

## ðŸ”´ CHUNK 281-298: Replace patterns in SelfListingPage store (BATCH)

**Files:** SelfListingPage/store/*.ts
**Violation:** MUTATING_METHOD - Validation error building
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Files:**
- listingLocalStore.ts (198, 254, 364, 387-454)
- prepareListingSubmission.ts (93-99, 270-313)

**Current Code:**
```javascript
// Validation errors
const errors: string[] = [];
if (!data.spaceSnapshot.listingName) {
  errors.push('Listing name is required');
}
if (!data.spaceSnapshot.typeOfSpace) {
  errors.push('Type of space is required');
}
// ... 15+ more conditional pushes

// Available nights
const result: string[] = [];
if (nights.sunday) result.push('sunday');
if (nights.monday) result.push('monday');
// ... etc
```

**Refactored Code:**
```javascript
// Validation errors - declarative
const validationRules = [
  [!data.spaceSnapshot.listingName, 'Listing name is required'],
  [!data.spaceSnapshot.typeOfSpace, 'Type of space is required'],
  [!data.spaceSnapshot.typeOfKitchen, 'Type of kitchen is required'],
  [!data.spaceSnapshot.typeOfParking, 'Type of parking is required'],
  [!data.spaceSnapshot.address.validated, 'Valid NYC address is required'],
  [data.features.amenitiesInsideUnit.length === 0, 'At least one amenity required'],
  // ... all rules
];

const errors = validationRules
  .filter(([condition]) => condition)
  .map(([_, message]) => message);

// Available nights - declarative
const dayNames = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
const result = dayNames.filter(day => nights[day]);
```

**Why This Matters:**
Validation is a perfect FP use case - rules as data makes adding/removing validations trivial.

**Testing:**
- [ ] Test all validation scenarios
- [ ] Verify error messages are correct
- [ ] Test available nights transformation

~~~~~

## ðŸ”´ CHUNK 299-314: Replace patterns in SelfListingPage sections (BATCH)

**Files:** SelfListingPage/sections/*.tsx
**Violation:** MUTATING_METHOD - Error order tracking
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Files:**
- Section1SpaceSnapshot.tsx (291-330)
- Section2Features.tsx (207, 212)
- Section3LeaseStyles.tsx (132, 137)
- Section4Pricing.tsx (50-67)
- Section5Rules.tsx (103-104, 141-147, 178-194)
- Section6Photos.tsx (48, 266)
- NightlyPriceSlider.tsx (70-71)

**Current Code:**
```javascript
const errorOrder = [];
if (!listingName) errorOrder.push('listingName');
if (!listingName || listingName.length < 3) errorOrder.push('listingName');
if (!typeOfSpace) errorOrder.push('typeOfSpace');
// ... etc
```

**Refactored Code:**
```javascript
const fieldValidations = [
  { field: 'listingName', invalid: !listingName },
  { field: 'listingName', invalid: listingName?.length < 3 },
  { field: 'typeOfSpace', invalid: !typeOfSpace },
  { field: 'bedrooms', invalid: bedrooms === undefined },
  // ... all validations
];

const errorOrder = fieldValidations
  .filter(v => v.invalid)
  .map(v => v.field);
```

**Why This Matters:**
Form validation benefits greatly from declarative rules.

**Testing:**
- [ ] Test section-by-section validation
- [ ] Verify error highlighting works
- [ ] Test form submission validation

~~~~~

## ðŸ”´ CHUNK 315-350: Replace remaining patterns (BATCH)

**Files:** Various remaining files
**Violation:** Mixed MUTATING_METHOD + IMPERATIVE_LOOP patterns
**Severity:** ðŸ”´ High

**Remaining Files:**
- RentalApplicationPage/utils/rentalApplicationFieldMapper.ts (401, 403)
- SelfListingPageV2/SelfListingPageV2.tsx (518-519, 526)
- NightlyPriceSlider.tsx (70-71)
- FavoriteListingsPage/components/MapView.jsx (83, 126)
- FavoriteListingsPage/components/SplitScheduleSelector.jsx (49-50, 55, 77)
- AccountProfilePage/components/cards/*.jsx (18, 38)
- proposals/ProposalCard.jsx (121, 130)
- ViewSplitLeasePage*.jsx (various)
- CreateProposalFlowV2*.jsx (257, 267)
- GoogleMap.jsx (272-733)
- FullscreenProposalMapModal.jsx (357)

**Common Pattern:**
All remaining violations follow the same patterns already documented:
1. `array.push(item)` â†’ `[...array, item]` or filter+map
2. `[...arr].sort()` â†’ `arr.toSorted()`
3. `for (let i...)` â†’ `Array.from()` or map/filter
4. Conditional pushes â†’ `[a, b, c].filter(Boolean)`

**Refactoring Approach:**
Apply the same patterns documented in previous chunks.

**Testing:**
- [ ] Test each affected page/component
- [ ] Run full test suite after refactoring

~~~~~

---

## Implementation Strategy

### Priority Order

1. **High Impact Core Files (CHUNK 1-77)**
   - Logic layer files (rules, calculators, processors)
   - Library utilities (availabilityValidation, scheduleSelector)
   - These are imported by many components

2. **Component Patterns (CHUNK 78-150)**
   - Shared components used across pages
   - Schedule selectors, form components

3. **Page-Specific Code (CHUNK 151-350)**
   - Individual page components
   - Lower risk of breaking changes

### Batch Application

Many chunks share identical patterns and can be batch-applied:

| Pattern | Chunks | Files Affected |
|---------|--------|----------------|
| `[...arr].sort()` â†’ `toSorted()` | 15, 19, 65, 73-76, 96+ | 20+ files |
| `arr.push(x)` â†’ `[...arr, x]` | 6-9, 11, 31-35, 38+ | 50+ files |
| `for` loop â†’ `Array.from` | 17-18, 67-68, 109-121 | 15+ files |
| Conditional push â†’ filter(Boolean) | 87-88, 123-131, 237-250 | 30+ files |
| className push â†’ clsx/filter | 132-236 | 10+ files |

### Testing Strategy

After each batch:
1. Run `bun run build` to verify no syntax errors
2. Run existing tests if available
3. Manual smoke test affected pages
4. Commit with descriptive message

---

## References

- **FP Audit Script:** `.claude/skills/functional-code/scripts/fp_audit.py`
- **FP Guidelines:** `.claude/skills/functional-code/README.md`
- **Violations JSON:** `agents/fp_audit_violations.json`

