# Functional Programming Refactoring Plan

Date: 2026-01-14
Target: agents/20260114061906_fp_audit_violations.json
Severity Filter: Top 5 Files (78 violations)

~~~~~

## CHUNK 1: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 198
**Violation:** MUTATING_METHOD - Using mutating array sort/reverse
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    const completedSections = new Set(this.state.data.completedSections);
    completedSections.add(section);
    this.state.data.completedSections = Array.from(completedSections).sort();
    this.scheduleAutoSave();
    this.notifyListeners();
```

**Refactored Code:**
```javascript
// TODO: Manual refactor required for: const completedSections = new Set(this.state.data.completedSections);
    completedSections.add(section);
    this.state.data.completedSections = Array.from(completedSections).sort();
    this.scheduleAutoSave();
    this.notifyListeners();
```

**Why This Matters:**
sort() and reverse() mutate the original array. Use immutable alternatives.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 2: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 254
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    } catch (error) {
      console.error('❌ ListingLocalStore: Error saving draft:', error);
      this.state.errors.push('Failed to save draft');
      this.notifyListeners();
      return false;
```

**Refactored Code:**
```javascript
    } catch (error) {
      console.error('❌ ListingLocalStore: Error saving draft:', error);
      this.state.errors = [...this.state.errors, 'Failed to save draft'];
      this.notifyListeners();
      return false;
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 3: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 364
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  markSubmissionFailed(error: string): void {
    this.state.stagingStatus = 'failed';
    this.state.errors.push(error);
    console.error('❌ ListingLocalStore: Submission failed:', error);
    this.notifyListeners();
```

**Refactored Code:**
```javascript
  markSubmissionFailed(error: string): void {
    this.state.stagingStatus = 'failed';
    this.state.errors = [...this.state.errors, error];
    console.error('❌ ListingLocalStore: Submission failed:', error);
    this.notifyListeners();
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 4: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 387
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    // Section 1: Space Snapshot
    if (!data.spaceSnapshot.listingName) {
      errors.push('Listing name is required');
    }
    if (!data.spaceSnapshot.typeOfSpace) {
```

**Refactored Code:**
```javascript
    // Section 1: Space Snapshot
    if (!data.spaceSnapshot.listingName) {
      errors = [...errors, 'Listing name is required'];
    }
    if (!data.spaceSnapshot.typeOfSpace) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 5: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 390
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    }
    if (!data.spaceSnapshot.typeOfSpace) {
      errors.push('Type of space is required');
    }
    if (!data.spaceSnapshot.typeOfKitchen) {
```

**Refactored Code:**
```javascript
    }
    if (!data.spaceSnapshot.typeOfSpace) {
      errors = [...errors, 'Type of space is required'];
    }
    if (!data.spaceSnapshot.typeOfKitchen) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 6: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 393
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    }
    if (!data.spaceSnapshot.typeOfKitchen) {
      errors.push('Type of kitchen is required');
    }
    if (!data.spaceSnapshot.typeOfParking) {
```

**Refactored Code:**
```javascript
    }
    if (!data.spaceSnapshot.typeOfKitchen) {
      errors = [...errors, 'Type of kitchen is required'];
    }
    if (!data.spaceSnapshot.typeOfParking) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 7: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 396
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    }
    if (!data.spaceSnapshot.typeOfParking) {
      errors.push('Type of parking is required');
    }
    if (!data.spaceSnapshot.address.fullAddress || !data.spaceSnapshot.address.validated) {
```

**Refactored Code:**
```javascript
    }
    if (!data.spaceSnapshot.typeOfParking) {
      errors = [...errors, 'Type of parking is required'];
    }
    if (!data.spaceSnapshot.address.fullAddress || !data.spaceSnapshot.address.validated) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 8: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 399
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    }
    if (!data.spaceSnapshot.address.fullAddress || !data.spaceSnapshot.address.validated) {
      errors.push('Valid NYC address is required');
    }
```

**Refactored Code:**
```javascript
    }
    if (!data.spaceSnapshot.address.fullAddress || !data.spaceSnapshot.address.validated) {
      errors = [...errors, 'Valid NYC address is required'];
    }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 9: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 404
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    // Section 2: Features
    if (data.features.amenitiesInsideUnit.length === 0) {
      errors.push('At least one amenity inside unit is required');
    }
    if (!data.features.descriptionOfLodging) {
```

**Refactored Code:**
```javascript
    // Section 2: Features
    if (data.features.amenitiesInsideUnit.length === 0) {
      errors = [...errors, 'At least one amenity inside unit is required'];
    }
    if (!data.features.descriptionOfLodging) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 10: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 407
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    }
    if (!data.features.descriptionOfLodging) {
      errors.push('Description of lodging is required');
    }
```

**Refactored Code:**
```javascript
    }
    if (!data.features.descriptionOfLodging) {
      errors = [...errors, 'Description of lodging is required'];
    }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 11: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 412
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    // Section 3: Lease Styles
    if (!data.leaseStyles.rentalType) {
      errors.push('Rental type is required');
    }
    if (data.leaseStyles.rentalType === 'Nightly') {
```

**Refactored Code:**
```javascript
    // Section 3: Lease Styles
    if (!data.leaseStyles.rentalType) {
      errors = [...errors, 'Rental type is required'];
    }
    if (data.leaseStyles.rentalType === 'Nightly') {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 12: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 417
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
      const nights = data.leaseStyles.availableNights;
      if (!nights || !Object.values(nights).some((v) => v)) {
        errors.push('At least one available night must be selected');
      }
    }
```

**Refactored Code:**
```javascript
      const nights = data.leaseStyles.availableNights;
      if (!nights || !Object.values(nights).some((v) => v)) {
        errors = [...errors, 'At least one available night must be selected'];
      }
    }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 13: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 421
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    }
    if (data.leaseStyles.rentalType === 'Weekly' && !data.leaseStyles.weeklyPattern) {
      errors.push('Weekly pattern is required');
    }
```

**Refactored Code:**
```javascript
    }
    if (data.leaseStyles.rentalType === 'Weekly' && !data.leaseStyles.weeklyPattern) {
      errors = [...errors, 'Weekly pattern is required'];
    }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 14: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 426
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    // Section 4: Pricing
    if (data.pricing.damageDeposit < 500) {
      errors.push('Damage deposit must be at least $500');
    }
    if (data.leaseStyles.rentalType === 'Monthly' && !data.pricing.monthlyCompensation) {
```

**Refactored Code:**
```javascript
    // Section 4: Pricing
    if (data.pricing.damageDeposit < 500) {
      errors = [...errors, 'Damage deposit must be at least $500'];
    }
    if (data.leaseStyles.rentalType === 'Monthly' && !data.pricing.monthlyCompensation) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 15: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 429
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    }
    if (data.leaseStyles.rentalType === 'Monthly' && !data.pricing.monthlyCompensation) {
      errors.push('Monthly compensation is required');
    }
    if (data.leaseStyles.rentalType === 'Weekly' && !data.pricing.weeklyCompensation) {
```

**Refactored Code:**
```javascript
    }
    if (data.leaseStyles.rentalType === 'Monthly' && !data.pricing.monthlyCompensation) {
      errors = [...errors, 'Monthly compensation is required'];
    }
    if (data.leaseStyles.rentalType === 'Weekly' && !data.pricing.weeklyCompensation) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 16: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 432
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    }
    if (data.leaseStyles.rentalType === 'Weekly' && !data.pricing.weeklyCompensation) {
      errors.push('Weekly compensation is required');
    }
    if (
```

**Refactored Code:**
```javascript
    }
    if (data.leaseStyles.rentalType === 'Weekly' && !data.pricing.weeklyCompensation) {
      errors = [...errors, 'Weekly compensation is required'];
    }
    if (
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 17: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 438
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
      !data.pricing.nightlyPricing?.oneNightPrice
    ) {
      errors.push('Nightly pricing is required');
    }
```

**Refactored Code:**
```javascript
      !data.pricing.nightlyPricing?.oneNightPrice
    ) {
      errors = [...errors, 'Nightly pricing is required'];
    }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 18: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 443
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    // Section 5: Rules
    if (!data.rules.cancellationPolicy) {
      errors.push('Cancellation policy is required');
    }
    if (!data.rules.checkInTime) {
```

**Refactored Code:**
```javascript
    // Section 5: Rules
    if (!data.rules.cancellationPolicy) {
      errors = [...errors, 'Cancellation policy is required'];
    }
    if (!data.rules.checkInTime) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 19: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 446
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    }
    if (!data.rules.checkInTime) {
      errors.push('Check-in time is required');
    }
    if (!data.rules.checkOutTime) {
```

**Refactored Code:**
```javascript
    }
    if (!data.rules.checkInTime) {
      errors = [...errors, 'Check-in time is required'];
    }
    if (!data.rules.checkOutTime) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 20: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 449
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    }
    if (!data.rules.checkOutTime) {
      errors.push('Check-out time is required');
    }
```

**Refactored Code:**
```javascript
    }
    if (!data.rules.checkOutTime) {
      errors = [...errors, 'Check-out time is required'];
    }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 21: MUTATING_METHOD in listingLocalStore.ts

**File:** islands/pages/SelfListingPage/store/listingLocalStore.ts
**Line:** 454
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    // Section 6: Photos
    if (data.photos.photos.length < data.photos.minRequired) {
      errors.push(`At least ${data.photos.minRequired} photos are required`);
    }
```

**Refactored Code:**
```javascript
    // Section 6: Photos
    if (data.photos.photos.length < data.photos.minRequired) {
      errors = [...errors, `At least ${data.photos.minRequired} photos are required`];
    }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 22: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 93
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  const result: string[] = [];
  if (nights.sunday) result.push('sunday');
  if (nights.monday) result.push('monday');
  if (nights.tuesday) result.push('tuesday');
```

**Refactored Code:**
```javascript

  const result: string[] = [];
  if (nights.sunday) result = [...result, 'sunday'];
  if (nights.monday) result.push('monday');
  if (nights.tuesday) result.push('tuesday');
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 23: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 94
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const result: string[] = [];
  if (nights.sunday) result.push('sunday');
  if (nights.monday) result.push('monday');
  if (nights.tuesday) result.push('tuesday');
  if (nights.wednesday) result.push('wednesday');
```

**Refactored Code:**
```javascript
  const result: string[] = [];
  if (nights.sunday) result = [...result, 'sunday'];
  if (nights.monday) result.push('monday');
  if (nights.tuesday) result.push('tuesday');
  if (nights.wednesday) result.push('wednesday');
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 24: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 95
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (nights.sunday) result.push('sunday');
  if (nights.monday) result.push('monday');
  if (nights.tuesday) result.push('tuesday');
  if (nights.wednesday) result.push('wednesday');
  if (nights.thursday) result.push('thursday');
```

**Refactored Code:**
```javascript
  if (nights.sunday) result = [...result, 'sunday'];
  if (nights.monday) result.push('monday');
  if (nights.tuesday) result.push('tuesday');
  if (nights.wednesday) result.push('wednesday');
  if (nights.thursday) result.push('thursday');
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 25: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 96
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (nights.monday) result.push('monday');
  if (nights.tuesday) result.push('tuesday');
  if (nights.wednesday) result.push('wednesday');
  if (nights.thursday) result.push('thursday');
  if (nights.friday) result.push('friday');
```

**Refactored Code:**
```javascript
  if (nights.monday) result = [...result, 'monday'];
  if (nights.tuesday) result.push('tuesday');
  if (nights.wednesday) result.push('wednesday');
  if (nights.thursday) result.push('thursday');
  if (nights.friday) result.push('friday');
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 26: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 97
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (nights.tuesday) result.push('tuesday');
  if (nights.wednesday) result.push('wednesday');
  if (nights.thursday) result.push('thursday');
  if (nights.friday) result.push('friday');
  if (nights.saturday) result.push('saturday');
```

**Refactored Code:**
```javascript
  if (nights.tuesday) result = [...result, 'tuesday'];
  if (nights.wednesday) result.push('wednesday');
  if (nights.thursday) result.push('thursday');
  if (nights.friday) result.push('friday');
  if (nights.saturday) result.push('saturday');
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 27: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 98
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (nights.wednesday) result.push('wednesday');
  if (nights.thursday) result.push('thursday');
  if (nights.friday) result.push('friday');
  if (nights.saturday) result.push('saturday');
```

**Refactored Code:**
```javascript
  if (nights.wednesday) result = [...result, 'wednesday'];
  if (nights.thursday) result.push('thursday');
  if (nights.friday) result.push('friday');
  if (nights.saturday) result.push('saturday');
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 28: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 99
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (nights.thursday) result.push('thursday');
  if (nights.friday) result.push('friday');
  if (nights.saturday) result.push('saturday');

  return result;
```

**Refactored Code:**
```javascript
  if (nights.thursday) result = [...result, 'thursday'];
  if (nights.friday) result.push('friday');
  if (nights.saturday) result.push('saturday');

  return result;
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 29: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 270
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  // Required fields
  if (!payload.Name) errors.push('Name is required');
  if (!payload['Type of Space']) errors.push('Type of Space is required');
  if (!payload.Address) errors.push('Address is required');
```

**Refactored Code:**
```javascript

  // Required fields
  if (!payload.Name) errors = [...errors, 'Name is required'];
  if (!payload['Type of Space']) errors.push('Type of Space is required');
  if (!payload.Address) errors.push('Address is required');
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 30: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 271
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  // Required fields
  if (!payload.Name) errors.push('Name is required');
  if (!payload['Type of Space']) errors.push('Type of Space is required');
  if (!payload.Address) errors.push('Address is required');
  if (!payload['Rental Type']) errors.push('Rental Type is required');
```

**Refactored Code:**
```javascript
  // Required fields
  if (!payload.Name) errors = [...errors, 'Name is required'];
  if (!payload['Type of Space']) errors.push('Type of Space is required');
  if (!payload.Address) errors.push('Address is required');
  if (!payload['Rental Type']) errors.push('Rental Type is required');
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 31: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 272
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (!payload.Name) errors.push('Name is required');
  if (!payload['Type of Space']) errors.push('Type of Space is required');
  if (!payload.Address) errors.push('Address is required');
  if (!payload['Rental Type']) errors.push('Rental Type is required');
```

**Refactored Code:**
```javascript
  if (!payload.Name) errors = [...errors, 'Name is required'];
  if (!payload['Type of Space']) errors.push('Type of Space is required');
  if (!payload.Address) errors.push('Address is required');
  if (!payload['Rental Type']) errors.push('Rental Type is required');
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 32: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 273
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (!payload['Type of Space']) errors.push('Type of Space is required');
  if (!payload.Address) errors.push('Address is required');
  if (!payload['Rental Type']) errors.push('Rental Type is required');

  // Pricing validation based on rental type
```

**Refactored Code:**
```javascript
  if (!payload['Type of Space']) errors = [...errors, 'Type of Space is required'];
  if (!payload.Address) errors.push('Address is required');
  if (!payload['Rental Type']) errors.push('Rental Type is required');

  // Pricing validation based on rental type
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 33: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 277
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  // Pricing validation based on rental type
  if (payload['Rental Type'] === 'Monthly' && !payload['Monthly Compensation']) {
    errors.push('Monthly Compensation is required for Monthly rentals');
  }
  if (payload['Rental Type'] === 'Weekly' && !payload['Weekly Compensation']) {
```

**Refactored Code:**
```javascript
  // Pricing validation based on rental type
  if (payload['Rental Type'] === 'Monthly' && !payload['Monthly Compensation']) {
    errors = [...errors, 'Monthly Compensation is required for Monthly rentals'];
  }
  if (payload['Rental Type'] === 'Weekly' && !payload['Weekly Compensation']) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 34: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 280
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  }
  if (payload['Rental Type'] === 'Weekly' && !payload['Weekly Compensation']) {
    errors.push('Weekly Compensation is required for Weekly rentals');
  }
  if (payload['Rental Type'] === 'Nightly' && !payload['Price 1 night selected']) {
```

**Refactored Code:**
```javascript
  }
  if (payload['Rental Type'] === 'Weekly' && !payload['Weekly Compensation']) {
    errors = [...errors, 'Weekly Compensation is required for Weekly rentals'];
  }
  if (payload['Rental Type'] === 'Nightly' && !payload['Price 1 night selected']) {
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 35: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 283
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  }
  if (payload['Rental Type'] === 'Nightly' && !payload['Price 1 night selected']) {
    errors.push('Nightly pricing is required for Nightly rentals');
  }
```

**Refactored Code:**
```javascript
  }
  if (payload['Rental Type'] === 'Nightly' && !payload['Price 1 night selected']) {
    errors = [...errors, 'Nightly pricing is required for Nightly rentals'];
  }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 36: MUTATING_METHOD in prepareListingSubmission.ts

**File:** islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Line:** 288
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  // Damage deposit minimum
  if (payload['Damage Deposit'] < 500) {
    errors.push('Damage Deposit must be at least $500');
  }
```

**Refactored Code:**
```javascript
  // Damage deposit minimum
  if (payload['Damage Deposit'] < 500) {
    errors = [...errors, 'Damage Deposit must be at least $500'];
  }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 37: IMPERATIVE_LOOP in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 47
**Violation:** IMPERATIVE_LOOP - Imperative loop found (consider map/filter/reduce)
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  ];

  for (const pattern of namePatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
```

**Refactored Code:**
```javascript
/* REFACTOR: Replace loop with map/filter/reduce */
  ];

  for (const pattern of namePatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
```

**Why This Matters:**
Declarative array methods (map/filter/reduce) are more expressive and less error-prone than imperative loops.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 38: IMPERATIVE_LOOP in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 111
**Violation:** IMPERATIVE_LOOP - Imperative loop found (consider map/filter/reduce)
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  ];

  for (const pattern of standardPhonePatterns) {
    const match = text.match(pattern);
    if (match) return match[0];
```

**Refactored Code:**
```javascript
/* REFACTOR: Replace loop with map/filter/reduce */
  ];

  for (const pattern of standardPhonePatterns) {
    const match = text.match(pattern);
    if (match) return match[0];
```

**Why This Matters:**
Declarative array methods (map/filter/reduce) are more expressive and less error-prone than imperative loops.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 39: IMPERATIVE_LOOP in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 123
**Violation:** IMPERATIVE_LOOP - Imperative loop found (consider map/filter/reduce)
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  ];

  for (const pattern of explicitPhonePatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
```

**Refactored Code:**
```javascript
/* REFACTOR: Replace loop with map/filter/reduce */
  ];

  for (const pattern of explicitPhonePatterns) {
    const match = text.match(pattern);
    if (match && match[1]) {
```

**Why This Matters:**
Declarative array methods (map/filter/reduce) are more expressive and less error-prone than imperative loops.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 40: EXCEPTION_FOR_FLOW in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 217
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    throw new Error('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/ai-parse-profile`;
```

**Refactored Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    return err('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/ai-parse-profile`;
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 41: EXCEPTION_FOR_FLOW in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 217
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    throw new Error('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/ai-parse-profile`;
```

**Refactored Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    return err('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/ai-parse-profile`;
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 42: EXCEPTION_FOR_FLOW in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 277
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (!data.email) {
    console.error('[AiSignupMarketReport] ❌ Error: Missing email');
    throw new Error('Email is required');
  }
```

**Refactored Code:**
```javascript
  if (!data.email) {
    console.error('[AiSignupMarketReport] ❌ Error: Missing email');
    return err('Email is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 43: EXCEPTION_FOR_FLOW in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 277
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (!data.email) {
    console.error('[AiSignupMarketReport] ❌ Error: Missing email');
    throw new Error('Email is required');
  }
```

**Refactored Code:**
```javascript
  if (!data.email) {
    console.error('[AiSignupMarketReport] ❌ Error: Missing email');
    return err('Email is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 44: EXCEPTION_FOR_FLOW in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 282
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (!data.marketResearchText) {
    console.error('[AiSignupMarketReport] ❌ Error: Missing market research text');
    throw new Error('Market research description is required');
  }
```

**Refactored Code:**
```javascript
  if (!data.marketResearchText) {
    console.error('[AiSignupMarketReport] ❌ Error: Missing market research text');
    return err('Market research description is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 45: EXCEPTION_FOR_FLOW in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 282
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (!data.marketResearchText) {
    console.error('[AiSignupMarketReport] ❌ Error: Missing market research text');
    throw new Error('Market research description is required');
  }
```

**Refactored Code:**
```javascript
  if (!data.marketResearchText) {
    console.error('[AiSignupMarketReport] ❌ Error: Missing market research text');
    return err('Market research description is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 46: EXCEPTION_FOR_FLOW in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 363
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    throw new Error('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/ai-signup-guest`;
```

**Refactored Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    return err('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/ai-signup-guest`;
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 47: EXCEPTION_FOR_FLOW in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 363
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    throw new Error('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/ai-signup-guest`;
```

**Refactored Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    return err('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/ai-signup-guest`;
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 48: EXCEPTION_FOR_FLOW in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 483
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    throw new Error('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/bubble-proxy`;
```

**Refactored Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    return err('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/bubble-proxy`;
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 49: EXCEPTION_FOR_FLOW in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 483
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    throw new Error('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/bubble-proxy`;
```

**Refactored Code:**
```javascript
  const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
  if (!supabaseUrl) {
    return err('VITE_SUPABASE_URL is required');
  }
  const edgeFunctionUrl = `${supabaseUrl}/functions/v1/bubble-proxy`;
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 50: IMPERATIVE_LOOP in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 680
**Violation:** IMPERATIVE_LOOP - Imperative loop found (consider map/filter/reduce)
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const detectedTopics = [];

  for (const topic of FREEFORM_TOPICS) {
    const isDetected = topic.patterns.some(pattern => pattern.test(text));
    if (isDetected) {
```

**Refactored Code:**
```javascript
/* REFACTOR: Replace loop with map/filter/reduce */
  const detectedTopics = [];

  for (const topic of FREEFORM_TOPICS) {
    const isDetected = topic.patterns.some(pattern => pattern.test(text));
    if (isDetected) {
```

**Why This Matters:**
Declarative array methods (map/filter/reduce) are more expressive and less error-prone than imperative loops.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 51: MUTATING_METHOD in AiSignupMarketReport.jsx

**File:** islands/shared/AiSignupMarketReport/AiSignupMarketReport.jsx
**Line:** 683
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
    const isDetected = topic.patterns.some(pattern => pattern.test(text));
    if (isDetected) {
      detectedTopics.push(topic.id);
    }
  }
```

**Refactored Code:**
```javascript
    const isDetected = topic.patterns.some(pattern => pattern.test(text));
    if (isDetected) {
      detectedTopics = [...detectedTopics, topic.id];
    }
  }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 52: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 44
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingName?.trim()) {
    throw new Error('Listing name is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingName?.trim()) {
    return err('Listing name is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 53: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 44
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingName?.trim()) {
    throw new Error('Listing name is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingName?.trim()) {
    return err('Listing name is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 54: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 88
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingId?.trim()) {
    throw new Error('Listing ID is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingId?.trim()) {
    return err('Listing ID is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 55: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 88
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingId?.trim()) {
    throw new Error('Listing ID is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingId?.trim()) {
    return err('Listing ID is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 56: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 135
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingId?.trim()) {
    throw new Error('Listing ID is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingId?.trim()) {
    return err('Listing ID is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 57: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 135
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingId?.trim()) {
    throw new Error('Listing ID is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingId?.trim()) {
    return err('Listing ID is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 58: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 139
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!Array.isArray(photos) || photos.length === 0) {
    throw new Error('At least one photo is required');
  }
```

**Refactored Code:**
```javascript

  if (!Array.isArray(photos) || photos.length === 0) {
    return err('At least one photo is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 59: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 139
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!Array.isArray(photos) || photos.length === 0) {
    throw new Error('At least one photo is required');
  }
```

**Refactored Code:**
```javascript

  if (!Array.isArray(photos) || photos.length === 0) {
    return err('At least one photo is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 60: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 190
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingId?.trim()) {
    throw new Error('Listing ID is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingId?.trim()) {
    return err('Listing ID is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 61: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 190
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingId?.trim()) {
    throw new Error('Listing ID is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingId?.trim()) {
    return err('Listing ID is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 62: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 194
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!userEmail?.trim()) {
    throw new Error('User email is required');
  }
```

**Refactored Code:**
```javascript

  if (!userEmail?.trim()) {
    return err('User email is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 63: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 194
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!userEmail?.trim()) {
    throw new Error('User email is required');
  }
```

**Refactored Code:**
```javascript

  if (!userEmail?.trim()) {
    return err('User email is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 64: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 198
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingData || typeof listingData !== 'object') {
    throw new Error('Listing data is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingData || typeof listingData !== 'object') {
    return err('Listing data is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 65: EXCEPTION_FOR_FLOW in bubbleAPI.js

**File:** lib/bubbleAPI.js
**Line:** 198
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingData || typeof listingData !== 'object') {
    throw new Error('Listing data is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingData || typeof listingData !== 'object') {
    return err('Listing data is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 66: EXCEPTION_FOR_FLOW in listingService.js

**File:** lib/listingService.js
**Line:** 246
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (!userId) {
    console.error('[ListingService] ❌ No userId provided - cannot link listing to user');
    throw new Error('User ID is required to create a listing');
  }
```

**Refactored Code:**
```javascript
  if (!userId) {
    console.error('[ListingService] ❌ No userId provided - cannot link listing to user');
    return err('User ID is required to create a listing');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 67: EXCEPTION_FOR_FLOW in listingService.js

**File:** lib/listingService.js
**Line:** 246
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  if (!userId) {
    console.error('[ListingService] ❌ No userId provided - cannot link listing to user');
    throw new Error('User ID is required to create a listing');
  }
```

**Refactored Code:**
```javascript
  if (!userId) {
    console.error('[ListingService] ❌ No userId provided - cannot link listing to user');
    return err('User ID is required to create a listing');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 68: MUTATING_METHOD in listingService.js

**File:** lib/listingService.js
**Line:** 335
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const currentListings = userData.Listings || [];
  if (!currentListings.includes(listingId)) {
    currentListings.push(listingId);
  }
```

**Refactored Code:**
```javascript
  const currentListings = userData.Listings || [];
  if (!currentListings.includes(listingId)) {
    currentListings = [...currentListings, listingId];
  }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 69: IMPERATIVE_LOOP in listingService.js

**File:** lib/listingService.js
**Line:** 766
**Violation:** IMPERATIVE_LOOP - Imperative loop found (consider map/filter/reduce)
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const dayOrder = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

  for (const day of dayOrder) {
    if (availableNights[day] && dayNameMapping[day]) {
      result.push(dayNameMapping[day]);
```

**Refactored Code:**
```javascript
/* REFACTOR: Replace loop with map/filter/reduce */
  const dayOrder = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

  for (const day of dayOrder) {
    if (availableNights[day] && dayNameMapping[day]) {
      result.push(dayNameMapping[day]);
```

**Why This Matters:**
Declarative array methods (map/filter/reduce) are more expressive and less error-prone than imperative loops.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 70: MUTATING_METHOD in listingService.js

**File:** lib/listingService.js
**Line:** 768
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  for (const day of dayOrder) {
    if (availableNights[day] && dayNameMapping[day]) {
      result.push(dayNameMapping[day]);
    }
  }
```

**Refactored Code:**
```javascript
  for (const day of dayOrder) {
    if (availableNights[day] && dayNameMapping[day]) {
      result = [...result, dayNameMapping[day]];
    }
  }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 71: EXCEPTION_FOR_FLOW in listingService.js

**File:** lib/listingService.js
**Line:** 790
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingId) {
    throw new Error('Listing ID is required for update');
  }
```

**Refactored Code:**
```javascript

  if (!listingId) {
    return err('Listing ID is required for update');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 72: EXCEPTION_FOR_FLOW in listingService.js

**File:** lib/listingService.js
**Line:** 790
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingId) {
    throw new Error('Listing ID is required for update');
  }
```

**Refactored Code:**
```javascript

  if (!listingId) {
    return err('Listing ID is required for update');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 73: IMPERATIVE_LOOP in listingService.js

**File:** lib/listingService.js
**Line:** 982
**Violation:** IMPERATIVE_LOOP - Imperative loop found (consider map/filter/reduce)
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  const normalized = {};

  for (const [key, value] of Object.entries(formData)) {
    // Check if this key needs to be remapped
    if (columnNameMap[key]) {
```

**Refactored Code:**
```javascript
/* REFACTOR: Replace loop with map/filter/reduce */
  const normalized = {};

  for (const [key, value] of Object.entries(formData)) {
    // Check if this key needs to be remapped
    if (columnNameMap[key]) {
```

**Why This Matters:**
Declarative array methods (map/filter/reduce) are more expressive and less error-prone than imperative loops.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 74: EXCEPTION_FOR_FLOW in listingService.js

**File:** lib/listingService.js
**Line:** 1003
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingId) {
    throw new Error('Listing ID is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingId) {
    return err('Listing ID is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 75: EXCEPTION_FOR_FLOW in listingService.js

**File:** lib/listingService.js
**Line:** 1003
**Violation:** EXCEPTION_FOR_FLOW - Exception used for validation/expected errors
**Severity:** MEDIUM

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  if (!listingId) {
    throw new Error('Listing ID is required');
  }
```

**Refactored Code:**
```javascript

  if (!listingId) {
    return err('Listing ID is required');
  }
```

**Why This Matters:**
Expected errors (validation, not found, etc.) should be return values, not exceptions. This makes error handling explicit and type-safe.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 76: IMPERATIVE_LOOP in listingService.js

**File:** lib/listingService.js
**Line:** 1076
**Violation:** IMPERATIVE_LOOP - Imperative loop found (consider map/filter/reduce)
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript

  const result = [];
  for (const [day, isSelected] of Object.entries(availableNights)) {
    if (isSelected && dayMapping[day] !== undefined) {
      result.push(dayMapping[day]);
```

**Refactored Code:**
```javascript
/* REFACTOR: Replace loop with map/filter/reduce */

  const result = [];
  for (const [day, isSelected] of Object.entries(availableNights)) {
    if (isSelected && dayMapping[day] !== undefined) {
      result.push(dayMapping[day]);
```

**Why This Matters:**
Declarative array methods (map/filter/reduce) are more expressive and less error-prone than imperative loops.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 77: MUTATING_METHOD in listingService.js

**File:** lib/listingService.js
**Line:** 1078
**Violation:** MUTATING_METHOD - Using mutating array method
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  for (const [day, isSelected] of Object.entries(availableNights)) {
    if (isSelected && dayMapping[day] !== undefined) {
      result.push(dayMapping[day]);
    }
  }
```

**Refactored Code:**
```javascript
  for (const [day, isSelected] of Object.entries(availableNights)) {
    if (isSelected && dayMapping[day] !== undefined) {
      result = [...result, dayMapping[day]];
    }
  }
```

**Why This Matters:**
Mutating methods modify the original array, making code harder to test and reason about.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~

## CHUNK 78: MUTATING_METHOD in listingService.js

**File:** lib/listingService.js
**Line:** 1082
**Violation:** MUTATING_METHOD - Using mutating array sort/reverse
**Severity:** HIGH

**Expected Affected Pages:** AUTO

**Current Code:**
```javascript
  }

  return result.sort((a, b) => a - b);
}
```

**Refactored Code:**
```javascript
  }

  return [...result].sort((a, b) => a - b);
}
```

**Why This Matters:**
sort() and reverse() mutate the original array. Use immutable alternatives.

**Testing:**
- [ ] Verify functionality remains unchanged
- [ ] Check for regression in dependent features

~~~~~
