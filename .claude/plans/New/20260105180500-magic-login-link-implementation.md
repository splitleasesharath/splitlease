# Implementation Plan: Magic Login Link Functionality

## Overview

Implement the "Log in Without Password" (magic login link) feature in the SignUpLoginModal. When clicked, the system will show a security-conscious message, silently check if the email exists, and if found, generate a magic link via the auth-user edge function and send it via the send-email edge function using the "Security 2" email template. BCC emails will be dynamically fetched from the `os_slack_channels` reference table.

## Success Criteria

- [ ] Clicking "Log in Without Password" shows an alert that says a link will be sent if the email exists
- [ ] The system checks for email existence without exposing whether the account exists (security)
- [ ] If email exists: generate magic link via `auth-user` + send email via `send-email`
- [ ] If email does not exist: show same success message (prevents account enumeration)
- [ ] Email uses the "Security 2" template with proper placeholder population
- [ ] Magic link redirects user to the profile page after authentication
- [ ] BCC emails are dynamically fetched from `reference_table.os_slack_channels`

## Context & References

### Relevant Files

| File | Purpose | Changes Needed |
|------|---------|----------------|
| `app/src/islands/shared/SignUpLoginModal.jsx` | Login modal with "Log in Without Password" button | Rewrite `handleMagicLink` function |
| `app/src/islands/pages/useEmailUnitPageLogic.js` | Reference for CC/BCC email pattern | No changes (reference only) |
| `supabase/functions/auth-user/handlers/generateMagicLink.ts` | Generates magic link without sending email | Already implemented, no changes |
| `supabase/functions/auth-user/index.ts` | Routes to generateMagicLink handler | Already implemented, no changes |
| `supabase/functions/send-email/handlers/send.ts` | Sends templated emails via SendGrid | May need to support cc_emails/bcc_emails arrays |
| `supabase/functions/send-email/index.ts` | Routes email operations | May need auth bypass for magic link |

### Dynamic Email Lookup - os_slack_channels Table

**Table**: `reference_table.os_slack_channels`
**Schema**:
```sql
create table reference_table.os_slack_channels (
  id bigint generated by default as identity,
  name text not null,
  display text not null,
  email_address text null,
  created_at timestamp with time zone default now(),
  constraint os_slack_channels_pkey primary key (id),
  constraint os_slack_channels_name_key unique (name)
)
```

**Recommended Channels for Magic Link BCC**:

| Channel Name | Display | Email Address | Reason |
|--------------|---------|---------------|--------|
| `bots_log` | bots-log | `log-aaaancyvhragppx4e3cz4wq65e@splitlease.slack.com` | General logging of automated events |
| `customer_activation` | customer-activation | `activation-aaaacxk3rf2od4tbjuf2hpquii@splitlease.slack.com` | Track user login/activation events |

**Note**: BCC is preferred over CC for internal notifications to avoid confusing the user.

### CC/BCC Implementation Pattern (from EmailUnitPage)

From `useEmailUnitPageLogic.js` (lines 223-276):
```javascript
// Multi-email placeholders that support multiple email addresses
const MULTI_EMAIL_PLACEHOLDERS = ['$$to$$', '$$cc$$', '$$bcc$$'];

// In sendEmail function:
const ccEmails = (multiEmailValues['$$cc$$'] || []).filter(e => e && e.trim());
const bccEmails = (multiEmailValues['$$bcc$$'] || []).filter(e => e && e.trim());

// Passed to edge function:
...(ccEmails.length > 0 && { cc_emails: ccEmails }),
...(bccEmails.length > 0 && { bcc_emails: bccEmails }),
```

### Email Template Reference

**Template Name**: Security 2
**Template ID**: `1757433099447x202755280527849400`
**Table**: `reference_table.zat_email_html_template_eg_sendbasicemailwf_`

**Placeholders to populate**:
| Placeholder | Value |
|------------|-------|
| `$$toemail$$` | User's email address |
| `$$fromemail$$` | `tech@leasesplit.com` |
| `$$fromname$$` | `Split Lease` |
| `$$subject$$` | `Your Split Lease Magic Login Link` |
| `$$preheadertext$$` | `Click the link to log in without a password` |
| `$$title$$` | `Magic Login Link` |
| `$$bodytext$$` | `Hi {firstName}. Please use the link below to log in to your Split Lease account. Once logged in, you can update your password from the profile page. Please feel free to text (937) 673-7470 with any queries.` |
| `$$buttonurl$$` | The magic link URL |
| `$$buttontext$$` | `Log In Now` |
| `$$bannertext1$$` | `SECURITY NOTICE` |
| `$$bannertext2$$` | `This link expires in 1 hour` |
| `$$bannertext3$$` | `If you didn't request this, please ignore this email` |
| `$$footermessage$$` | `For your security, never share this link with anyone.` |
| `$$cc$$` | Empty (no CC for users) |
| `$$bcc$$` | Dynamically fetched from os_slack_channels |

### Existing Patterns to Follow

1. **Edge Function Invocation Pattern**:
```javascript
const { data, error } = await supabase.functions.invoke('function-name', {
  body: {
    action: 'action_name',
    payload: { /* data */ }
  }
});
```

2. **Security Pattern from Password Reset** (lines 777-828 in SignUpLoginModal.jsx):
   - Always show success message regardless of whether email exists
   - Capture errors but don't expose them to user
   - Prevents email enumeration attacks

3. **Toast Notification Pattern**:
```javascript
showToast({
  title: 'Title',
  content: 'Message',
  type: 'info' // or 'success', 'error'
});
```

4. **Dynamic Reference Lookup Pattern**:
```javascript
const { data: channels, error } = await supabase
  .schema('reference_table')
  .from('os_slack_channels')
  .select('email_address')
  .in('name', ['bots_log', 'customer_activation']);
```

## Implementation Steps

### Step 1: Update handleMagicLink Function in SignUpLoginModal.jsx

**Files**: `app/src/islands/shared/SignUpLoginModal.jsx`
**Purpose**: Rewrite the magic link handler to:
1. Check if email exists by looking up user in database
2. Fetch BCC email addresses from os_slack_channels
3. If user exists: call generate_magic_link, then send email with dynamic BCC
4. Always show same success message for security

**Details**:

Replace the existing `handleMagicLink` function (lines 831-864) with:

```javascript
// Handle magic link request
const handleMagicLink = async () => {
  const email = currentView === VIEWS.PASSWORD_RESET ? resetEmail : loginData.email;

  if (!email.trim()) {
    setError('Please enter your email address first.');
    return;
  }

  setIsLoading(true);
  setError('');

  // Always show the same message for security (prevents email enumeration)
  const showSuccessMessage = () => {
    showToast({
      title: 'Check Your Inbox',
      content: 'If an account with that email exists, a magic login link has been sent.',
      type: 'info'
    });
  };

  try {
    // Step 1: Check if user exists (using Supabase directly)
    const { data: userData, error: userError } = await supabase
      .from('user')
      .select('_id, "Name - First", email')
      .eq('email', email.toLowerCase().trim())
      .maybeSingle();

    if (userError) {
      console.error('[handleMagicLink] Error checking user:', userError);
      // Don't expose error - show success for security
      showSuccessMessage();
      setIsLoading(false);
      return;
    }

    if (!userData) {
      // User doesn't exist - still show success message for security
      console.log('[handleMagicLink] No user found for email');
      showSuccessMessage();
      setIsLoading(false);
      return;
    }

    // Step 2: User exists - fetch BCC email addresses from os_slack_channels
    console.log('[handleMagicLink] Fetching BCC email addresses from os_slack_channels');

    const { data: channelData, error: channelError } = await supabase
      .schema('reference_table')
      .from('os_slack_channels')
      .select('email_address')
      .in('name', ['bots_log', 'customer_activation']);

    let bccEmails = [];
    if (!channelError && channelData) {
      bccEmails = channelData
        .map(c => c.email_address)
        .filter(e => e && e.trim() && e.includes('@'));
      console.log('[handleMagicLink] BCC emails:', bccEmails);
    } else if (channelError) {
      console.warn('[handleMagicLink] Error fetching BCC channels:', channelError);
      // Continue without BCC - don't fail the whole operation
    }

    // Step 3: Generate magic link
    console.log('[handleMagicLink] User found, generating magic link');

    const redirectTo = `${window.location.origin}/account-profile/${userData._id}`;

    const { data: magicLinkData, error: magicLinkError } = await supabase.functions.invoke('auth-user', {
      body: {
        action: 'generate_magic_link',
        payload: {
          email: email.toLowerCase().trim(),
          redirectTo: redirectTo
        }
      }
    });

    if (magicLinkError || !magicLinkData?.success) {
      console.error('[handleMagicLink] Error generating magic link:', magicLinkError || magicLinkData);
      // Don't expose error - show success for security
      showSuccessMessage();
      setIsLoading(false);
      return;
    }

    const magicLink = magicLinkData.data.action_link;
    const firstName = userData['Name - First'] || 'there';

    // Step 4: Send magic link email using send-email edge function
    console.log('[handleMagicLink] Sending magic link email');

    // Build the body text with the user's first name
    const bodyText = `Hi ${firstName}. Please use the link below to log in to your Split Lease account. Once logged in, you can update your password from the profile page. Please feel free to text (937) 673-7470 with any queries.`;

    const { data: emailData, error: emailError } = await supabase.functions.invoke('send-email', {
      body: {
        action: 'send',
        payload: {
          template_id: '1757433099447x202755280527849400', // Security 2 template
          to_email: email.toLowerCase().trim(),
          variables: {
            toemail: email.toLowerCase().trim(),
            fromemail: 'tech@leasesplit.com',
            fromname: 'Split Lease',
            subject: 'Your Split Lease Magic Login Link',
            preheadertext: 'Click the link to log in without a password',
            title: 'Magic Login Link',
            bodytext: bodyText,
            buttonurl: magicLink,
            buttontext: 'Log In Now',
            bannertext1: 'SECURITY NOTICE',
            bannertext2: 'This link expires in 1 hour',
            bannertext3: "If you didn't request this, please ignore this email",
            footermessage: 'For your security, never share this link with anyone.',
            cc: '',  // No CC for user-facing emails
            bcc: ''  // BCC handled via bcc_emails array
          },
          // Dynamic BCC from os_slack_channels
          ...(bccEmails.length > 0 && { bcc_emails: bccEmails })
        }
      }
    });

    if (emailError) {
      console.error('[handleMagicLink] Error sending email:', emailError);
      // Still show success for security
    } else {
      console.log('[handleMagicLink] Magic link email sent successfully');
    }

    showSuccessMessage();

  } catch (err) {
    console.error('[handleMagicLink] Unexpected error:', err);
    // Don't expose error - show success for security
    showSuccessMessage();
  }

  setIsLoading(false);
};
```

**Key Implementation Notes**:

1. **Security-First Approach**: Always show the same success message regardless of whether:
   - The email exists or not
   - The magic link generation succeeds or fails
   - The email sending succeeds or fails

2. **User Lookup**: Uses Supabase direct query to `public.user` table to check if email exists and get first name

3. **Dynamic BCC Lookup**: Fetches BCC email addresses from `reference_table.os_slack_channels`:
   - Queries channels: `bots_log`, `customer_activation`
   - Filters out invalid emails (null, empty, missing @)
   - Continues without BCC if lookup fails (non-critical)

4. **Magic Link Generation**: Calls the existing `generate_magic_link` action on `auth-user` edge function

5. **Email Sending**: Calls `send-email` edge function with:
   - `send` action with proper template variables
   - `bcc_emails` array from dynamic lookup

6. **Redirect URL**: Uses `/account-profile/{userId}` as the redirect after magic link authentication

**Validation**:
- Test with existing email - should receive email with magic link
- Test with non-existing email - should show same success message
- Click magic link - should authenticate and redirect to profile page
- Verify BCC emails are sent (check Slack channels)

### Step 2: Update send-email Edge Function to Support bcc_emails Array

**Files**: `supabase/functions/send-email/handlers/send.ts`
**Purpose**: Ensure the send handler processes `bcc_emails` array and incorporates them into SendGrid payload

**Details**:

Looking at the current implementation, the `handleSend` function in `send.ts` needs to:
1. Accept `bcc_emails` in the payload
2. Incorporate BCC into the SendGrid JSON before sending

**Update types.ts** to include bcc_emails:
```typescript
// In supabase/functions/send-email/lib/types.ts
export interface SendEmailPayload {
  template_id: string;
  to_email: string;
  to_name?: string;
  from_email?: string;
  from_name?: string;
  subject?: string;
  variables: Record<string, string>;
  cc_emails?: string[];   // Add this
  bcc_emails?: string[];  // Add this
}
```

**Update send.ts** to process bcc_emails:
```typescript
// After line 44 (destructure additional fields):
const {
  template_id,
  to_email,
  to_name,
  from_email,
  from_name,
  subject: providedSubject,
  variables,
  cc_emails,    // Add this
  bcc_emails,   // Add this
} = payload as SendEmailPayload;

// Before Step 3 (around line 139), inject BCC into personalization:
// After parsing sendGridBody, add BCC if provided
if (bcc_emails && bcc_emails.length > 0) {
  const personalizations = sendGridBody.personalizations as Array<Record<string, unknown>>;
  if (personalizations && personalizations.length > 0) {
    personalizations[0].bcc = bcc_emails.map(email => ({ email }));
    console.log('[send-email:send] Added BCC recipients:', bcc_emails.length);
  }
}

// Similarly for CC:
if (cc_emails && cc_emails.length > 0) {
  const personalizations = sendGridBody.personalizations as Array<Record<string, unknown>>;
  if (personalizations && personalizations.length > 0) {
    personalizations[0].cc = cc_emails.map(email => ({ email }));
    console.log('[send-email:send] Added CC recipients:', cc_emails.length);
  }
}
```

**Validation**:
- Test sending email with bcc_emails array
- Verify SendGrid receives BCC recipients
- Verify BCC recipients receive the email
- Verify CC works if needed in future

### Step 3: Add Authorization Bypass for Magic Link Emails

**Files**: `supabase/functions/send-email/index.ts`
**Purpose**: Allow unauthenticated requests to send magic link emails specifically

**Details**:

The current `send-email` function requires a Bearer token. Since magic link requests come from unauthenticated users (they can't log in, that's why they need the magic link), we need to handle this case.

**Approach**: Allow anon key (automatically included by `supabase.functions.invoke()`) for specific template IDs.

In `supabase/functions/send-email/index.ts`, modify the authorization check:

```typescript
if (body.action === 'send') {
  const authHeader = req.headers.get("Authorization");

  // Templates that can be sent without user authentication
  // (anon key is still required via Supabase client)
  const PUBLIC_TEMPLATES = [
    '1757433099447x202755280527849400', // Security 2 - Magic Login Link
  ];

  const templateId = body.payload?.template_id;
  const isPublicTemplate = PUBLIC_TEMPLATES.includes(templateId);

  if (!isPublicTemplate) {
    // Require authenticated user for non-public templates
    if (!authHeader || !authHeader.startsWith("Bearer ")) {
      throw new AuthenticationError("Missing or invalid Authorization header. Use Bearer token.");
    }

    const token = authHeader.replace("Bearer ", "");
    if (!token) {
      throw new AuthenticationError("Empty Bearer token");
    }

    // Could add user validation here if needed
  }

  console.log(`[send-email] Authorization: ${isPublicTemplate ? 'Public template (anon allowed)' : 'Bearer token present'}`);
}
```

**Security Note**: The anon key is still required (Supabase client includes it automatically). This only bypasses the user authentication check, not the Supabase auth entirely.

**Validation**:
- Test sending magic link email from unauthenticated context
- Verify regular (non-public) templates still require authentication
- Verify attempts to use public bypass for wrong templates are rejected

## Edge Cases & Error Handling

| Edge Case | Handling |
|-----------|----------|
| Empty email field | Show validation error "Please enter your email address first" |
| Email doesn't exist in database | Show success message (security - don't reveal if email exists) |
| Magic link generation fails | Log error, show success message (security) |
| Email sending fails | Log error, show success message (security) |
| User has no first name | Default to "there" in the greeting |
| Network error | Catch in try/catch, show success message (security) |
| os_slack_channels lookup fails | Continue without BCC (non-critical, logged) |
| Invalid email in os_slack_channels | Filter out (check for @ symbol) |

## Testing Considerations

1. **Manual Testing**:
   - Test with valid email that exists in database
   - Test with email that doesn't exist
   - Test with malformed email
   - Test clicking the magic link
   - Verify redirect works after authentication
   - Verify BCC emails arrive in Slack channels

2. **Security Testing**:
   - Verify same message shown for existing/non-existing emails
   - Verify no error details exposed to user
   - Verify magic link expires after use
   - Verify non-public templates still require auth

3. **Email Testing**:
   - Check email renders correctly
   - Verify all placeholders are replaced
   - Test on multiple email clients (Gmail, Outlook, etc.)
   - Verify magic link URL is correct and clickable
   - Verify BCC recipients receive copy

4. **BCC Testing**:
   - Check `bots_log` Slack channel for email notification
   - Check `customer_activation` Slack channel for email notification
   - Verify BCC is not visible to user

## Rollback Strategy

If issues arise:
1. Revert `handleMagicLink` function to previous implementation
2. If send-email changes cause issues, revert those changes
3. The `generate_magic_link` action in auth-user can remain as it's already deployed

## Dependencies & Blockers

- **Required**: `generate_magic_link` action in auth-user edge function (already deployed)
- **Required**: send-email edge function (already deployed)
- **Required**: "Security 2" email template in database (already exists)
- **Required**: `os_slack_channels` table populated (already exists with data)
- **Needs Update**: send-email to support bcc_emails array
- **Needs Update**: send-email to allow public templates for unauthenticated users

## Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Email enumeration attack | Low | Medium | Always show same success message |
| Magic link abuse (spam) | Low | Low | Link expires in 1 hour, rate limiting on Supabase |
| SendGrid API failure | Low | Medium | Log errors, show generic success |
| User confusion about next steps | Medium | Low | Clear email copy with instructions |
| BCC lookup failure | Low | Low | Continue without BCC, log warning |
| Public template bypass abuse | Low | Low | Limited to specific template IDs |

## File References Summary

### Files to Modify
1. `c:\Users\Split Lease\Documents\Split Lease\app\src\islands\shared\SignUpLoginModal.jsx` - Rewrite handleMagicLink function
2. `c:\Users\Split Lease\Documents\Split Lease\supabase\functions\send-email\handlers\send.ts` - Add bcc_emails support
3. `c:\Users\Split Lease\Documents\Split Lease\supabase\functions\send-email\lib\types.ts` - Add bcc_emails type
4. `c:\Users\Split Lease\Documents\Split Lease\supabase\functions\send-email\index.ts` - Add public template bypass

### Reference Files (No Changes)
5. `c:\Users\Split Lease\Documents\Split Lease\app\src\islands\pages\useEmailUnitPageLogic.js` - CC/BCC pattern reference
6. `c:\Users\Split Lease\Documents\Split Lease\app\src\islands\pages\EmailUnitPage.jsx` - Multi-email UI reference
7. `c:\Users\Split Lease\Documents\Split Lease\supabase\functions\auth-user\handlers\generateMagicLink.ts`
8. `c:\Users\Split Lease\Documents\Split Lease\supabase\functions\auth-user\index.ts`
9. `c:\Users\Split Lease\Documents\Split Lease\supabase\functions\send-email\lib\templateProcessor.ts`

### Database References
- **User Table**: `public.user` - columns `_id`, `email`, `"Name - First"`
- **Email Template Table**: `reference_table.zat_email_html_template_eg_sendbasicemailwf_`
- **Template ID**: `1757433099447x202755280527849400` (Security 2)
- **Slack Channels Table**: `reference_table.os_slack_channels` - columns `name`, `email_address`
- **BCC Channels**: `bots_log`, `customer_activation`

---

**VERSION**: 2.0
**CREATED**: 2026-01-05
**UPDATED**: 2026-01-05
**AUTHOR**: Claude Code (Implementation Planner)
**CHANGES v2.0**:
- Added dynamic BCC email lookup from `os_slack_channels` table
- Added EmailUnitPage CC/BCC pattern reference
- Added step to update send-email to support `bcc_emails` array
- Added `bots_log` and `customer_activation` as recommended BCC channels
- Updated implementation code to fetch and use dynamic BCC emails
