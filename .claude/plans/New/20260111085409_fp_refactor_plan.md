# Functional Programming Refactoring Plan

Date: 2026-01-11
Target: agents/fp_audit_violations.json
Severity Filter: HIGH
Total Violations: 350

## Summary

| Type | Count | Priority |
|------|-------|----------|
| MUTATING_METHOD | 265 | High |
| IMPERATIVE_LOOP | 80 | High |
| IO_IN_CORE | 5 | High |

### Files by Violation Count (Top 25)

| File | Violations |
|------|------------|
| src/islands/pages/SelfListingPage/store/listingLocalStore.ts | 21 |
| src/lib/availabilityValidation.js | 16 |
| src/islands/pages/SelfListingPage/store/prepareListingSubmission.ts | 15 |
| src/islands/shared/LoggedInAvatar/LoggedInAvatar.jsx | 12 |
| src/islands/pages/ListingDashboardPage/components/AvailabilitySection.jsx | 11 |
| src/islands/pages/ListingDashboardPage/components/PricingEditSection.jsx | 10 |
| src/islands/pages/SelfListingPage/sections/Section1SpaceSnapshot.tsx | 10 |
| src/islands/pages/SelfListingPage/sections/Section5Rules.tsx | 10 |
| src/islands/shared/SearchScheduleSelector.jsx | 9 |
| src/lib/listingService.js | 8 |

---

~~~~~

## ðŸ”´ CHUNK 1: Replace .sort() with toSorted() in availabilityValidation.js:31

**File:** app/src/lib/availabilityValidation.js
**Line:** 31
**Violation:** MUTATING_METHOD - Using [...arr].sort() which still mutates the spread copy
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /favorite-listings, /guest-proposals, /host-proposals

**Current Code:**
```javascript
  const sorted = [...selectedDays].sort((a, b) => a - b);
```

**Refactored Code:**
```javascript
  const sorted = selectedDays.toSorted((a, b) => a - b);
```

**Why This Matters:**
While spreading before sort prevents mutation of the original, `toSorted()` is the modern, explicitly immutable method that clearly communicates intent. It's more efficient (no intermediate array) and follows the FP principle of preferring immutable operations.

**Testing:**
- [ ] Run unit tests for `isContiguousSelection` function
- [ ] Test week wrap-around cases (Fri-Sun, Sat-Tue)
- [ ] Verify search page schedule selection works

~~~~~

## ðŸ”´ CHUNK 2: Replace imperative loop with every() in availabilityValidation.js:38

**File:** app/src/lib/availabilityValidation.js
**Line:** 38
**Violation:** IMPERATIVE_LOOP - Using for loop with mutation for contiguity check
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /favorite-listings, /guest-proposals, /host-proposals

**Current Code:**
```javascript
  let isStandardContiguous = true;
  for (let i = 1; i < sorted.length; i++) {
    if (sorted[i] !== sorted[i - 1] + 1) {
      isStandardContiguous = false;
      break;
    }
  }
```

**Refactored Code:**
```javascript
  const isStandardContiguous = sorted.slice(1).every(
    (day, i) => day === sorted[i] + 1
  );
```

**Why This Matters:**
The `every()` method is declarative and expresses the intent "all consecutive pairs differ by 1" more clearly than an imperative loop with early exit. It also eliminates the mutable `let` variable.

**Testing:**
- [ ] Test contiguous selections: [1,2,3,4,5] should return true
- [ ] Test non-contiguous: [1,3,5] should return false
- [ ] Test single day and empty array edge cases

~~~~~

## ðŸ”´ CHUNK 3: Replace loop+push with Array.from() in availabilityValidation.js:65-66

**File:** app/src/lib/availabilityValidation.js
**Line:** 65-66
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Loop with push to build array
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /favorite-listings

**Current Code:**
```javascript
    const expectedNotSelected = [];
    for (let i = minNotSelected; i <= maxNotSelected; i++) {
      expectedNotSelected.push(i);
    }
```

**Refactored Code:**
```javascript
    const expectedNotSelected = Array.from(
      { length: maxNotSelected - minNotSelected + 1 },
      (_, i) => minNotSelected + i
    );
```

**Why This Matters:**
`Array.from()` with a mapping function creates the array declaratively in a single expression, eliminating both the mutable array and the imperative loop. The intent "create range from min to max" is clearer.

**Testing:**
- [ ] Test wrap-around case: selecting [5,6,0] (Fri-Sun)
- [ ] Verify expectedNotSelected generates correct range
- [ ] Edge case: all days selected (empty notSelectedDays)

~~~~~

## ðŸ”´ CHUNK 4: Replace .sort() with toSorted() in availabilityValidation.js:97

**File:** app/src/lib/availabilityValidation.js
**Line:** 97
**Violation:** MUTATING_METHOD - Duplicate pattern from isContiguousSelection
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /favorite-listings

**Current Code:**
```javascript
  const sorted = [...selectedDays].sort((a, b) => a - b);
```

**Refactored Code:**
```javascript
  const sorted = selectedDays.toSorted((a, b) => a - b);
```

**Why This Matters:**
Consistent use of `toSorted()` across the codebase improves maintainability and clearly signals immutable intent.

**Testing:**
- [ ] Run unit tests for `calculateCheckInOutDays` function
- [ ] Verify check-in/check-out day calculations are correct

~~~~~

## ðŸ”´ CHUNK 5: Replace imperative loop with every() in availabilityValidation.js:106

**File:** app/src/lib/availabilityValidation.js
**Line:** 106
**Violation:** IMPERATIVE_LOOP - Same pattern as CHUNK 2
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /favorite-listings

**Current Code:**
```javascript
  for (let i = 1; i < sorted.length; i++) {
    if (sorted[i] !== sorted[i - 1] + 1) {
      // handle wrap-around logic
    }
  }
```

**Refactored Code:**
```javascript
  const hasGap = sorted.slice(1).some(
    (day, i) => day !== sorted[i] + 1
  );
  if (hasGap) {
    // handle wrap-around logic
  }
```

**Why This Matters:**
Using `some()` to detect gaps is more declarative than a loop with conditional breaks.

**Testing:**
- [ ] Test check-in/check-out calculation with gaps
- [ ] Verify wrap-around detection works correctly

~~~~~

## ðŸ”´ CHUNK 6: Refactor validation errors to declarative array in availabilityValidation.js:166-305

**File:** app/src/lib/availabilityValidation.js
**Lines:** 166, 175, 181, 186, 199, 271, 280, 287, 294, 305
**Violation:** MUTATING_METHOD - Multiple result.errors.push() and result.warnings.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /favorite-listings

**Current Code:**
```javascript
const result = { errors: [], warnings: [], isValid: true };

if (!selectedDays?.length) {
  result.errors.push('Please select at least one day');
}
if (!isContiguous) {
  result.errors.push('Please check for contiguous nights to continue with your proposal');
}
if (selectedDays.length < minNights) {
  result.warnings.push(`Host prefers at least ${listing['Minimum Nights']} nights per week`);
}
// ... more push() calls
```

**Refactored Code:**
```javascript
const errors = [
  !selectedDays?.length && 'Please select at least one day',
  !isContiguous && 'Please check for contiguous nights to continue with your proposal',
  hasUnavailableDays && 'Some selected days are not available for this listing',
  !moveInDate && 'Please select a move-in date',
  moveInDateInPast && 'Move-in date cannot be in the past',
  moveInDateOutsideRange && 'Move-in date is outside available range',
  moveInDateNotAvailable && 'Selected move-in date is not available',
  moveInDayMismatch && `Move-in date must be on a ${DAY_NAMES[checkInDay]} based on your selected schedule`,
].filter(Boolean);

const warnings = [
  selectedDays.length < minNights && `Host prefers at least ${listing['Minimum Nights']} nights per week`,
  selectedDays.length > maxNights && `Host prefers at most ${listing['Maximum Nights']} nights per week`,
].filter(Boolean);

const result = {
  errors,
  warnings,
  isValid: errors.length === 0,
};
```

**Why This Matters:**
Declarative array construction with conditional expressions makes all validation rules visible at once, eliminates mutation, and simplifies adding/removing validation rules.

**Testing:**
- [ ] Test all error conditions trigger correctly
- [ ] Test all warning conditions trigger correctly
- [ ] Verify isValid flag is computed correctly

~~~~~

## ðŸ”´ CHUNK 7: Replace .sort() with toSorted() in isScheduleContiguous.js:55

**File:** app/src/logic/rules/scheduling/isScheduleContiguous.js
**Line:** 55
**Violation:** MUTATING_METHOD - Using [...arr].sort()
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /guest-proposals, /host-proposals

**Current Code:**
```javascript
  const sorted = [...selectedDayIndices].sort((a, b) => a - b)
```

**Refactored Code:**
```javascript
  const sorted = selectedDayIndices.toSorted((a, b) => a - b)
```

**Why This Matters:**
This is a rules layer function used throughout the app for schedule validation. Using `toSorted()` ensures true immutability.

**Testing:**
- [ ] Run unit tests for isScheduleContiguous
- [ ] Test all edge cases documented in JSDoc

~~~~~

## ðŸ”´ CHUNK 8: Replace imperative loop with every() in isScheduleContiguous.js:64

**File:** app/src/logic/rules/scheduling/isScheduleContiguous.js
**Line:** 64
**Violation:** IMPERATIVE_LOOP - Same pattern as availabilityValidation
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /guest-proposals, /host-proposals

**Current Code:**
```javascript
  let isStandardContiguous = true
  for (let i = 1; i < sorted.length; i++) {
    if (sorted[i] !== sorted[i - 1] + 1) {
      isStandardContiguous = false
      break
    }
  }
```

**Refactored Code:**
```javascript
  const isStandardContiguous = sorted.slice(1).every(
    (day, i) => day === sorted[i] + 1
  )
```

**Why This Matters:**
Consolidating this pattern across the codebase ensures consistency and reduces cognitive load when reading scheduling logic.

**Testing:**
- [ ] Verify contiguity check works for all test cases
- [ ] Compare behavior with availabilityValidation.js implementation

~~~~~

## ðŸ”´ CHUNK 9: Replace loop+push with Array.from() in isScheduleContiguous.js:95-96

**File:** app/src/logic/rules/scheduling/isScheduleContiguous.js
**Line:** 95-96
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Loop with push pattern
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /guest-proposals, /host-proposals

**Current Code:**
```javascript
    const expectedNotSelected = []
    for (let i = minNotSelected; i <= maxNotSelected; i++) {
      expectedNotSelected.push(i)
    }
```

**Refactored Code:**
```javascript
    const expectedNotSelected = Array.from(
      { length: maxNotSelected - minNotSelected + 1 },
      (_, i) => minNotSelected + i
    )
```

**Why This Matters:**
Same pattern as availabilityValidation.js - consolidate to declarative approach.

**Testing:**
- [ ] Test wrap-around week scenarios
- [ ] Verify expectedNotSelected range generation

~~~~~

## ðŸ”´ CHUNK 10: Remove console.warn I/O from proposalRules.js:306

**File:** app/src/logic/rules/proposals/proposalRules.js
**Line:** 306
**Violation:** IO_IN_CORE - console.warn in rules layer
**Severity:** ðŸ”´ High

**Affected Pages:** /guest-proposals, /host-proposals

**Current Code:**
```javascript
export function getCancellationReasonOptions() {
  // ... cache lookup logic
  console.warn('[getCancellationReasonOptions] Cache empty, using fallback values');
  return fallbackValues;
}
```

**Refactored Code:**
```javascript
export function getCancellationReasonOptions() {
  // ... cache lookup logic
  // Fallback is expected during initial load - no warning needed
  return fallbackValues;
}
```

**Why This Matters:**
Rules layer functions should be pure - no I/O operations including console output. If logging is needed, it should be handled in the workflow layer.

**Testing:**
- [ ] Verify function returns correct values
- [ ] Check that fallback behavior is documented

~~~~~

## ðŸ”´ CHUNK 11: Remove console.error I/O from extractListingCoordinates.js:46,62

**File:** app/src/logic/processors/listing/extractListingCoordinates.js
**Lines:** 46, 62
**Violation:** IO_IN_CORE - console.error in processors layer
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /listing-dashboard

**Current Code:**
```javascript
  if (!rawCoords) {
    console.error(
      'âŒ extractListingCoordinates: Failed to parse Location - Address:', {
        listingId,
        rawValue: locationAddress
      }
    );
    return null;
  }
```

**Refactored Code:**
```javascript
  if (!rawCoords) {
    // Return null to indicate parsing failure - caller should handle logging
    return null;
  }
```

**Why This Matters:**
Processors should transform data, not perform I/O. Error logging should be done at the workflow/handler layer where the processor is called.

**Testing:**
- [ ] Verify null is returned for invalid coordinates
- [ ] Check calling code handles null appropriately

~~~~~

## ðŸ”´ CHUNK 12: Remove console.warn I/O from extractListingCoordinates.js:98

**File:** app/src/logic/processors/listing/extractListingCoordinates.js
**Line:** 98
**Violation:** IO_IN_CORE - console.warn in processors layer
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /listing-dashboard

**Current Code:**
```javascript
  console.warn('âš ï¸ extractListingCoordinates: No valid coordinates found for listing:', {
    listingId,
    triedSources: ['Location - Address', 'Location - Latitude/Longitude']
  });
  return null;
```

**Refactored Code:**
```javascript
  // No valid coordinates found - return null for caller to handle
  return null;
```

**Why This Matters:**
Same principle - processors should be pure data transformers.

**Testing:**
- [ ] Verify null return for listings without coordinates
- [ ] Check map components handle null coordinates gracefully

~~~~~

## ðŸ”´ CHUNK 13: Remove console.warn I/O from processUserData.js:58

**File:** app/src/logic/processors/user/processUserData.js
**Line:** 58
**Violation:** IO_IN_CORE - console.warn in processors layer
**Severity:** ðŸ”´ High

**Affected Pages:** AUTO (affects user data processing across app)

**Current Code:**
```javascript
  if (!hasName) {
    console.warn(`processUserData: User ${rawUser._id} has no name fields, using default`)
  }
```

**Refactored Code:**
```javascript
  // Note: Users without name fields will use default - this is expected for some legacy records
```

**Why This Matters:**
Processors should focus on data transformation. Expected edge cases don't need runtime warnings - they can be documented in code comments.

**Testing:**
- [ ] Verify default name handling works correctly
- [ ] Test with users that have no name fields

~~~~~

## ðŸ”´ CHUNK 14: Replace .sort() with toSorted() in calculateCheckInOutDays.js:50

**File:** app/src/logic/calculators/scheduling/calculateCheckInOutDays.js
**Line:** 50
**Violation:** MUTATING_METHOD - Using [...arr].sort()
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease, /guest-proposals, /host-proposals

**Current Code:**
```javascript
  const sorted = [...selectedDays].sort((a, b) => a - b)
```

**Refactored Code:**
```javascript
  const sorted = selectedDays.toSorted((a, b) => a - b)
```

**Why This Matters:**
Calculator functions should be especially pure as they perform core business logic.

**Testing:**
- [ ] Run unit tests for calculateCheckInOutDays
- [ ] Verify check-in/check-out day determination

~~~~~

## ðŸ”´ CHUNK 15: Replace .sort() with toSorted() in calculateNextAvailableCheckIn.js:54

**File:** app/src/logic/calculators/scheduling/calculateNextAvailableCheckIn.js
**Line:** 54
**Violation:** MUTATING_METHOD - Using [...arr].sort()
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease

**Current Code:**
```javascript
  const sortedDays = [...selectedDayIndices].sort((a, b) => a - b)
```

**Refactored Code:**
```javascript
  const sortedDays = selectedDayIndices.toSorted((a, b) => a - b)
```

**Why This Matters:**
Consistent immutable patterns in calculator layer.

**Testing:**
- [ ] Test next available check-in date calculation
- [ ] Verify edge cases for week boundaries

~~~~~

## ðŸ”´ CHUNK 16: Refactor getMenuItems to declarative array in LoggedInAvatar.jsx:170-331

**File:** app/src/islands/shared/LoggedInAvatar/LoggedInAvatar.jsx
**Lines:** 170-331
**Violation:** MUTATING_METHOD - 12 items.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** ALL PAGES (global navigation component)

**Current Code:**
```javascript
  const getMenuItems = () => {
    const items = [];

    if (menuVisibility.myProfile) {
      items.push({
        id: 'profile',
        label: 'My Profile',
        icon: '/assets/icons/user-purple.svg',
        path: `/account-profile/${user.id}`,
      });
    }

    if (menuVisibility.myProposals) {
      items.push({
        id: 'proposals',
        label: 'My Proposals',
        // ...
      });
    }
    // ... 10 more conditional push() calls
    return items;
  };
```

**Refactored Code:**
```javascript
  const getMenuItems = () => {
    const listingsPath = effectiveListingsCount === 1 && effectiveFirstListingId
      ? `/listing-dashboard?id=${effectiveFirstListingId}`
      : '/host-overview';

    const vmQueryParam = effectiveVirtualMeetingsCount > 0
      ? '?scrollTo=virtual-meetings'
      : '?highlightVMButton=true';

    const allMenuItems = [
      menuVisibility.myProfile && {
        id: 'profile',
        label: 'My Profile',
        icon: '/assets/icons/user-purple.svg',
        path: `/account-profile/${user.id}`,
      },
      menuVisibility.myProposals && {
        id: 'proposals',
        label: 'My Proposals',
        icon: '/assets/icons/file-text-purple.svg',
        path: effectiveUserType === NORMALIZED_USER_TYPES.GUEST
          ? '/guest-proposals'
          : '/host-proposals',
        badgeCount: effectiveProposalsCount,
        badgeColor: 'purple',
      },
      menuVisibility.myProposalsSuggested && {
        id: 'proposals-suggested',
        label: 'Proposals Suggested',
        icon: '/assets/icons/file-text-purple.svg',
        path: '/proposals-suggested',
      },
      menuVisibility.myListings && {
        id: 'listings',
        label: 'My Listings',
        icon: '/assets/icons/list-purple.svg',
        path: listingsPath,
        badgeCount: effectiveListingsCount,
        badgeColor: 'purple',
      },
      menuVisibility.virtualMeetings && {
        id: 'virtual-meetings',
        label: 'Virtual Meetings',
        icon: '/assets/icons/video-purple.svg',
        path: effectiveUserType === NORMALIZED_USER_TYPES.GUEST
          ? `/guest-proposals${vmQueryParam}`
          : `/host-proposals${vmQueryParam}`,
        badgeCount: effectiveVirtualMeetingsCount,
        badgeColor: 'purple',
      },
      menuVisibility.houseManualsAndVisits && {
        id: 'house-manuals',
        label: 'House manuals & Visits',
        icon: '/assets/icons/book-open-purple.svg',
        path: effectiveUserType === NORMALIZED_USER_TYPES.GUEST
          ? '/guest-house-manual'
          : effectiveHouseManualsCount === 1
            ? '/host-house-manual'
            : '/host-overview',
      },
      menuVisibility.myLeases && {
        id: 'leases',
        label: 'My Leases',
        icon: '/assets/icons/key-purple.svg',
        path: effectiveUserType === NORMALIZED_USER_TYPES.GUEST
          ? '/guest-leases'
          : '/host-leases',
        badgeCount: effectiveLeasesCount,
        badgeColor: 'purple',
      },
      menuVisibility.myFavoriteListings && {
        id: 'favorites',
        label: 'My Favorite Listings',
        icon: '/assets/icons/heart-purple.svg',
        path: '/favorite-listings',
        badgeCount: effectiveFavoritesCount,
        badgeColor: 'purple',
      },
      menuVisibility.messages && {
        id: 'messages',
        label: 'Messages',
        icon: '/assets/icons/message-circle-purple.svg',
        path: '/messages',
        badgeCount: effectiveUnreadMessagesCount,
        badgeColor: 'red',
      },
      menuVisibility.rentalApplication && {
        id: 'rental-application',
        label: 'Rental Application',
        icon: '/assets/icons/clipboard-purple.svg',
        path: effectiveUserType === NORMALIZED_USER_TYPES.HOST
          ? '/account'
          : `/account-profile/${user.id}?section=rental-application`,
      },
      menuVisibility.reviewsManager && {
        id: 'reviews',
        label: 'Reviews Manager',
        icon: '/assets/icons/star-purple.svg',
        path: '/reviews-overview',
      },
      menuVisibility.referral && {
        id: 'referral',
        label: 'Referral',
        icon: '/assets/icons/gift-purple.svg',
        action: () => setShowReferralModal(true),
      },
    ];

    return allMenuItems.filter(Boolean);
  };
```

**Why This Matters:**
This high-visibility component is rendered on every page. Declarative array construction makes the menu structure visible at a glance and easier to maintain.

**Testing:**
- [ ] Test all menu items appear correctly for guests
- [ ] Test all menu items appear correctly for hosts
- [ ] Verify badge counts display correctly
- [ ] Test referral modal opens correctly

~~~~~

## ðŸ”´ CHUNK 17: Refactor validateForSubmission to declarative array in listingLocalStore.ts:387-454

**File:** app/src/islands/pages/SelfListingPage/store/listingLocalStore.ts
**Lines:** 387-454
**Violation:** MUTATING_METHOD - 18 errors.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
  validateForSubmission(): string[] {
    const errors: string[] = [];
    const data = this.state.data;

    if (!data.spaceSnapshot.listingName) {
      errors.push('Listing name is required');
    }
    if (!data.spaceSnapshot.typeOfSpace) {
      errors.push('Type of space is required');
    }
    // ... 16 more conditional push() calls
    return errors;
  }
```

**Refactored Code:**
```typescript
  validateForSubmission(): string[] {
    const data = this.state.data;
    const isNightly = data.leaseStyles.rentalType === 'Nightly';
    const isWeekly = data.leaseStyles.rentalType === 'Weekly';
    const isMonthly = data.leaseStyles.rentalType === 'Monthly';
    const hasAvailableNights = data.leaseStyles.availableNights &&
      Object.values(data.leaseStyles.availableNights).some(Boolean);

    return [
      // Section 1: Space Snapshot
      !data.spaceSnapshot.listingName && 'Listing name is required',
      !data.spaceSnapshot.typeOfSpace && 'Type of space is required',
      !data.spaceSnapshot.typeOfKitchen && 'Type of kitchen is required',
      !data.spaceSnapshot.typeOfParking && 'Type of parking is required',
      (!data.spaceSnapshot.address.fullAddress || !data.spaceSnapshot.address.validated) &&
        'Valid NYC address is required',

      // Section 2: Features
      data.features.amenitiesInsideUnit.length === 0 &&
        'At least one amenity inside unit is required',
      !data.features.descriptionOfLodging && 'Description of lodging is required',

      // Section 3: Lease Styles
      !data.leaseStyles.rentalType && 'Rental type is required',
      isNightly && !hasAvailableNights &&
        'At least one available night must be selected',
      isWeekly && !data.leaseStyles.weeklyPattern && 'Weekly pattern is required',

      // Section 4: Pricing
      data.pricing.damageDeposit < 500 && 'Damage deposit must be at least $500',
      isMonthly && !data.pricing.monthlyCompensation && 'Monthly compensation is required',
      isWeekly && !data.pricing.weeklyCompensation && 'Weekly compensation is required',
      isNightly && !data.pricing.nightlyPricing?.oneNightPrice &&
        'Nightly pricing is required',

      // Section 5: Rules
      !data.rules.cancellationPolicy && 'Cancellation policy is required',
      !data.rules.checkInTime && 'Check-in time is required',
      !data.rules.checkOutTime && 'Check-out time is required',

      // Section 6: Photos
      data.photos.photos.length < data.photos.minRequired &&
        `At least ${data.photos.minRequired} photos are required`,
    ].filter(Boolean) as string[];
  }
```

**Why This Matters:**
This validation function is critical for the listing creation flow. Declarative construction makes all validation rules visible at once and reduces mutation.

**Testing:**
- [ ] Test all validation rules trigger correctly
- [ ] Verify error messages are accurate
- [ ] Test edge cases (empty form, partial form)

~~~~~

## ðŸ”´ CHUNK 18: Refactor getChangeSummary to declarative array in PricingEditSection.jsx:321-375

**File:** app/src/islands/pages/ListingDashboardPage/components/PricingEditSection.jsx
**Lines:** 321-375
**Violation:** MUTATING_METHOD - 10 changes.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard

**Current Code:**
```javascript
  const getChangeSummary = () => {
    const changes = [];
    const originalLeaseStyle = listing?.leaseStyle || 'Nightly';

    if (selectedRentalType !== originalLeaseStyle) {
      changes.push(`Lease style: ${originalLeaseStyle} â†’ ${selectedRentalType}`);
    }
    if (damageDeposit !== (listing?.damageDeposit || 500)) {
      changes.push(`Damage deposit: $${listing?.damageDeposit || 500} â†’ $${damageDeposit}`);
    }
    // ... more conditional push() calls
    return changes;
  };
```

**Refactored Code:**
```javascript
  const getChangeSummary = () => {
    const originalLeaseStyle = listing?.leaseStyle || 'Nightly';
    const originalNights = listing?.nightsAvailable || [];
    const originalComp = listing?.weeklyCompensation || {};

    const nightsChanged = selectedNights.length !== originalNights.length ||
      !selectedNights.every((n) => originalNights.includes(n));
    const nightsRangeChanged = minNights !== (listing?.nightsPerWeekMin || 2) ||
      maxNights !== (listing?.nightsPerWeekMax || 7);
    const pricingChanged = [2, 3, 4, 5].some(
      (n) => nightlyPricing[n] !== (originalComp[n] || 0)
    );

    const patternLabels = {
      '1': '1 week on/off',
      '2': '2 weeks on/off',
      '3': '1 on, 3 off',
      'custom': 'Custom',
    };

    return [
      selectedRentalType !== originalLeaseStyle &&
        `Lease style: ${originalLeaseStyle} â†’ ${selectedRentalType}`,
      damageDeposit !== (listing?.damageDeposit || 500) &&
        `Damage deposit: $${listing?.damageDeposit || 500} â†’ $${damageDeposit}`,
      maintenanceFee !== (listing?.maintenanceFee || 125) &&
        `Maintenance fee: $${listing?.maintenanceFee || 125} â†’ $${maintenanceFee}`,

      // Nightly-specific
      selectedRentalType === 'Nightly' && nightsChanged &&
        `Available nights updated (${selectedNights.length} nights)`,
      selectedRentalType === 'Nightly' && nightsRangeChanged &&
        `Nights range: ${minNights}-${maxNights}`,
      selectedRentalType === 'Nightly' && pricingChanged &&
        'Nightly rates updated',

      // Weekly-specific
      selectedRentalType === 'Weekly' && weeklyRate !== (listing?.weeklyHostRate || 0) &&
        `Weekly rate: $${weeklyRate}/week`,
      selectedRentalType === 'Weekly' && weeksOffered !== (listing?.weeksOffered || '') &&
        `Weekly pattern: ${patternLabels[weeksOffered] || weeksOffered}`,

      // Monthly-specific
      selectedRentalType === 'Monthly' && monthlyRate !== (listing?.monthlyHostRate || 0) &&
        `Monthly rate: $${monthlyRate}/month`,
    ].filter(Boolean);
  };
```

**Why This Matters:**
Change summaries are user-facing. Declarative construction makes it easy to see all tracked changes at once.

**Testing:**
- [ ] Test change detection for all rental types
- [ ] Verify summary text is accurate
- [ ] Test when no changes are made (empty array)

~~~~~

## ðŸ”´ CHUNK 19: Refactor getCalendarDays to use Array.from() in AvailabilitySection.jsx:87-139

**File:** app/src/islands/pages/ListingDashboardPage/components/AvailabilitySection.jsx
**Lines:** 106-139
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - 3 loops with push()
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard

**Current Code:**
```javascript
  const getCalendarDays = () => {
    // ... setup code ...
    const days = [];

    // Previous month padding
    for (let i = startPadding - 1; i >= 0; i--) {
      const dayNum = prevMonth.getDate() - i;
      days.push({ day: dayNum, isCurrentMonth: false, isPast: date < today, date });
    }

    // Current month days
    for (let i = 1; i <= daysInMonth; i++) {
      days.push({ day: i, isCurrentMonth: true, isPast: date < today, date });
    }

    // Next month padding
    for (let i = 1; i <= remaining; i++) {
      days.push({ day: i, isCurrentMonth: false, isPast: false, date });
    }

    return days;
  };
```

**Refactored Code:**
```javascript
  const getCalendarDays = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const startPadding = firstDay.getDay();
    const daysInMonth = lastDay.getDate();
    const prevMonth = new Date(year, month, 0);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    const createDayInfo = (dayNum, monthOffset, checkPast = true) => {
      const actualMonth = month + monthOffset;
      const actualYear = monthOffset === -1 && month === 0 ? year - 1
        : monthOffset === 1 && month === 11 ? year + 1 : year;
      const actualMonthNorm = (actualMonth + 12) % 12;
      const date = new Date(actualYear, actualMonthNorm, dayNum);
      return {
        day: dayNum,
        isCurrentMonth: monthOffset === 0,
        isPast: checkPast && date < today,
        date,
      };
    };

    // Previous month padding
    const prevMonthDays = Array.from(
      { length: startPadding },
      (_, i) => createDayInfo(prevMonth.getDate() - startPadding + 1 + i, -1)
    );

    // Current month days
    const currentMonthDays = Array.from(
      { length: daysInMonth },
      (_, i) => createDayInfo(i + 1, 0)
    );

    // Next month padding (fill to 42 days = 6 weeks)
    const remaining = 42 - prevMonthDays.length - currentMonthDays.length;
    const nextMonthDays = Array.from(
      { length: remaining },
      (_, i) => createDayInfo(i + 1, 1, false)
    );

    return [...prevMonthDays, ...currentMonthDays, ...nextMonthDays];
  };
```

**Why This Matters:**
Calendar generation is a common pattern. Using `Array.from()` makes the structure clearer and eliminates mutation.

**Testing:**
- [ ] Test calendar renders correctly for all months
- [ ] Verify previous/next month padding is correct
- [ ] Test past date detection works

~~~~~

## ðŸ”´ CHUNK 20: Replace while+push with Array.from() in AvailabilitySection.jsx:45-48

**File:** app/src/islands/pages/ListingDashboardPage/components/AvailabilitySection.jsx
**Lines:** 45-48
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - while loop with push
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard

**Current Code:**
```javascript
const getDatesBetween = (startDate, endDate) => {
  // ... validation code ...
  const dates = [];
  const current = new Date(start);
  while (current <= end) {
    dates.push(formatDateKey(current));
    current.setDate(current.getDate() + 1);
  }
  return dates;
};
```

**Refactored Code:**
```javascript
const getDatesBetween = (startDate, endDate) => {
  const start = new Date(startDate);
  const end = new Date(endDate);
  if (start > end) {
    [start, end] = [end, start]; // Swap if needed - this is a one-time setup, not mutation
  }

  const dayCount = Math.floor((end - start) / (1000 * 60 * 60 * 24)) + 1;

  return Array.from({ length: dayCount }, (_, i) => {
    const date = new Date(start);
    date.setDate(start.getDate() + i);
    return formatDateKey(date);
  });
};
```

**Why This Matters:**
Date range generation using `Array.from()` is more predictable and avoids the mutable Date object pitfall.

**Testing:**
- [ ] Test date range generation for blocked dates
- [ ] Verify inclusive range (start and end dates included)
- [ ] Test edge case: start equals end

~~~~~

## ðŸ”´ CHUNK 21: Replace .sort() and .reverse() with toSorted() and toReversed() in AvailabilitySection.jsx:242-257

**File:** app/src/islands/pages/ListingDashboardPage/components/AvailabilitySection.jsx
**Lines:** 242, 253, 254
**Violation:** MUTATING_METHOD - .sort() and .reverse() mutations
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard

**Current Code:**
```javascript
const futureBlockedDates = blockedDates
  .filter(date => new Date(date) >= today)
  .sort();

const pastBlockedDates = blockedDates
  .filter(date => new Date(date) < today)
  .sort()
  .reverse(); // Most recent past dates first
```

**Refactored Code:**
```javascript
const futureBlockedDates = blockedDates
  .filter(date => new Date(date) >= today)
  .toSorted();

const pastBlockedDates = blockedDates
  .filter(date => new Date(date) < today)
  .toSorted()
  .toReversed(); // Most recent past dates first
```

**Why This Matters:**
Using `toSorted()` and `toReversed()` makes immutability explicit and prevents accidental mutations.

**Testing:**
- [ ] Verify blocked dates sort correctly
- [ ] Test past dates appear in reverse chronological order

~~~~~

## ðŸ”´ CHUNK 22: Replace loop+push with Array.from() in NightlyPricingLegend.jsx:26-27

**File:** app/src/islands/pages/ListingDashboardPage/components/NightlyPricingLegend.jsx
**Lines:** 26-27
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard

**Current Code:**
```javascript
  const nightsRange = [];
  for (let i = nightsPerWeekMin; i <= nightsPerWeekMax; i++) {
    nightsRange.push(i);
  }
```

**Refactored Code:**
```javascript
  const nightsRange = Array.from(
    { length: nightsPerWeekMax - nightsPerWeekMin + 1 },
    (_, i) => nightsPerWeekMin + i
  );
```

**Why This Matters:**
Simple range generation benefits from declarative `Array.from()` pattern.

**Testing:**
- [ ] Verify nights range displays correctly
- [ ] Test edge cases (min equals max)

~~~~~

## ðŸ”´ CHUNK 23: Refactor SearchScheduleSelector contiguity checks - Lines 319-345

**File:** app/src/islands/shared/SearchScheduleSelector.jsx
**Lines:** 319-345
**Violation:** MUTATING_METHOD + IMPERATIVE_LOOP - Multiple sort() and for loops
**Severity:** ðŸ”´ High

**Affected Pages:** /search

**Current Code:**
```javascript
const checkContiguous = (daysArray) => {
  if (daysArray.length <= 1) return true;

  const sortedDays = [...daysArray].sort((a, b) => a - b);

  // Check standard contiguous
  for (let i = 1; i < sortedDays.length; i++) {
    if (sortedDays[i] !== sortedDays[i - 1] + 1) {
      // Handle wrap-around...
    }
  }
  // ...
};
```

**Refactored Code:**
```javascript
const checkContiguous = (daysArray) => {
  if (daysArray.length <= 1) return true;

  const sortedDays = daysArray.toSorted((a, b) => a - b);

  // Check standard contiguous using every()
  const isStandardContiguous = sortedDays.slice(1).every(
    (day, i) => day === sortedDays[i] + 1
  );

  if (isStandardContiguous) return true;

  // Check wrap-around case
  const hasZero = sortedDays.includes(0);
  const hasSix = sortedDays.includes(6);

  if (!hasZero || !hasSix) return false;

  // Wrap-around: check if unselected days are contiguous
  const notSelected = [0, 1, 2, 3, 4, 5, 6].filter(d => !sortedDays.includes(d));
  if (notSelected.length === 0) return true;

  return notSelected.slice(1).every(
    (day, i) => day === notSelected[i] + 1
  );
};
```

**Why This Matters:**
This component handles schedule selection on the main search page - a critical user flow.

**Testing:**
- [ ] Test standard contiguous selections work
- [ ] Test wrap-around selections work
- [ ] Verify non-contiguous selections are flagged

~~~~~

## ðŸ”´ CHUNK 24: Replace .sort() with toSorted() in HostScheduleSelector utils.js:25

**File:** app/src/islands/shared/HostScheduleSelector/utils.js
**Line:** 25
**Violation:** MUTATING_METHOD - .sort() in utility function
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard, /host-proposals

**Current Code:**
```javascript
const numbers = ids
  .map(id => nightIdToNumber(id))
  .filter(n => n !== null)
  .sort((a, b) => a - b)
```

**Refactored Code:**
```javascript
const numbers = ids
  .map(id => nightIdToNumber(id))
  .filter(n => n !== null)
  .toSorted((a, b) => a - b)
```

**Why This Matters:**
Utility functions should be especially pure as they're reused throughout the app.

**Testing:**
- [ ] Test gap detection in schedule selector
- [ ] Verify night ordering works correctly

~~~~~

## ðŸ”´ CHUNK 25: Replace loops with Array.from() in HostScheduleSelector utils.js:59-65

**File:** app/src/islands/shared/HostScheduleSelector/utils.js
**Lines:** 59-65
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Two loops with push
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard, /host-proposals

**Current Code:**
```javascript
  const sequence = [];
  if (startIdx <= endIdx) {
    for (let i = startIdx; i <= endIdx; i++) {
      sequence.push(getNightByDayIndex(i).id);
    }
  } else {
    for (let i = startIdx; i >= endIdx; i--) {
      sequence.push(getNightByDayIndex(i).id);
    }
  }
```

**Refactored Code:**
```javascript
  const sequence = startIdx <= endIdx
    ? Array.from(
        { length: endIdx - startIdx + 1 },
        (_, i) => getNightByDayIndex(startIdx + i).id
      )
    : Array.from(
        { length: startIdx - endIdx + 1 },
        (_, i) => getNightByDayIndex(startIdx - i).id
      );
```

**Why This Matters:**
Sequence generation benefits from declarative construction that clearly shows the range being created.

**Testing:**
- [ ] Test sequence generation in both directions
- [ ] Verify night IDs are correct

~~~~~

## ðŸ”´ CHUNK 26: Replace .sort() with toSorted() in HostScheduleSelector utils.js:133

**File:** app/src/islands/shared/HostScheduleSelector/utils.js
**Line:** 133
**Violation:** MUTATING_METHOD - [...arr].sort()
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard, /host-proposals

**Current Code:**
```javascript
  return [...nights].sort((a, b) => {
    return nightIdToNumber(a) - nightIdToNumber(b);
  });
```

**Refactored Code:**
```javascript
  return nights.toSorted((a, b) => nightIdToNumber(a) - nightIdToNumber(b));
```

**Why This Matters:**
Consistent use of toSorted() across the codebase.

**Testing:**
- [ ] Verify night sorting works correctly
- [ ] Test with various night combinations

~~~~~

## ðŸ”´ CHUNK 27: Refactor class building to declarative array in HostScheduleSelector.jsx:248-316

**File:** app/src/islands/shared/HostScheduleSelector/HostScheduleSelector.jsx
**Lines:** 248-316
**Violation:** MUTATING_METHOD - 8 classes.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /listing-dashboard, /host-proposals

**Current Code:**
```javascript
const getNightClasses = (night) => {
  const classes = ['hss-night'];

  if (isSelected) classes.push('hss-selected');
  if (hasNonContiguousGap) classes.push('hss-non-contiguous');
  if (!isAvailable) classes.push('hss-unavailable');
  if (isDisabled) classes.push('hss-disabled');
  // ...
  return classes.join(' ');
};

const getWrapperClasses = () => {
  const classes = ['host-schedule-selector'];
  if (previewMode) classes.push('hss-preview-mode');
  if (stepByStepMode) classes.push('hss-step-by-step-mode');
  if (proposalMode) classes.push('hss-proposal-mode');
  if (className) classes.push(className);
  return classes.join(' ');
};
```

**Refactored Code:**
```javascript
const getNightClasses = (night) => {
  return [
    'hss-night',
    isSelected && 'hss-selected',
    hasNonContiguousGap && 'hss-non-contiguous',
    !isAvailable && 'hss-unavailable',
    isDisabled && 'hss-disabled',
  ].filter(Boolean).join(' ');
};

const getWrapperClasses = () => {
  return [
    'host-schedule-selector',
    previewMode && 'hss-preview-mode',
    stepByStepMode && 'hss-step-by-step-mode',
    proposalMode && 'hss-proposal-mode',
    className,
  ].filter(Boolean).join(' ');
};
```

**Why This Matters:**
CSS class construction is a common pattern. Declarative array filtering is cleaner and more maintainable.

**Testing:**
- [ ] Verify all CSS classes apply correctly
- [ ] Test different selector modes
- [ ] Check disabled/unavailable states render correctly

~~~~~

## ðŸ”´ CHUNK 28: Replace .sort() with toSorted() in dayHelpers.js:44

**File:** app/src/lib/scheduleSelector/dayHelpers.js
**Line:** 44
**Violation:** MUTATING_METHOD - [...arr].sort()
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease

**Current Code:**
```javascript
  return [...days].sort((a, b) => a.dayOfWeek - b.dayOfWeek);
```

**Refactored Code:**
```javascript
  return days.toSorted((a, b) => a.dayOfWeek - b.dayOfWeek);
```

**Why This Matters:**
Schedule selector helpers are reused across multiple pages.

**Testing:**
- [ ] Test day sorting in schedule selector
- [ ] Verify day ordering is correct

~~~~~

## ðŸ”´ CHUNK 29: Replace loop+push with slice and map in dayHelpers.js:112-113

**File:** app/src/lib/scheduleSelector/dayHelpers.js
**Lines:** 112-113
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease

**Current Code:**
```javascript
  const nights = [];
  for (let i = 0; i < sortedDays.length - 1; i++) {
    nights.push(createNight(sortedDays[i].dayOfWeek));
  }
```

**Refactored Code:**
```javascript
  const nights = sortedDays
    .slice(0, -1)
    .map(day => createNight(day.dayOfWeek));
```

**Why This Matters:**
Using slice and map is more declarative than loop with push for this transformation.

**Testing:**
- [ ] Test night creation from days
- [ ] Verify correct number of nights generated

~~~~~

## ðŸ”´ CHUNK 30: Replace loop+push with slice and map in nightCalculations.js:14-15

**File:** app/src/lib/scheduleSelector/nightCalculations.js
**Lines:** 14-15
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Same pattern as dayHelpers
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease

**Current Code:**
```javascript
  const nights = [];
  for (let i = 0; i < sorted.length - 1; i++) {
    nights.push(createNight(sorted[i].dayOfWeek));
  }
```

**Refactored Code:**
```javascript
  const nights = sorted
    .slice(0, -1)
    .map(day => createNight(day.dayOfWeek));
```

**Why This Matters:**
Consistent pattern across scheduling utilities.

**Testing:**
- [ ] Test night calculations
- [ ] Verify output matches previous behavior

~~~~~

## ðŸ”´ CHUNK 31: Replace loop+push with Array.from() in validators.js:101-102

**File:** app/src/lib/scheduleSelector/validators.js
**Lines:** 101-102
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /view-split-lease

**Current Code:**
```javascript
  const expectedNotSelected = [];
  for (let i = minNotSelected; i <= maxNotSelected; i++) {
    expectedNotSelected.push(i);
  }
```

**Refactored Code:**
```javascript
  const expectedNotSelected = Array.from(
    { length: maxNotSelected - minNotSelected + 1 },
    (_, i) => minNotSelected + i
  );
```

**Why This Matters:**
Same pattern as isScheduleContiguous - range generation benefits from Array.from().

**Testing:**
- [ ] Test validator with wrap-around selections
- [ ] Verify expected range calculation

~~~~~

## ðŸ”´ CHUNK 32: Replace .sort() with toSorted() in dataLookups.js:598, 615

**File:** app/src/lib/dataLookups.js
**Lines:** 598, 615
**Violation:** MUTATING_METHOD - .sort() after building array
**Severity:** ðŸ”´ High

**Affected Pages:** /guest-proposals, /host-proposals

**Current Code:**
```javascript
  return reasons.sort((a, b) => a.displayOrder - b.displayOrder);
```

**Refactored Code:**
```javascript
  return reasons.toSorted((a, b) => a.displayOrder - b.displayOrder);
```

**Why This Matters:**
Data lookups should return new arrays rather than mutating.

**Testing:**
- [ ] Test cancellation reasons display in correct order
- [ ] Verify all reasons are included

~~~~~

## ðŸ”´ CHUNK 33: Refactor dataLookups.js to use declarative array construction:562-615

**File:** app/src/lib/dataLookups.js
**Lines:** 562, 592, 609
**Violation:** MUTATING_METHOD - Multiple .push() calls to build arrays
**Severity:** ðŸ”´ High

**Affected Pages:** /guest-proposals, /host-proposals

**Current Code:**
```javascript
export function getCancellationPolicies() {
  const policies = [];
  for (const [id, policy] of Object.entries(CANCELLATION_POLICIES)) {
    policies.push({ id, display: policy.display });
  }
  return policies;
}

export function getGuestCancellationReasons() {
  const reasons = [];
  for (const [id, reason] of Object.entries(GUEST_CANCEL_REASONS)) {
    reasons.push({ id, display: reason.display, displayOrder: reason.displayOrder });
  }
  return reasons.sort((a, b) => a.displayOrder - b.displayOrder);
}
```

**Refactored Code:**
```javascript
export function getCancellationPolicies() {
  return Object.entries(CANCELLATION_POLICIES).map(
    ([id, policy]) => ({ id, display: policy.display })
  );
}

export function getGuestCancellationReasons() {
  return Object.entries(GUEST_CANCEL_REASONS)
    .map(([id, reason]) => ({
      id,
      display: reason.display,
      displayOrder: reason.displayOrder
    }))
    .toSorted((a, b) => a.displayOrder - b.displayOrder);
}

export function getHostCancellationReasons() {
  return Object.entries(HOST_CANCEL_REASONS)
    .map(([id, reason]) => ({
      id,
      display: reason.display,
      displayOrder: reason.displayOrder
    }))
    .toSorted((a, b) => a.displayOrder - b.displayOrder);
}
```

**Why This Matters:**
Object.entries().map() is the idiomatic FP pattern for transforming objects to arrays.

**Testing:**
- [ ] Test all cancellation policies are returned
- [ ] Verify sort order for cancellation reasons

~~~~~

## ðŸ”´ CHUNK 34: Replace .sort() with toSorted() in listingDataFetcher.js:201

**File:** app/src/lib/listingDataFetcher.js
**Line:** 201
**Violation:** MUTATING_METHOD - Variable reassignment with sort
**Severity:** ðŸ”´ High

**Affected Pages:** /view-split-lease, /listing-dashboard

**Current Code:**
```javascript
  sortedPhotos = sortedPhotos.sort((a, b) => {
    return (a.Order || 0) - (b.Order || 0);
  });
```

**Refactored Code:**
```javascript
  sortedPhotos = sortedPhotos.toSorted((a, b) => (a.Order || 0) - (b.Order || 0));
```

**Why This Matters:**
Photo sorting is visible to users - consistent behavior is important.

**Testing:**
- [ ] Verify photos sort by Order field
- [ ] Test with photos missing Order field

~~~~~

## ðŸ”´ CHUNK 35: Refactor prepareListingSubmission.ts nights conversion:93-99

**File:** app/src/islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Lines:** 93-99
**Violation:** MUTATING_METHOD - 7 conditional push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
const convertNightsToArray = (nights: Record<string, boolean>): string[] => {
  const result: string[] = [];
  if (nights.sunday) result.push('sunday');
  if (nights.monday) result.push('monday');
  if (nights.tuesday) result.push('tuesday');
  if (nights.wednesday) result.push('wednesday');
  if (nights.thursday) result.push('thursday');
  if (nights.friday) result.push('friday');
  if (nights.saturday) result.push('saturday');
  return result;
};
```

**Refactored Code:**
```typescript
const NIGHT_KEYS = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'] as const;

const convertNightsToArray = (nights: Record<string, boolean>): string[] => {
  return NIGHT_KEYS.filter(night => nights[night]);
};
```

**Why This Matters:**
Filter is the declarative way to select items based on a condition - much cleaner than conditional pushes.

**Testing:**
- [ ] Test with various night combinations
- [ ] Verify order is maintained (sunday through saturday)

~~~~~

## ðŸ”´ CHUNK 36: Refactor prepareListingSubmission.ts validation:270-313

**File:** app/src/islands/pages/SelfListingPage/store/prepareListingSubmission.ts
**Lines:** 270-313
**Violation:** MUTATING_METHOD - 8 errors.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
const validatePayload = (payload: ListingPayload): string[] => {
  const errors: string[] = [];
  if (!payload.Name) errors.push('Name is required');
  if (!payload['Type of Space']) errors.push('Type of Space is required');
  // ... more conditional push calls
  return errors;
};
```

**Refactored Code:**
```typescript
const validatePayload = (payload: ListingPayload): string[] => {
  const isMonthly = payload['Rental Type'] === 'Monthly';
  const isWeekly = payload['Rental Type'] === 'Weekly';
  const isNightly = payload['Rental Type'] === 'Nightly';

  return [
    !payload.Name && 'Name is required',
    !payload['Type of Space'] && 'Type of Space is required',
    !payload.Address && 'Address is required',
    !payload['Rental Type'] && 'Rental Type is required',
    isMonthly && !payload['Monthly Compensation'] && 'Monthly Compensation is required for Monthly rentals',
    isWeekly && !payload['Weekly Compensation'] && 'Weekly Compensation is required for Weekly rentals',
    isNightly && !payload['Nightly Pricing'] && 'Nightly pricing is required for Nightly rentals',
    (payload['Damage Deposit'] ?? 0) < 500 && 'Damage Deposit must be at least $500',
  ].filter(Boolean) as string[];
};
```

**Why This Matters:**
Validation logic benefits from being visible at a glance in a single array.

**Testing:**
- [ ] Test all validation conditions
- [ ] Verify error messages are accurate

~~~~~

## ðŸ”´ CHUNK 37: Refactor Section error collection patterns in SelfListingPage sections

**File:** app/src/islands/pages/SelfListingPage/sections/Section1SpaceSnapshot.tsx
**Lines:** 291-334
**Violation:** MUTATING_METHOD - 10 errorOrder.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
const validateAndScrollToErrors = () => {
  const errorOrder: string[] = [];

  if (!listingName?.trim()) {
    errorOrder.push('listingName');
  } else if (listingName.trim().length < 5) {
    errorOrder.push('listingName');
  }
  if (!typeOfSpace) {
    errorOrder.push('typeOfSpace');
  }
  // ... more conditional push calls

  return errorOrder;
};
```

**Refactored Code:**
```typescript
const validateAndScrollToErrors = () => {
  const errorOrder = [
    (!listingName?.trim() || listingName.trim().length < 5) && 'listingName',
    !typeOfSpace && 'typeOfSpace',
    !bedrooms && 'bedrooms',
    !typeOfKitchen && 'typeOfKitchen',
    !typeOfParking && 'typeOfParking',
    !bathrooms && 'bathrooms',
    (!fullAddress || !addressValidated) && 'fullAddress',
    addressValidated && !state && 'state',
  ].filter(Boolean) as string[];

  return errorOrder;
};
```

**Why This Matters:**
Error field ordering is important for UX - declarative construction makes the order explicit.

**Testing:**
- [ ] Test all validation rules in Section 1
- [ ] Verify scroll-to-error behavior works

~~~~~

## ðŸ”´ CHUNK 38: Apply same pattern to Section2Features.tsx:207-212

**File:** app/src/islands/pages/SelfListingPage/sections/Section2Features.tsx
**Lines:** 207-212
**Violation:** MUTATING_METHOD - 2 errorOrder.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
const validateSection = () => {
  const errorOrder: string[] = [];

  if (amenitiesInsideUnit.length === 0) {
    errorOrder.push('amenitiesInsideUnit');
  }
  if (!descriptionOfLodging) {
    errorOrder.push('descriptionOfLodging');
  }

  return errorOrder;
};
```

**Refactored Code:**
```typescript
const validateSection = () => {
  return [
    amenitiesInsideUnit.length === 0 && 'amenitiesInsideUnit',
    !descriptionOfLodging && 'descriptionOfLodging',
  ].filter(Boolean) as string[];
};
```

**Why This Matters:**
Consistent validation pattern across all sections.

**Testing:**
- [ ] Test Section 2 validation
- [ ] Verify error fields are correct

~~~~~

## ðŸ”´ CHUNK 39: Apply same pattern to Section3LeaseStyles.tsx:132-137

**File:** app/src/islands/pages/SelfListingPage/sections/Section3LeaseStyles.tsx
**Lines:** 132-137
**Violation:** MUTATING_METHOD - 2 errorOrder.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
const validateSection = () => {
  const errorOrder: string[] = [];

  if (rentalType === 'Weekly' && !weeklyPattern) {
    errorOrder.push('weeklyPattern');
  }
  if (!subsidyAgreement) {
    errorOrder.push('subsidyAgreement');
  }

  return errorOrder;
};
```

**Refactored Code:**
```typescript
const validateSection = () => {
  return [
    rentalType === 'Weekly' && !weeklyPattern && 'weeklyPattern',
    !subsidyAgreement && 'subsidyAgreement',
  ].filter(Boolean) as string[];
};
```

**Why This Matters:**
Consistent validation pattern.

**Testing:**
- [ ] Test Section 3 validation for Weekly rental type
- [ ] Verify subsidy agreement validation

~~~~~

## ðŸ”´ CHUNK 40: Apply same pattern to Section4Pricing.tsx:50-67

**File:** app/src/islands/pages/SelfListingPage/sections/Section4Pricing.tsx
**Lines:** 50-67
**Violation:** MUTATING_METHOD - 4 errorOrder.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
const validateSection = () => {
  const errorOrder: string[] = [];

  if (rentalType === 'Monthly' && !monthlyCompensation) {
    errorOrder.push('monthlyCompensation');
  }
  if (rentalType === 'Weekly' && !weeklyCompensation) {
    errorOrder.push('weeklyCompensation');
  }
  if (rentalType === 'Nightly' && !nightlyPricing?.oneNightPrice) {
    errorOrder.push('nightlyPricing');
  }
  if (damageDeposit < 500) {
    errorOrder.push('damageDeposit');
  }

  return errorOrder;
};
```

**Refactored Code:**
```typescript
const validateSection = () => {
  return [
    rentalType === 'Monthly' && !monthlyCompensation && 'monthlyCompensation',
    rentalType === 'Weekly' && !weeklyCompensation && 'weeklyCompensation',
    rentalType === 'Nightly' && !nightlyPricing?.oneNightPrice && 'nightlyPricing',
    damageDeposit < 500 && 'damageDeposit',
  ].filter(Boolean) as string[];
};
```

**Why This Matters:**
Consistent validation pattern.

**Testing:**
- [ ] Test Section 4 validation for all rental types
- [ ] Verify damage deposit minimum validation

~~~~~

## ðŸ”´ CHUNK 41: Apply same pattern to Section5Rules.tsx:178-198

**File:** app/src/islands/pages/SelfListingPage/sections/Section5Rules.tsx
**Lines:** 178-198
**Violation:** MUTATING_METHOD - 5 errorOrder.push() calls
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
const validateSection = () => {
  const errorOrder: string[] = [];

  if (!cancellationPolicy) {
    errorOrder.push('cancellationPolicy');
  }
  if (!idealMinDuration) {
    errorOrder.push('idealMinDuration');
  }
  if (!idealMaxDuration) {
    errorOrder.push('idealMaxDuration');
  }
  if (idealMinDuration && idealMaxDuration && idealMinDuration > idealMaxDuration) {
    errorOrder.push('idealMaxDuration');
  }

  return errorOrder;
};
```

**Refactored Code:**
```typescript
const validateSection = () => {
  const durationInvalid = idealMinDuration && idealMaxDuration &&
    idealMinDuration > idealMaxDuration;

  return [
    !cancellationPolicy && 'cancellationPolicy',
    !idealMinDuration && 'idealMinDuration',
    !idealMaxDuration && 'idealMaxDuration',
    durationInvalid && 'idealMaxDuration',
  ].filter(Boolean) as string[];
};
```

**Why This Matters:**
Consistent validation pattern.

**Testing:**
- [ ] Test Section 5 validation
- [ ] Verify min/max duration comparison

~~~~~

## ðŸ”´ CHUNK 42: Apply same pattern to Section6Photos.tsx:266

**File:** app/src/islands/pages/SelfListingPage/sections/Section6Photos.tsx
**Line:** 266
**Violation:** MUTATING_METHOD - 1 errorOrder.push() call
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
const validateSection = () => {
  const errorOrder: string[] = [];

  if (photos.length < minRequired) {
    errorOrder.push('photos');
  }

  return errorOrder;
};
```

**Refactored Code:**
```typescript
const validateSection = () => {
  return [
    photos.length < minRequired && 'photos',
  ].filter(Boolean) as string[];
};
```

**Why This Matters:**
Consistent validation pattern across all sections.

**Testing:**
- [ ] Test Section 6 photo validation
- [ ] Verify minimum photo count is enforced

~~~~~

## ðŸ”´ CHUNK 43: Refactor calendar generation in Section5Rules.tsx:103-147

**File:** app/src/islands/pages/SelfListingPage/sections/Section5Rules.tsx
**Lines:** 103-147
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD - Multiple loops with push
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
const generateDatesInRange = (start: Date, end: Date): Date[] => {
  const dates: Date[] = [];
  const current = new Date(start);
  while (current <= end) {
    dates.push(new Date(current));
    current.setDate(current.getDate() + 1);
  }
  return dates;
};

const generateCalendarDays = () => {
  const days: (Date | null)[] = [];

  for (let i = 0; i < startingDayOfWeek; i++) {
    days.push(null);
  }

  for (let d = 1; d <= daysInMonth; d++) {
    days.push(new Date(year, month, d));
  }

  return days;
};
```

**Refactored Code:**
```typescript
const generateDatesInRange = (start: Date, end: Date): Date[] => {
  const dayCount = Math.floor((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24)) + 1;

  return Array.from({ length: dayCount }, (_, i) => {
    const date = new Date(start);
    date.setDate(start.getDate() + i);
    return date;
  });
};

const generateCalendarDays = () => {
  const padding = Array.from({ length: startingDayOfWeek }, () => null);
  const monthDays = Array.from(
    { length: daysInMonth },
    (_, i) => new Date(year, month, i + 1)
  );

  return [...padding, ...monthDays];
};
```

**Why This Matters:**
Calendar/date generation is a common pattern that benefits from Array.from().

**Testing:**
- [ ] Test date range generation
- [ ] Verify calendar displays correctly

~~~~~

## ðŸ”´ CHUNK 44: Refactor price generation in NightlyPriceSlider.tsx:70-71

**File:** app/src/islands/pages/SelfListingPage/components/NightlyPriceSlider.tsx
**Lines:** 70-71
**Violation:** IMPERATIVE_LOOP + MUTATING_METHOD
**Severity:** ðŸ”´ High

**Affected Pages:** /self-listing

**Current Code:**
```typescript
const prices = [basePrice];
for (let i = 1; i < N; i++) {
  prices.push(roundUp(prices[i - 1] * decay));
}
```

**Refactored Code:**
```typescript
const prices = Array.from({ length: N }, (_, i) => {
  if (i === 0) return basePrice;
  // Each price is previous price * decay, so it's basePrice * decay^i
  return roundUp(basePrice * Math.pow(decay, i));
});
```

**Why This Matters:**
Price calculations should be predictable and based on pure formulas.

**Testing:**
- [ ] Test price decay calculation
- [ ] Verify prices match expected decay curve

~~~~~

## ðŸ”´ CHUNK 45: Refactor location parts building in multiple files

**File:** app/src/islands/pages/useSearchPageLogic.js
**Lines:** 148-149
**Violation:** MUTATING_METHOD - Conditional push for location parts
**Severity:** ðŸ”´ High

**Affected Pages:** /search, /favorite-listings

**Current Code:**
```javascript
const locationParts = [];
if (neighborhoodName) locationParts.push(neighborhoodName);
if (boroughName) locationParts.push(boroughName);
const displayLocation = locationParts.join(', ') || 'New York';
```

**Refactored Code:**
```javascript
const displayLocation = [neighborhoodName, boroughName]
  .filter(Boolean)
  .join(', ') || 'New York';
```

**Why This Matters:**
Building strings from optional parts is a common pattern - filter(Boolean).join() is the idiomatic approach.

**Testing:**
- [ ] Test with both neighborhood and borough
- [ ] Test with only one present
- [ ] Test with neither present

~~~~~

## ðŸ”´ CHUNK 46: Apply same pattern to SearchPage.jsx:1979-1980

**File:** app/src/islands/pages/SearchPage.jsx
**Lines:** 1979-1980
**Violation:** MUTATING_METHOD - Same location parts pattern
**Severity:** ðŸ”´ High

**Affected Pages:** /search

**Current Code:**
```javascript
const locationParts = [];
if (neighborhoodName) locationParts.push(neighborhoodName);
if (boroughName) locationParts.push(boroughName);
```

**Refactored Code:**
```javascript
const locationParts = [neighborhoodName, boroughName].filter(Boolean);
```

**Why This Matters:**
Consistent pattern across the codebase.

**Testing:**
- [ ] Verify location display on search page

~~~~~

## ðŸ”´ CHUNK 47: Apply same pattern to FavoriteListingsPage.jsx:529-530

**File:** app/src/islands/pages/FavoriteListingsPage/FavoriteListingsPage.jsx
**Lines:** 529-530
**Violation:** MUTATING_METHOD - Same location parts pattern
**Severity:** ðŸ”´ High

**Affected Pages:** /favorite-listings

**Current Code:**
```javascript
const locationParts = [];
if (neighborhoodName) locationParts.push(neighborhoodName);
if (boroughName) locationParts.push(boroughName);
```

**Refactored Code:**
```javascript
const locationParts = [neighborhoodName, boroughName].filter(Boolean);
```

**Why This Matters:**
Consistent pattern.

**Testing:**
- [ ] Verify location display on favorites page

~~~~~

## ðŸ”´ CHUNK 48: Apply same pattern to formatters.js:115-117

**File:** app/src/islands/pages/FavoriteListingsPage/formatters.js
**Lines:** 115-117
**Violation:** MUTATING_METHOD - 3 conditional push calls
**Severity:** ðŸ”´ High

**Affected Pages:** /favorite-listings

**Current Code:**
```javascript
const parts = [];
if (borough) parts.push(borough);
if (hood) parts.push(hood);
if (city) parts.push(city);
return parts.join(', ');
```

**Refactored Code:**
```javascript
return [borough, hood, city].filter(Boolean).join(', ');
```

**Why This Matters:**
Formatter functions should be pure and concise.

**Testing:**
- [ ] Test location formatting with various inputs

~~~~~

## ðŸ”´ CHUNK 49: Refactor features building in formatters.js:66-81

**File:** app/src/islands/pages/FavoriteListingsPage/formatters.js
**Lines:** 66-81
**Violation:** MUTATING_METHOD - 4 conditional push calls
**Severity:** ðŸ”´ High

**Affected Pages:** /favorite-listings

**Current Code:**
```javascript
const parts = [];

if (bedrooms === 1) {
  parts.push('1 bedroom');
} else if (bedrooms > 1) {
  parts.push(`${bedrooms} bedrooms`);
}

if (bathroomDisplay) {
  parts.push(bathroomDisplay);
}

if (kitchenType) {
  parts.push(kitchenType);
}

return parts.join(' Â· ');
```

**Refactored Code:**
```javascript
const bedroomText = bedrooms === 1 ? '1 bedroom'
  : bedrooms > 1 ? `${bedrooms} bedrooms`
  : null;

return [bedroomText, bathroomDisplay, kitchenType]
  .filter(Boolean)
  .join(' Â· ');
```

**Why This Matters:**
Feature lists benefit from declarative construction.

**Testing:**
- [ ] Test with various bedroom counts
- [ ] Test with missing features

~~~~~

## ðŸ”´ CHUNK 50: Replace .sort() with toSorted() in multiple SearchPage locations

**File:** app/src/islands/pages/SearchPage.jsx
**Lines:** 89, 2318
**Violation:** MUTATING_METHOD - [...arr].sort() pattern
**Severity:** ðŸ”´ High

**Affected Pages:** /search

**Current Code:**
```javascript
const sortedDays = [...selectedDaysArray].sort((a, b) => a - b);
// ...
const sortedJsDays = [...daysInJsFormat].sort((a, b) => a - b);
```

**Refactored Code:**
```javascript
const sortedDays = selectedDaysArray.toSorted((a, b) => a - b);
// ...
const sortedJsDays = daysInJsFormat.toSorted((a, b) => a - b);
```

**Why This Matters:**
Search page is high-traffic - consistent immutable patterns are important.

**Testing:**
- [ ] Test day sorting on search page
- [ ] Verify schedule calculations work correctly

~~~~~

---

## Summary by File (Remaining Violations)

The above 50 chunks cover the highest-impact violations. Below is a summary of remaining violations for future refactoring sprints:

### Remaining Files with 3+ Violations:

| File | Remaining | Primary Pattern |
|------|-----------|-----------------|
| src/islands/shared/VirtualMeetingManager/dateUtils.js | 7 | Calendar generation loops |
| src/islands/pages/AccountProfilePage/useAccountProfilePageLogic.js | 7 | Action list building |
| src/islands/pages/HostProposalsPage/types.js | 6 | Day iteration loops |
| src/islands/shared/GoogleMap.jsx | 6 | Marker array building |
| src/islands/shared/ScheduleCohost/cohostService.js | 5 | Date/time slot generation |
| src/lib/supabaseUtils.js | 8 | Photo URL building |
| src/lib/photoUpload.js | 7 | Binary conversion loops |

### Recommended Next Steps:

1. **Execute Chunks 1-20 first** - These cover core scheduling logic used across the app
2. **Execute Chunks 16-17** - High-visibility components (navigation, listing form)
3. **Execute Chunks 21-36** - Component-specific patterns
4. **Execute Chunks 37-50** - Consistent validation patterns

### Browser Compatibility Note:

`toSorted()` and `toReversed()` require:
- Chrome 110+
- Firefox 115+
- Safari 16+
- Edge 110+

If supporting older browsers, use the existing `[...arr].sort()` pattern or add polyfills.

---

## File References

- agents/fp_audit_violations.json (source data)
- app/src/lib/availabilityValidation.js
- app/src/logic/rules/scheduling/isScheduleContiguous.js
- app/src/logic/calculators/scheduling/calculateCheckInOutDays.js
- app/src/islands/shared/LoggedInAvatar/LoggedInAvatar.jsx
- app/src/islands/pages/SelfListingPage/store/listingLocalStore.ts
- app/src/islands/pages/SelfListingPage/store/prepareListingSubmission.ts
- app/src/islands/pages/ListingDashboardPage/components/AvailabilitySection.jsx
- app/src/islands/pages/ListingDashboardPage/components/PricingEditSection.jsx
- app/src/islands/shared/SearchScheduleSelector.jsx
- app/src/islands/shared/HostScheduleSelector/utils.js
- app/src/islands/shared/HostScheduleSelector/HostScheduleSelector.jsx
- app/src/lib/scheduleSelector/dayHelpers.js
- app/src/lib/scheduleSelector/nightCalculations.js
- app/src/lib/scheduleSelector/validators.js
- app/src/lib/dataLookups.js
- app/src/logic/processors/listing/extractListingCoordinates.js
- app/src/logic/processors/user/processUserData.js
- app/src/logic/rules/proposals/proposalRules.js
