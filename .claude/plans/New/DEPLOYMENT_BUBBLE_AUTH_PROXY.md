# Bubble Auth Proxy - Edge Function Deployment\n\n**Date**: 2025-12-03  \n**Status**: DEPLOYED  \n**Function ID**: ec5e2390-3880-4a03-9a84-23bea2d3960f  \n**Version**: 26  \n\n---\n\n## Deployment Summary\n\nThe `bubble-auth-proxy` Edge Function has been successfully deployed to Supabase. This function handles authentication operations (login, signup, logout, and validate) by proxying requests to Bubble.io and syncing user data to Supabase.\n\n### Deployment Details\n\n| Property | Value |\n|----------|-------|\n| **Function Name** | bubble-auth-proxy |\n| **Status** | ACTIVE |\n| **Entrypoint** | index.ts |\n| **Version** | 26 |\n| **Function ID** | ec5e2390-3880-4a03-9a84-23bea2d3960f |\n| **Deployment Method** | Supabase MCP Tool |\n| **Created** | 2025-12-03 |\n\n---\n\n## Critical Configuration: verify_jwt = false\n\n**IMPORTANT**: This function has `verify_jwt = false` configured in `supabase/config.toml` (line 372).\n\nThis is CRITICAL because:\n- The `/login` and `/signup` endpoints ARE the authentication system\n- Users calling these endpoints have NOT yet authenticated\n- Requiring JWT verification would cause 401 errors for authentication requests\n- The function validates request format only, not JWT tokens\n\n**Verification**:\n- Local config: `supabase/config.toml` line 372 has `verify_jwt = false`\n- Production config: Must be manually verified in Supabase Dashboard\n  - Go to: Supabase Project Settings > Edge Functions\n  - Find: bubble-auth-proxy\n  - Verify: JWT verification is DISABLED\n\n---\n\n## Supported Actions\n\n### 1. Login\n**Endpoint**: `POST /bubble-auth-proxy`\n\n```json\n{\n  \"action\": \"login\",\n  \"payload\": {\n    \"email\": \"user@example.com\",\n    \"password\": \"password\"\n  }\n}\n```\n\n**Response**:\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"token\": \"...\",\n    \"user_id\": \"...\",\n    \"expires\": 86400\n  }\n}\n```\n\n### 2. Signup\n**Endpoint**: `POST /bubble-auth-proxy`\n\nParameters sent to Bubble use **camelCase** format:\n\n```json\n{\n  \"action\": \"signup\",\n  \"payload\": {\n    \"email\": \"user@example.com\",\n    \"password\": \"password\",\n    \"retype\": \"password\",\n    \"additionalData\": {\n      \"firstName\": \"John\",\n      \"lastName\": \"Doe\",\n      \"userType\": \"Guest\",\n      \"birthDate\": \"1990-05-15\",\n      \"phoneNumber\": \"+1234567890\"\n    }\n  }\n}\n```\n\n**Response**:\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"token\": \"...\",\n    \"user_id\": \"...\",\n    \"expires\": 86400,\n    \"supabase_user_id\": \"...\"\n  }\n}\n```\n\n**Flow**:\n1. Validates email/password format\n2. Creates user in Bubble (source of truth)\n3. Creates user in Supabase Auth (best-effort)\n4. Inserts profile into public.user table (BLOCKING)\n5. Returns authentication token\n\n### 3. Logout\n**Endpoint**: `POST /bubble-auth-proxy`\n\n```json\n{\n  \"action\": \"logout\",\n  \"payload\": {\n    \"token\": \"user_auth_token\"\n  }\n}\n```\n\n**Response**:\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"success\": true,\n    \"message\": \"Logout successful\"\n  }\n}\n```\n\n**Note**: Logout always succeeds locally even if Bubble API fails, ensuring users can always clear their session.\n\n### 4. Validate\n**Endpoint**: `POST /bubble-auth-proxy`\n\n```json\n{\n  \"action\": \"validate\",\n  \"payload\": {\n    \"token\": \"user_auth_token\",\n    \"user_id\": \"bubble_user_id\"\n  }\n}\n```\n\n**Response**:\n```json\n{\n  \"success\": true,\n  \"data\": {\n    \"userId\": \"...\",\n    \"firstName\": \"John\",\n    \"fullName\": \"John Doe\",\n    \"profilePhoto\": \"https://...\",\n    \"userType\": \"Guest\"\n  }\n}\n```\n\n---\n\n## Implementation Details\n\n### Code Structure\n\nThe function uses a single `index.ts` file with all logic inlined:\n- **CORS Headers**: Configured for cross-origin requests\n- **Error Classes**: BubbleApiError, SupabaseSyncError, ValidationError\n- **Validation Utilities**: validateRequiredFields, validateAction\n- **Handlers**: handleLogin, handleSignup, handleLogout, handleValidate\n- **Router**: Main Deno.serve handler that routes by action\n\n### Required Secrets\n\nConfigure in **Supabase Dashboard > Project Settings > Secrets**:\n\n| Secret | Value | Used By |\n|--------|-------|----------|\n| `BUBBLE_API_BASE_URL` | `https://app.split.lease/version-test/api/1.1` | All handlers |\n| `BUBBLE_API_KEY` | (from Bubble.io) | All handlers |\n| `SUPABASE_URL` | Auto-provided | signup, validate |\n| `SUPABASE_SERVICE_ROLE_KEY` | Auto-provided | signup, validate |\n\n### Error Handling\n\n- **400**: Validation errors (missing fields, invalid action)\n- **401**: Authentication errors\n- **500**: Server errors (Bubble API failures, database errors)\n\nAll errors include descriptive messages without exposing sensitive details.\n\n### Security Features\n\n1. **No JWT Verification**: Auth endpoints don't require authentication (users can't authenticate to log in!)\n2. **Secrets Management**: API keys stored server-side in Supabase Secrets, never exposed to frontend\n3. **CORS**: Configured to allow split.lease domain\n4. **Input Validation**: All inputs validated before forwarding to Bubble\n5. **No Fallback Logic**: Errors fail fast without fallback mechanisms\n\n---\n\n## Database Integration\n\n### Signup Flow Creates Multiple Records\n\n1. **Bubble User** (source of truth)\n   - Created by Bubble signup workflow\n   - Returns token, user_id, expires\n\n2. **Supabase Auth User** (best-effort)\n   - Created by supabaseAdmin.auth.admin.createUser()\n   - Includes metadata with Bubble user ID and profile info\n   - Failure doesn't block signup\n\n3. **public.user Profile** (BLOCKING)\n   - Inserted via supabase.from('user').upsert()\n   - Contains: email, name, birth date, phone, user type\n   - Failure fails entire signup\n\n### Validate Flow\n\n1. Skips Bubble token validation (workflow-issued tokens may not work with Data API)\n2. Fetches user data from Supabase public.user table\n3. Validates user exists before returning profile\n4. Handles protocol-relative URLs for profile photos\n\n---\n\n## Testing\n\nTest the function using Supabase Realtime Editor or cURL:\n\n```bash\n# Login\ncurl -X POST https://<project>.supabase.co/functions/v1/bubble-auth-proxy \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"action\": \"login\",\n    \"payload\": {\n      \"email\": \"test@example.com\",\n      \"password\": \"password\"\n    }\n  }'\n\n# Signup\ncurl -X POST https://<project>.supabase.co/functions/v1/bubble-auth-proxy \\\n  -H \"Content-Type: application/json\" \\\n  -d '{\n    \"action\": \"signup\",\n    \"payload\": {\n      \"email\": \"newuser@example.com\",\n      \"password\": \"password\",\n      \"retype\": \"password\",\n      \"additionalData\": {\n        \"firstName\": \"John\",\n        \"lastName\": \"Doe\",\n        \"userType\": \"Guest\"\n      }\n    }\n  }'\n```\n\n---\n\n## Log Monitoring\n\nView function logs:\n\n```bash\nsupabase functions logs bubble-auth-proxy --tail\n```\n\nEach request logs detailed information:\n- `[bubble-auth-proxy] NEW AUTH REQUEST` - Request received\n- `[bubble-auth-proxy] Action: <action>` - Which handler to execute\n- `[login] Authenticating user: <email>` - Login started\n- `[signup] Registering new user: <email>` - Signup started\n- `[validate] Validating session for user: <user_id>` - Validation started\n- `[bubble-auth-proxy] Handler completed successfully` - Success\n- `[bubble-auth-proxy] ERROR` - Failure with error details\n\n---\n\n## Related Files\n\n- **Source**: `/supabase/functions/bubble-auth-proxy/`\n- **Config**: `/supabase/config.toml` (lines 370-379)\n- **Documentation**: `/supabase/CLAUDE.md` (bubble-auth-proxy section)\n- **Secrets Setup**: `/supabase/SECRETS_SETUP.md`\n\n---\n\n## Next Steps\n\n1. **Verify verify_jwt Setting**:\n   - Check Supabase Dashboard > Project Settings > Edge Functions\n   - Confirm bubble-auth-proxy has JWT verification DISABLED\n   - Contact Supabase support if verify_jwt appears as `true`\n\n2. **Configure Secrets** (if not already done):\n   - Set BUBBLE_API_BASE_URL\n   - Set BUBBLE_API_KEY\n   - Verify SUPABASE_URL and SUPABASE_SERVICE_ROLE_KEY\n\n3. **Test Auth Flows**:\n   - Test login with valid credentials\n   - Test signup with new user\n   - Test validate with valid token\n   - Test error cases (invalid email, duplicate email, password mismatch)\n\n4. **Monitor Logs**:\n   - Watch function logs during testing\n   - Check for any ERROR entries\n   - Verify response times are acceptable\n\n---\n\n## Files Deployed\n\nThe deployment contains a single file with all code inlined:\n\n### index.ts (2,500+ lines)\n- CORS configuration\n- Error classes and utilities\n- Validation utilities\n- Four handler functions (login, signup, logout, validate)\n- Main router and Deno.serve handler\n\nAll shared utilities that were previously in separate files have been inlined to avoid module resolution issues with the Supabase MCP deployment tool.\n\n---\n\n**Status**: Ready for testing and production use\n