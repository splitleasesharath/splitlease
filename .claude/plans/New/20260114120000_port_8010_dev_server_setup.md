# Port 8010 Dev Server Setup Plan

**Date:** 2026-01-14
**Objective:** Create simple `bun run dev:test` commands for deterministic port 8010 control

---

## Overview

Add dedicated npm scripts to start/stop a dev server on **port 8010** for testing and automation.
This eliminates dynamic port detection and permission prompt issues.

---

## Changes Required

### 1. Create `app/scripts/kill-port.js`

**Purpose:** Cross-platform script to kill process on any port

**File:** `app/scripts/kill-port.js`

```javascript
#!/usr/bin/env node
/**
 * Kill process on specified port - Cross-platform
 * Usage: node scripts/kill-port.js <port>
 */

import { execSync } from 'child_process';
import { platform } from 'os';

const port = process.argv[2];

if (!port) {
  console.error('Usage: node scripts/kill-port.js <port>');
  process.exit(1);
}

console.log(`ðŸ”§ Killing process on port ${port}...`);

try {
  if (platform() === 'win32') {
    // Windows: Use netstat + taskkill
    try {
      const netstatOutput = execSync(`netstat -ano | findstr :${port}`, { encoding: 'utf-8' });
      const lines = netstatOutput.split('\n');

      const pids = new Set();
      for (const line of lines) {
        if (line.includes('LISTENING')) {
          const parts = line.trim().split(/\s+/);
          const pid = parts[parts.length - 1];
          if (pid && !isNaN(pid)) {
            pids.add(pid);
          }
        }
      }

      if (pids.size === 0) {
        console.log(`âœ“ No process found on port ${port}`);
        process.exit(0);
      }

      for (const pid of pids) {
        console.log(`  Killing PID ${pid}...`);
        execSync(`taskkill /F /PID ${pid}`, { stdio: 'ignore' });
      }

      console.log(`âœ“ Killed ${pids.size} process(es) on port ${port}`);
    } catch (e) {
      console.log(`âœ“ Port ${port} is free`);
    }
  } else {
    // Unix/Mac: Use lsof
    try {
      const lsofOutput = execSync(`lsof -ti :${port}`, { encoding: 'utf-8' });
      const pids = lsofOutput.trim().split('\n').filter(Boolean);

      if (pids.length === 0) {
        console.log(`âœ“ No process found on port ${port}`);
        process.exit(0);
      }

      for (const pid of pids) {
        console.log(`  Killing PID ${pid}...`);
        execSync(`kill -9 ${pid}`, { stdio: 'ignore' });
      }

      console.log(`âœ“ Killed ${pids.length} process(es) on port ${port}`);
    } catch (e) {
      console.log(`âœ“ Port ${port} is free`);
    }
  }

  process.exit(0);
} catch (error) {
  console.error(`âœ— Error killing process on port ${port}:`, error.message);
  process.exit(1);
}
```

---

### 2. Update `app/package.json`

**Add these scripts:**

```json
{
  "scripts": {
    "dev": "vite --port 8000",
    "dev:test": "vite --port 8010 --strictPort",
    "dev:test:stop": "node scripts/kill-port.js 8010",
    "dev:test:restart": "bun run dev:test:stop && bun run dev:test",
    "generate-routes": "node scripts/generate-redirects.js",
    // ... rest of scripts
  }
}
```

**Key Scripts:**
- **`dev:test`** - Start Vite on port 8010 with strict port enforcement
- **`dev:test:stop`** - Kill any process on port 8010
- **`dev:test:restart`** - Stop then start (clean restart)

---

## Usage Examples

### Start Test Server
```bash
cd app
bun run dev:test
```

Output:
```
ðŸš€ VITE ready
âžœ  Local:   http://localhost:8010/
```

### Stop Test Server
```bash
cd app
bun run dev:test:stop
```

Output:
```
ðŸ”§ Killing process on port 8010...
  Killing PID 12345...
âœ“ Killed 1 process(es) on port 8010
```

### Restart Test Server (Clean)
```bash
cd app
bun run dev:test:restart
```

Output:
```
ðŸ”§ Killing process on port 8010...
âœ“ Port 8010 is free
ðŸš€ VITE ready
âžœ  Local:   http://localhost:8010/
```

---

## Integration with ADW

### Update `adw_modules/config.py`

**Change:**
```python
DEV_SERVER_DEFAULT_PORT = 8010  # Was 8000
DEV_SERVER_COMMAND = ["bun", "run", "dev:test"]  # Uses port 8010
```

### Update Orchestrator

**In `adw_fp_audit_browser_implement_orchestrator.py`:**

```python
# Line 876 - Use app directory + new command
app_dir = working_dir / "app"
dev_server = DevServerManager(app_dir, dev_logger)

# DevServerManager will now use config.DEV_SERVER_COMMAND
# which points to "bun run dev:test" (port 8010)
```

### Update Claude Browser

**In `adw_claude_browser.py`:**

```python
# Line 164 - Use port 8010
port = 8010  # Hardcoded to match dev:test

# Line 175 - Simplified startup check
if is_port_in_use(port):
    print(f"âœ… Dev server already running at http://localhost:{port}")
    dev_server_process = None  # Using existing
else:
    # Start via bun run dev:test (handles port cleanup internally)
    dev_server_process = subprocess.Popen(
        ["bun", "run", "dev:test"],
        cwd=working_dir / "app",
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT
    )
```

---

## Benefits

âœ… **Deterministic Port** - Always 8010, no dynamic detection  
âœ… **Cross-Platform** - Works on Windows, Mac, Linux  
âœ… **Simple Commands** - `bun run dev:test`, `bun run dev:test:stop`  
âœ… **No Permission Prompts** - Server stays on same port  
âœ… **Clean Restarts** - `dev:test:restart` guarantees clean state  
âœ… **Automation-Friendly** - Perfect for orchestrator workflows  

---

## Testing Checklist

- [ ] Create `app/scripts/kill-port.js`
- [ ] Update `app/package.json` with new scripts
- [ ] Test `bun run dev:test` starts server on 8010
- [ ] Test `bun run dev:test:stop` kills server
- [ ] Test `bun run dev:test:restart` does clean restart
- [ ] Update `adw_modules/config.py` to use port 8010
- [ ] Test orchestrator with new port
- [ ] Test Claude browser with port 8010
- [ ] Verify no permission prompts during automation

---

## Rollback Plan

If issues occur:

1. Revert `package.json` changes
2. Delete `kill-port.js`
3. Revert `config.py` to port 8000
4. Use original dynamic port detection

---

## Next Steps

After implementing:

1. **Test manually** with `bun run dev:test`
2. **Update orchestrator** to use port 8010
3. **Remove dynamic port detection** from DevServerManager
4. **Simplify Claude browser** to assume port 8010

---

**Ready to implement!**
